<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BedsideBistro - Item</title>
  <link rel="stylesheet" href="global.css" />
  <style>
    :root{
      --bg:#f7faf9; --surface:#fff; --text:#1b1f1e; --muted:#58756a;
      --brand:#2f7d66; --brand-050:#eaf2ef; --outline:#d8e4de;
      --shadow:0 6px 18px rgba(0,0,0,.08); --radius:18px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}

    /* Header */
    .site-header__bar{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:10px 0}
    .site-brand{display:inline-flex;gap:8px;align-items:center;color:inherit;text-decoration:none}
    .site-brand__img{height:28px}
    .site-cart,.site-profile{display:inline-flex;align-items:center;gap:6px;color:inherit;text-decoration:none;position:relative}
    .site-cart__badge{
      position:absolute;top:-6px;right:-10px;min-width:18px;height:18px;border-radius:9px;
      background:var(--brand); color:#fff;font-size:12px;display:inline-flex;align-items:center;justify-content:center;padding:0 4px
    }

    /* Breadcrumbs */
    .crumbs{display:flex;gap:.35rem;align-items:center;color:#6b7671;font-size:.95rem;margin:.3rem 0 1rem}
    .crumbs .sep{opacity:.6}

    /* Main layout */
    .layout{display:grid;grid-template-columns:1.05fr 1fr;gap:22px}
    @media(max-width:1020px){.layout{grid-template-columns:1fr}}

    .panel{background:var(--surface);border:1px solid var(--outline);border-radius:var(--radius);box-shadow:var(--shadow)}
    .pad{padding:16px}
    .titlebar{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .badge{background:var(--brand);color:#fff;border-radius:10px;padding:.2rem .5rem;height:fit-content}
    .subtle{color:var(--muted)}

    .kv{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{display:inline-block;background:var(--brand-050);border:1px solid var(--outline);border-radius:999px;padding:.2rem .5rem;margin:0 .25rem .25rem 0}

    /* Sections and toggles */
    .group{margin-bottom:14px}
    .opt-list{display:grid;gap:10px}
    .line{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .toggle-ing{
      border:1px solid var(--outline);background:#fff;padding:.45rem .7rem;border-radius:999px;
      font:600 14px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial;cursor:pointer;
      transition:transform .03s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .toggle-ing:is(:hover,:focus){transform:translateY(-1px);outline:none}
    .toggle-ing[aria-pressed="false"]{background:#f7faf9}
    .toggle-ing[aria-pressed="true"]{border-color:#b83b3b;color:#b83b3b;box-shadow:0 0 0 2px rgba(184,59,59,.12) inset}

    .qty{display:inline-grid;grid-auto-flow:column;gap:6px;align-items:center}
    .qty button{border:1px solid var(--outline);background:#fff;border-radius:8px;padding:.3rem .55rem;font-weight:700}
    .qty input{width:64px;text-align:center}
    .textarea{width:100%;min-height:84px}

    .cta{display:inline-flex;justify-content:center;align-items:center;padding:.7rem 1rem;background:var(--brand);color:#fff;border-radius:12px;text-decoration:none}
    .cta:focus,.cta:hover{filter:brightness(.95)}

    .alert-inline{background:#ffe8e8;color:#8b0000;border:1px solid #f3c2c2;padding:.6rem .8rem;border-radius:.6rem;margin:.8rem 0}

    /* Debug menu */
    .debug-fab{position:fixed;right:16px;bottom:16px;width:48px;height:48px;border-radius:50%;background:#111;color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,.25);z-index:9998}
    .debug-panel{position:fixed;right:16px;bottom:76px;width:360px;background:#111;color:#eee;border:1px solid #2a2a2a;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.35);overflow:hidden;transform:translateY(16px);opacity:0;pointer-events:none;transition:transform .15s ease,opacity .15s ease;z-index:9999}
    .debug-panel.show{transform:translateY(0);opacity:1;pointer-events:auto}
    .debug-hd{padding:10px 12px;border-bottom:1px solid #272727;display:flex;align-items:center;justify-content:space-between}
    .debug-ttl{font-weight:700}
    .debug-body{max-height:60vh;overflow:auto}
    .debug-sec{padding:10px 12px;border-bottom:1px dashed #2b2b2b}
    .debug-sec:last-child{border-bottom:none}
    .debug-sec h5{margin:0 0 6px;font-size:13px;color:#a8f0cf}
    .debug-sec label{display:flex;gap:8px;align-items:center;margin:6px 0;font-size:13px}
    .debug-sec input[type="text"],.debug-sec textarea{width:100%;background:#191919;color:#eee;border:1px solid #333;border-radius:8px;padding:8px;box-sizing:border-box}
    .debug-sec button{background:#2f7d66;color:#fff;border:0;padding:7px 10px;border-radius:8px;cursor:pointer}
    .debug-console{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0d0d0d;color:#c7c7c7;border-radius:8px;padding:8px;border:1px solid #262626;white-space:pre-wrap}
    .debug-row{display:flex;gap:8px;margin-top:6px}
    .debug-row button{flex:1}
    .debug-small{color:#a1a1a1;font-size:12px}
  </style>
</head>
<body class="itemcustomization">
  <a href="#content" class="sr-only">Skip to content</a>

  <header class="site-header">
    <div class="container site-header__bar" role="navigation" aria-label="Top">
      <a class="site-brand" href="index.html">
        <img src="BedsideBistro_Small.svg" alt="BedsideBistro" class="site-brand__img" />
        <span class="site-brand__text">BedsideBistro</span>
      </a>

      <label class="site-search" aria-label="Search menu" style="display:flex;align-items:center;gap:8px">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input id="searchBox" type="search" name="q" placeholder="Search meals, ingredients, allergens…" />
      </label>

      <a class="site-cart" id="cartLink" href="ordersummary.html" aria-label="Open cart" data-count="0">
        <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
          <path fill="currentColor" d="M7 18a2 2 0 1 0 2 2 2 2 0 0 0-2-2zm10 0a2 2 0 1 0 2 2 2 2 0 0 0-2-2zM7.16 6l.84 2h9.42a1 1 0 0 1 .96 1.28l-1.6 5.6A2 2 0 0 1 14.86 16H9.14a2 2 0 0 1-1.92-1.12L5.1 6.76A1 1 0 0 0 4.16 6H3V4h2.34a2 2 0 0 1 1.82 1.2z"/>
        </svg>
        <span class="sr-only">Cart</span>
        <span class="site-cart__badge" aria-hidden="true">0</span>
      </a>

      <a class="site-profile" id="profileLink" href="userprofile.html" aria-label="Open profile menu">
        <div class="site-avatar" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="22" height="22">
            <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5.006 5.006 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"/>
          </svg>
        </div>
        <span class="sr-only">Profile</span>
      </a>
    </div>
  </header>

  <main id="content" class="container" style="margin-top:10px">
    <div id="itemError" class="alert-inline" role="alert" hidden></div>

    <nav class="crumbs" aria-label="Breadcrumb">
      <a href="patientview.html">Menu</a> <span class="sep">›</span>
      <a id="crumbCategoryLink" href="#">Category</a> <span class="sep">›</span>
      <span id="crumbItem" aria-current="page">Loading…</span>
    </nav>

    <div class="layout">
      <!-- Left preview -->
      <section class="panel" aria-label="Item preview and summary">
        <div class="media" aria-hidden="true">
          <img id="itemImage" src="" alt="" style="background:#eee;object-fit:cover;width:100%;max-height:450px;border-radius:12px">
        </div>
        <div class="pad">
          <div class="titlebar">
            <div>
              <h1 id="itemName" style="margin:0 0 4px;font-size:1.35rem">Loading…</h1>
              <div class="subtle" id="itemDesc"></div>
            </div>
            <span class="badge" id="lowSodiumBadge" hidden>Low Sodium</span>
          </div>
          <div class="kv" id="itemQuickFacts"></div>
          <div class="kv" id="itemAllergenTags"></div>
        </div>
      </section>

      <!-- Right config  only the three core sections -->
      <aside class="panel" aria-label="Configure your order">
        <div class="pad form-section">

          <div class="group" id="modsGroup" role="group" aria-labelledby="mods">
            <h4 id="mods">Modify ingredients</h4>
            <div class="opt-list" id="modsList"></div>
          </div>

          <div class="group" id="qtyGroup" role="group" aria-labelledby="qty">
            <h4 id="qty">Quantity</h4>
            <div class="line">
              <span class="subtle">Number of servings</span>
              <div class="qty">
                <button type="button" id="qtyDec" aria-label="Decrease quantity">-</button>
                <input id="qtyInput" type="number" value="1" min="1" aria-label="Quantity">
                <button type="button" id="qtyInc" aria-label="Increase quantity">+</button>
              </div>
            </div>
          </div>

          <div class="group" id="notesGroup" role="group" aria-labelledby="notes">
            <h4 id="notes">Notes</h4>
            <textarea id="notesArea" class="textarea" placeholder="Any special instructions? e.g., cut chicken smaller, extra lemon wedge."></textarea>
          </div>

          <a id="addToOrderLink" class="cta" href="#" role="button" aria-label="Add to order">Add to Order</a>
        </div>
      </aside>
    </div>
  </main>

  <!-- Debug menu -->
  <button class="debug-fab" id="debugFab" title="Debug">≡</button>
  <section class="debug-panel" id="debugPanel" aria-live="polite" aria-label="Debug tools">
    <div class="debug-hd">
      <div class="debug-ttl">Debug Menu</div>
      <button id="debugClose" style="background:#2a2a2a;color:#eee;border:0;border-radius:8px;padding:6px 10px;cursor:pointer">Close</button>
    </div>
    <div class="debug-body">
      <div class="debug-sec">
        <h5>Runtime</h5>
        <div class="debug-small" id="dbgRuntime"></div>
      </div>

      <div class="debug-sec">
        <h5>API Base and Item</h5>
        <label>API Base</label><input type="text" id="dbgBase" />
        <div style="height:6px"></div>
        <label>Item ID</label><input type="text" id="dbgItemId" />
        <div class="debug-row">
          <button id="dbgReloadItem">Reload Item</button>
          <button id="dbgOpenItemJson">Open JSON</button>
        </div>
      </div>

      <div class="debug-sec">
        <h5>Ingredient Controls</h5>
        <label><input type="checkbox" id="dbgSimulateNoIngredients"> Simulate no ingredientIds</label>
        <label><input type="checkbox" id="dbgMockIngredients"> Use mock ingredients if API fails</label>
        <div class="debug-row">
          <button id="dbgRenderEmpty">Render as no removable</button>
          <button id="dbgFlipAll">Toggle all to No</button>
        </div>
      </div>

      <div class="debug-sec">
        <h5>Navigation</h5>
        <div class="debug-row">
          <button id="dbgAddToOrder">Add to Order now</button>
          <button id="dbgCarryMrn">Reapply MRN to links</button>
        </div>
      </div>

      <div class="debug-sec">
        <h5>Console</h5>
        <div class="debug-console" id="dbgConsole" style="min-height:120px">[ready]</div>
        <div class="debug-row" style="margin-top:8px">
          <button id="dbgClearLog">Clear log</button>
          <button id="dbgCopyLog">Copy log</button>
        </div>
      </div>
    </div>
  </section>

<script>
(function(){
// Force-remove legacy sections if they exist in any stale HTML
document.getElementById('extrasGroup')?.remove();
document.getElementById('dressingGroup')?.remove();

  // Logger for the debug panel
  const $console = () => document.getElementById('dbgConsole');
  function log(){ try{
    const el = $console(); if (!el) return;
    const msg = Array.from(arguments).map(a => { try{return typeof a==='string'?a:JSON.stringify(a,null,2);}catch{return String(a);} }).join(' ');
    el.textContent += '\\n' + msg; el.scrollTop = el.scrollHeight;
    console.log('[itemcustomization]', ...arguments);
  }catch{} }
  function clearLog(){ const el = $console(); if (el) el.textContent = '[cleared]'; }

  // Config
  const USING_FILE = location.protocol === 'file:';
  let BASE = USING_FILE ? 'https://bedsidebistroapi.winhost.com' : '';
  const params = new URLSearchParams(location.search);
  const MRN = params.get('mrn') || '';
  let ITEM_ID = params.get('id');

  function withParams(href, extra = {}) {
    const url = new URL(href, location.origin);
    Object.entries(extra).forEach(([k,v]) => { if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v); });
    return url.toString();
  }

  // Header links carry MRN
  const cartA = document.getElementById('cartLink');
  if (cartA) cartA.href = withParams('ordersummary.html', { mrn: MRN });
  const profA = document.getElementById('profileLink');
  if (profA) profA.href = withParams('userprofile.html', { mrn: MRN });

  // DOM refs
  const errBox = document.getElementById('itemError');
  const itemImage = document.getElementById('itemImage');
  const itemNameEl = document.getElementById('itemName');
  const itemDescEl = document.getElementById('itemDesc');
  const lowSodiumBadgeEl = document.getElementById('lowSodiumBadge');
  const quickFactsEl = document.getElementById('itemQuickFacts');
  const modsListEl = document.getElementById('modsList');
  const qtyInput = document.getElementById('qtyInput');
  const qtyDec = document.getElementById('qtyDec');
  const qtyInc = document.getElementById('qtyInc');
  const notesArea = document.getElementById('notesArea');
  let addA = document.getElementById('addToOrderLink');

  // Errors
  function showError(msg){ if (!errBox) return; errBox.hidden = false; errBox.textContent = msg; }
  function clearError(){ if (!errBox) return; errBox.hidden = true; errBox.textContent = ''; }

  // API
  async function getMenuItem(id){
    const url = `${BASE}/api/menu/${encodeURIComponent(id)}`;
    log('GET', url);
    const r = await fetch(url,{headers:{Accept:'application/json'}});
    if (!r.ok) throw new Error('Failed to load item ' + r.status);
    return r.json();
  }
  async function getIngredients(){
    const url = `${BASE}/api/ingredients`;
    log('GET', url);
    const r = await fetch(url,{headers:{Accept:'application/json'}});
    if (!r.ok) throw new Error('Failed to load ingredients ' + r.status);
    return r.json();
  }

  // Renderers
  function renderTop(item){
    const name = item.name ?? item.Name ?? '(unnamed)';
    const desc = item.description ?? item.Description ?? '';
    const calories = pick(item,['calories','Calories','decCalories']);
    const protein  = pick(item,['proteinG','ProteinG','decProteinG']);
    const sodium   = pick(item,['sodiumMg','SodiumMg','decSodiumMG']);
    const carbs    = pick(item,['carbsG','CarbsG','decCarbsG']);
    const fat      = pick(item,['fatG','FatG','decFatG']);
    const imagePath= item.imagePath ?? item.ImagePath ?? '/food-images/default.jpg';
    const isLow    = !!(item.lowSodium ?? item.LowSodium ?? item.bitLowSodium);

    document.title = 'BedsideBistro - ' + name;
    itemNameEl.textContent = name;
    itemDescEl.textContent = desc || '';
    itemImage.src = absoluteImage(imagePath);
    itemImage.alt = name;
    lowSodiumBadgeEl.hidden = !isLow;

    const pills = [];
    if (has(calories)) pills.push(`${calories} kcal`);
    if (has(protein))  pills.push(`${protein}g protein`);
    if (has(sodium))   pills.push(`${sodium}mg sodium`);
    if (has(carbs))    pills.push(`${carbs}g carbs`);
    if (has(fat))      pills.push(`${fat}g fat`);
    quickFactsEl.innerHTML = pills.map(p => `<span class="pill">${escapeHtml(String(p))}</span>`).join(' ');
  }

  function renderIngredientToggles(names){
    if (!names || names.length === 0){
      modsListEl.innerHTML = `<div class="subtle">No removable ingredients.</div>`;
      return;
    }
    modsListEl.innerHTML = names.map(n => {
      const label = escapeHtml(n);
      return `<div class="line"><span>${label}</span>
        <button type="button" class="toggle-ing" data-ing="${label}" aria-pressed="false">Keep</button></div>`;
    }).join('');
    modsListEl.querySelectorAll('.toggle-ing').forEach(btn => {
      const ingName = btn.dataset.ing || '';
      const refresh = () => { const off = btn.getAttribute('aria-pressed') === 'true'; btn.textContent = off ? `No ${ingName}` : 'Keep'; };
      refresh();
      btn.addEventListener('click', () => {
        const curr = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', String(!curr));
        refresh();
      });
    });
  }

  // Utils
  function pick(o, keys){ for (const k of keys) if (o && o[k] !== undefined && o[k] !== null) return o[k]; }
  function has(v){ return v !== undefined && v !== null && String(v) !== ''; }
  function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function absoluteImage(p){ if (!p) return `${BASE}/food-images/default.jpg`; if (p.startsWith('http')) return p; return BASE + (p.startsWith('/') ? p : '/' + p); }
  function clampQty(){ const v = Math.max(1, Number(qtyInput.value || 1)); qtyInput.value = String(v); }
  function unwrapList(x){ if (Array.isArray(x)) return x; if (x?.items && Array.isArray(x.items)) return x.items; if (x?.data && Array.isArray(x.data)) return x.data; if (x?.rows && Array.isArray(x.rows)) return x.rows; return []; }
  function normIngredientRow(row){
    const id = pick(row,['Id','ID','id','IngredientID','ingredientID','ingredientId','intIngredientID','intIngredientId','intId','intID']);
    const name = pick(row,['Name','name','Ingredient','ingredient','strIngredient','strName','IngredientName','ingredientName']);
    if (id !== undefined && name !== undefined) return { id:Number(id), name:String(name) };
    return null;
  }

  // Cart
  function cartKey(mrn){ return `bb.cart.${mrn || 'nomrn'}`; }
  function readCart(mrn){ try{ return JSON.parse(sessionStorage.getItem(cartKey(mrn)) || '[]'); }catch{ return []; } }
  function writeCart(mrn, items){ sessionStorage.setItem(cartKey(mrn), JSON.stringify(items || [])); }
  function addToCart(mrn, item){ const cart = readCart(mrn); cart.push(item); writeCart(mrn, cart); return cart.length; }
  function setCartBadge(count){ const badge = document.querySelector('.site-cart__badge'); if (badge) badge.textContent = String(count); }
  function collectRemovedIngredientNotes(){
    const removed = Array.from(document.querySelectorAll('#modsList .toggle-ing[aria-pressed="true"]'))
      .map(btn => btn.dataset.ing).filter(Boolean);
    return removed.map(n => `No ${n}`).join(', ');
  }

  // Flow
  if (!ITEM_ID){ showError('Missing item id.'); }

  qtyDec.addEventListener('click', () => { qtyInput.stepDown(); clampQty(); });
  qtyInc.addEventListener('click', () => { qtyInput.stepUp(); clampQty(); });

  async function loadItemAndIngredients(){
    try{
      clearError();
      const item = await getMenuItem(ITEM_ID);
      log('Item loaded:', item);
      renderTop(item);

      const simulateNone = document.getElementById('dbgSimulateNoIngredients')?.checked;
      let ids = simulateNone ? [] : (Array.isArray(item.ingredientIds) ? item.ingredientIds.map(Number) : []);

      if (ids.length === 0){
        renderIngredientToggles([]);
      } else {
        let ingPayload = await getIngredients();
        let allIngs = unwrapList(ingPayload);
        if ((!Array.isArray(allIngs) || allIngs.length === 0) && document.getElementById('dbgMockIngredients')?.checked){
          allIngs = [{Id:101,Name:'Tomato'},{Id:102,Name:'Lettuce'},{Id:103,Name:'Onion'},{Id:104,Name:'Pickle'},{Id:105,Name:'Cheddar'}];
        }
        const normalized = Array.isArray(allIngs) ? allIngs.map(normIngredientRow).filter(Boolean) : [];
        const nameById = new Map(normalized.map(r => [Number(r.id), r.name]));
        const names = Array.from(new Set(ids)).map(id => nameById.get(Number(id))).filter(n => typeof n === 'string' && n.trim());
        renderIngredientToggles(names);
      }

      wireAddToOrder(item);
      setCartBadge(readCart(MRN).length);

    }catch(err){
      console.warn(err);
      showError('Unable to load item. Please try again.');
    }
  }

  function wireAddToOrder(item){
    if (!addA) return;
    const clone = addA.cloneNode(true);
    addA.parentNode.replaceChild(clone, addA);
    addA = clone;

    addA.addEventListener('click', (e) => {
      e.preventDefault();
      if (addA.dataset.busy === '1') return;
      addA.dataset.busy = '1';

      clampQty();
      const qty = Math.max(1, Number(qtyInput?.value || 1));
      const typed = (notesArea?.value || '').trim();
      const autoNotes = collectRemovedIngredientNotes();
      const combinedNotes = [typed, autoNotes].filter(Boolean).join(typed && autoNotes ? '; ' : '');

      const name = item.name ?? item.Name ?? '(unnamed)';
      const image = itemImage?.getAttribute('src') || '';
      const cartItem = { id:Number(ITEM_ID), name, qty, notes:combinedNotes, image };

      const newCount = addToCart(MRN, cartItem);
      setCartBadge(newCount);

      addA.textContent = 'Added!';
      setTimeout(() => {
        const next = new URL('http://www.bedsidebistro.com/patientview.html');
        if (MRN) next.searchParams.set('mrn', MRN);
        location.href = next.toString();
      }, 250);
    });
  }

  // Debug menu
  const dbg = {
    panel: document.getElementById('debugPanel'),
    fab: document.getElementById('debugFab'),
    close: document.getElementById('debugClose'),
    base: document.getElementById('dbgBase'),
    itemId: document.getElementById('dbgItemId'),
    reloadBtn: document.getElementById('dbgReloadItem'),
    openJsonBtn: document.getElementById('dbgOpenItemJson'),
    simulateNoIngredients: document.getElementById('dbgSimulateNoIngredients'),
    mockIngredients: document.getElementById('dbgMockIngredients'),
    renderEmpty: document.getElementById('dbgRenderEmpty'),
    flipAll: document.getElementById('dbgFlipAll'),
    addNow: document.getElementById('dbgAddToOrder'),
    carryMrn: document.getElementById('dbgCarryMrn'),
    runtime: document.getElementById('dbgRuntime'),
    clearLog: document.getElementById('dbgClearLog'),
    copyLog: document.getElementById('dbgCopyLog')
  };
  function toggleDebug(){ dbg.panel.classList.toggle('show'); }
  dbg.fab.addEventListener('click', toggleDebug);
  dbg.close.addEventListener('click', toggleDebug);
  let lastKeyTime = 0;
  addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'd'){ const t = performance.now(); if (t - lastKeyTime < 300) toggleDebug(); lastKeyTime = t; } });

  dbg.base.value = BASE;
  dbg.itemId.value = ITEM_ID || '';
  dbg.runtime.textContent = ['Protocol: ' + location.protocol,'File mode: ' + String(USING_FILE),'MRN: ' + (MRN || '(none)'),'Time: ' + new Date().toLocaleString()].join('\\n');
  dbg.base.addEventListener('change', () => { BASE = dbg.base.value.trim(); log('BASE changed', BASE); });
  dbg.itemId.addEventListener('change', () => { ITEM_ID = dbg.itemId.value.trim(); log('ITEM_ID changed', ITEM_ID); });
  dbg.reloadBtn.addEventListener('click', () => { if (!ITEM_ID){ alert('Set an Item ID first'); return; } loadItemAndIngredients(); });
  dbg.openJsonBtn.addEventListener('click', () => { if (!ITEM_ID){ alert('Set an Item ID first'); return; } window.open(`${BASE}/api/menu/${encodeURIComponent(ITEM_ID)}`,'_blank'); });
  dbg.renderEmpty.addEventListener('click', () => { renderIngredientToggles([]); });
  dbg.flipAll.addEventListener('click', () => {
    document.querySelectorAll('.toggle-ing').forEach(btn => {
      const curr = btn.getAttribute('aria-pressed') === 'true';
      btn.setAttribute('aria-pressed', String(!curr));
      const ing = btn.dataset.ing || '';
      btn.textContent = (!curr) ? `No ${ing}` : 'Keep';
    });
  });
  dbg.addNow.addEventListener('click', () => { document.getElementById('addToOrderLink').dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true})); });
  dbg.carryMrn.addEventListener('click', () => {
    if (cartA) cartA.href = withParams('ordersummary.html', { mrn: MRN });
    if (profA) profA.href = withParams('userprofile.html', { mrn: MRN });
  });
  document.getElementById('dbgClearLog').addEventListener('click', clearLog);
  document.getElementById('dbgCopyLog').addEventListener('click', async () => {
    try{ await navigator.clipboard.writeText($console()?.textContent || ''); }catch{ alert('Copy failed'); }
  });

  // Start
  if (!ITEM_ID){ showError('Missing item id.'); } else { loadItemAndIngredients(); }
  setCartBadge(readCart(MRN).length);
})();
</script>
</body>
</html>
