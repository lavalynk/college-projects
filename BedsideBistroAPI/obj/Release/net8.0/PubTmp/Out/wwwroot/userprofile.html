<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BedsideBistro - Profile & Dietary Limits</title>
<link rel="stylesheet" href="global.css" />

</head>

<body class="patientdashboard">
<header class="site-header">
  <div class="container site-header__bar" role="navigation" aria-label="Top">
    <a class="site-brand" href="patientview.html">
      <img src="BedsideBistro_Small.svg" alt="BedsideBistro" class="site-brand__img" />
      <span class="site-brand__text">BedsideBistro</span>
    </a>

    <!-- Right side group -->
    <div class="site-header__right">
      <a class="site-cart" id="cartLink" href="ordersummary.html" aria-label="Open cart" data-count="0">
        <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
          <path fill="currentColor" d="M7 18a2 2 0 1 0 2 2 2 2 0 0 0-2-2zm10 0a2 2 0 1 0 2 2 2 2 0 0 0-2-2zM7.16 6l.84 2h9.42a1 1 0 0 1 .96 1.28l-1.6 5.6A2 2 0 0 1 14.86 16H9.14a2 2 0 0 1-1.92-1.12L5.1 6.76A1 1 0 0 0 4.16 6H3V4h2.34a2 2 0 0 1 1.82 1.2z"/>
        </svg>
        <span class="sr-only">Cart</span>
        <span class="site-cart__badge" aria-hidden="true">0</span>
      </a>

      <a class="site-profile" id="profileLink" href="userprofile.html" aria-label="Open profile menu">
        <div class="site-avatar" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5.006 5.006 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"/>
          </svg>
        </div>
        <span class="sr-only">Profile</span>
      </a>
    </div>
  </div>
</header>


<main id="content" class="container" style="margin-top:10px">
  <nav class="crumbs" aria-label="Breadcrumb">
    <a href="#">Profile</a> <span class="sep">›</span>
    <span aria-current="page">Dietary Limits</span>
  </nav>

  <div class="grid-2">
    <!-- LEFT -->
    <section class="panel">
      <div class="pad">
        <div class="section-head">
          <h2>Your profile</h2>
          <div class="hint">Visit linked diet and allergies</div>
        </div>

        <div class="patient">
          <div class="pfp" id="pfpInitials">-</div>
          <div>
            <strong id="pf_name">-</strong>
            <div class="muted" id="pf_meta">MRN001 • Room -</div>
          </div>
        </div>

        <div class="list" style="margin-top:14px">
          <div class="cardish">
            <h3>Diet orders</h3>
            <div class="chips" id="diet_chips"><span class="chip">-</span></div>
          </div>
          <div class="cardish">
            <h3>Allergies</h3>
            <div class="chips" id="allergy_chips"><span class="chip">-</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="panel" aria-label="Dietary limits">
      <div class="pad">
        <div class="section-head" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div>
            <h2>Dietary totals and limits</h2>
            <div class="hint">Limits come from the assigned diet. Totals sum all non cancelled orders.</div>
          </div>
          <button type="button" class="pill orders mono" id="btnOrders" title="View orders">Orders</button>
        </div>

        <div class="list" id="limits_list">
          <div class="cardish meter" data-key="cal">
            <div class="row">
              <div class="inline"><strong>Calories</strong><span class="muted mono" id="today_cal">-</span></div>
              <span class="badge mono" id="badge_cal">-</span>
            </div>
            <div class="bar" id="bar_cal"><span></span></div>
          </div>

          <div class="cardish meter" data-key="na">
            <div class="row">
              <div class="inline"><strong>Sodium</strong><span class="muted mono" id="today_na">-</span></div>
              <span class="badge mono" id="badge_na">-</span>
            </div>
            <div class="bar" id="bar_na"><span></span></div>
          </div>

          <div class="cardish meter" data-key="pro">
            <div class="row">
              <div class="inline"><strong>Protein</strong><span class="muted mono" id="today_pro">-</span></div>
              <span class="badge mono" id="badge_pro">-</span>
            </div>
            <div class="bar" id="bar_pro"><span></span></div>
          </div>

          <div class="cardish meter" data-key="carb">
            <div class="row">
              <div class="inline"><strong>Carbohydrates</strong><span class="muted mono" id="today_carb">-</span></div>
              <span class="badge mono" id="badge_carb">-</span>
            </div>
            <div class="bar" id="bar_carb"><span></span></div>
          </div>

          <div class="cardish meter" data-key="fat">
            <div class="row">
              <div class="inline"><strong>Fat</strong><span class="muted mono" id="today_fat">-</span></div>
              <span class="badge mono" id="badge_fat">-</span>
            </div>
            <div class="bar" id="bar_fat"><span></span></div>
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- Orders dialog -->
<dialog id="ordersDlg">
  <div class="dlg-head">
    <strong>Orders</strong>
    <button class="btn" id="btnCloseDlg" aria-label="Close orders">Close</button>
  </div>

  <div class="dlg-body">
    <table class="orders" id="ordersTable">
      <thead>
        <tr><th style="width:120px">Order #</th><th>When</th><th>Meal</th><th>Status</th></tr>
      </thead>
      <tbody id="ordersTbody"><tr><td colspan="4">Loading…</td></tr></tbody>
    </table>

    <!-- In-dialog details - populated on click -->
    <section id="orderDetails" class="order-details" hidden>
      <h4 id="od_title">Order details</h4>
      <div class="kv" id="od_kv"></div>
      <div class="items">
        <strong>Items</strong>
        <ul id="od_items"></ul>
      </div>
    </section>

    <div id="ordersEmpty" class="muted" style="display:none;margin-top:8px">No orders to show.</div>
  </div>

  <div class="dlg-foot">
    <span class="muted mono" id="ordersCount">-</span>
  </div>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ────────────────────────────────────────────────────────────────────────────
  // Params / API
  // ────────────────────────────────────────────────────────────────────────────
  const params   = new URLSearchParams(location.search);
  const MRN      = (params.get('mrn') || '').trim();
  const API_BASE = params.get('api') || '';
  const api = (p) => (API_BASE ? API_BASE + p : p);

  // ────────────────────────────────────────────────────────────────────────────
  // DOM utils
  // ────────────────────────────────────────────────────────────────────────────
  const $  = (s) => document.querySelector(s);
  const nf = (n) => new Intl.NumberFormat().format(+n);
  const pct = (v, lim) => (!lim || lim <= 0) ? 0 : (v / lim * 100);

  function setText(sel, txt) {
    const el = $(sel);
    if (el) el.textContent = txt;
  }

  function setBar(sel, p) {
    const el = $(sel);
    if (!el) return;
    const v = Math.max(0, Math.min(120, p || 0));
    el.style.setProperty('--val', `${v}%`);
    el.classList.remove('ok', 'warn', 'alert');
    if (v > 100) el.classList.add('alert');
    else if (v >= 90) el.classList.add('warn');
    else el.classList.add('ok');
  }

  function setInitials(name) {
    const ini = (name || '')
      .split(' ')
      .map(x => x[0] || '')
      .join('')
      .slice(0, 2)
      .toUpperCase();
    const p = $('#pfpInitials');
    if (p) p.textContent = ini || 'RN';
  }

  // ────────────────────────────────────────────────────────────────────────────
  // Nav helpers (carry MRN/API onto links)
  // ────────────────────────────────────────────────────────────────────────────
  function withParams(href, extra = {}) {
    try {
      const base = (href || '').trim() || '/';
      const url = base.startsWith('http') ? new URL(base) : new URL(base, location.origin);
      for (const [k, v] of Object.entries(extra)) {
        if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
      }
      return url.toString();
    } catch {
      return href;
    }
  }

  function carryTo(selector, fallbackHref, extras = {}) {
    const el = document.querySelector(selector);
    if (!el) return;
    const original = el.getAttribute('href') || fallbackHref || '';
    if (!original) return;
    el.setAttribute('href', withParams(original, { mrn: MRN, api: API_BASE, ...extras }));
  }

  // ────────────────────────────────────────────────────────────────────────────
  // Cart badge (sessionStorage-backed)
  // ────────────────────────────────────────────────────────────────────────────
  const cartA = $('#cartLink');

  function cartKey(mrn) { return `bb.cart.${mrn || 'nomrn'}`; }
  function readCart(mrn) {
    try { return JSON.parse(sessionStorage.getItem(cartKey(mrn)) || '[]'); }
    catch { return []; }
  }

  function setCartBadge(count) {
    const badge = document.querySelector('.site-cart__badge');
    if (badge) badge.textContent = String(count);
    if (cartA) {
      cartA.setAttribute('aria-label', `Open cart (${count} item${count === 1 ? '' : 's'})`);
      cartA.dataset.count = String(count);
    }
  }

  function refreshCartBadge() {
    const items = readCart(MRN);
    setCartBadge(items.length);
  }

  // keep fresh across page lifecycle + custom event
  window.addEventListener('pageshow', refreshCartBadge);
  window.addEventListener('focus', refreshCartBadge);
  document.addEventListener('visibilitychange', () => { if (!document.hidden) refreshCartBadge(); });
  window.addEventListener('bb:cartChanged', refreshCartBadge); // other pages can dispatch this

  // wire cart/profile/menu links to carry MRN/API
  carryTo('#profileLink', 'userprofile.html');
  carryTo('#cartLink',    'ordersummary.html');
  carryTo('.site-brand',  'patientview.html');  // home/menu icon
  carryTo('#menuLink',    'patientview.html');

  // also keep the #profileLink consistent if it exists already
  const profileLink = $('#profileLink');
  if (profileLink) {
    profileLink.href = withParams('userprofile.html', { mrn: MRN, api: API_BASE });
  }

  // paint initial badge ASAP
  refreshCartBadge();

  // ────────────────────────────────────────────────────────────────────────────
  // Orders dialog (open first, then load)
  // ────────────────────────────────────────────────────────────────────────────
  const ordersBtn = $('#btnOrders');
  const ordersDlg = $('#ordersDlg');
  const closeDlg  = $('#btnCloseDlg');

  if (ordersBtn && ordersDlg) {
    ordersBtn.addEventListener('click', (ev) => {
      const r = ev.currentTarget.getBoundingClientRect();
      ordersDlg.style.top = `${Math.max(12, r.bottom + 12)}px`;
      if (typeof ordersDlg.showModal === 'function') ordersDlg.showModal();
      else ordersDlg.setAttribute('open', '');
      populateOrdersTable().catch(() => {});
    });
  }
  if (closeDlg && ordersDlg) {
    closeDlg.addEventListener('click', () => {
      if (typeof ordersDlg.close === 'function') ordersDlg.close();
      else ordersDlg.removeAttribute('open');
    });
  }

  // ────────────────────────────────────────────────────────────────────────────
  // Guard for MRN
  // ────────────────────────────────────────────────────────────────────────────
  if (!MRN) {
    const c = $('#content');
    if (c) c.innerHTML = `<div class="cardish">Missing MRN. Try <code>?mrn=MRN001</code>.</div>`;
    return;
  }

  // ────────────────────────────────────────────────────────────────────────────
  // Basic profile
  // ────────────────────────────────────────────────────────────────────────────
  (async function loadBasics() {
    const setBasics = (name, mrn, room) => {
      setText('#pf_name', name || '-');
      setText('#pf_meta', `${mrn || '-'} • Room ${room || '-'}`);
      setInitials(name);
    };
    try {
      const r = await fetch(api(`/api/profile/basic?mrn=${encodeURIComponent(MRN)}`));
      const p = await r.json();
      const name = p.PatientName ?? p.patientName ?? [p.firstName, p.lastName].filter(Boolean).join(' ');
      setBasics(name, p.MRN ?? p.mrn ?? MRN, p.RoomNumber ?? p.roomNumber);
    } catch {
      setBasics('-', MRN, '-');
    }
  })();

  // ────────────────────────────────────────────────────────────────────────────
  // Allergies
  // ────────────────────────────────────────────────────────────────────────────
  (async function loadAllergies() {
    try {
      const r = await fetch(api(`/api/profile/allergies?mrn=${encodeURIComponent(MRN)}`));
      const arr = await r.json();
      const box = $('#allergy_chips'); if (!box) return;
      box.innerHTML = '';
      const filtered = (arr || []).filter(a => String(a.Name ?? a.name ?? '').trim().toLowerCase() !== 'none');
      if (filtered.length) {
        filtered.forEach(a => {
          const s = document.createElement('span');
          s.className = 'chip';
          s.textContent = a.Name ?? a.name;
          box.appendChild(s);
        });
      } else {
        box.insertAdjacentHTML('beforeend', '<span class="chip">None recorded</span>');
      }
    } catch {
      const box = $('#allergy_chips');
      if (box) box.innerHTML = '<span class="chip">None recorded</span>';
    }
  })();

  // ────────────────────────────────────────────────────────────────────────────
  // Diet + limit badges
  // ────────────────────────────────────────────────────────────────────────────
  const DEFAULTS = { cal: 2000, na: 2000, pro: 75, fat: 70, carbDay: 180 };
  const limits   = { cal: DEFAULTS.cal, na: DEFAULTS.na, pro: DEFAULTS.pro, fat: DEFAULTS.fat, carbDay: DEFAULTS.carbDay };

  function numOrNull(v) {
    const n = Number(v);
    return Number.isFinite(n) && n > 0 ? n : null;
  }
  function setBadge(id, val, unit) {
    const el = document.getElementById(id);
    if (!el) return;
    if (val == null) { el.textContent = 'No limit'; el.title = 'No limit'; el.classList.add('muted'); }
    else { el.textContent = `Max ${nf(val)} ${unit}`; el.title = el.textContent; el.classList.remove('muted'); }
  }

  (async function loadDiet() {
    try {
      const r = await fetch(api(`/api/profile/active-diet?mrn=${encodeURIComponent(MRN)}`));
      const d = await r.json();
      const dietName = d?.DietName || d?.dietName || 'Normal';
      const dietBox = $('#diet_chips');
      if (dietBox) dietBox.innerHTML = `<span class="chip">${dietName}</span>`;
      const badgeVals = {
        cal:  numOrNull(d?.CalorieLimitKCal ?? d?.calorieLimitKCal),
        na:   numOrNull(d?.SodiumLimitMG    ?? d?.sodiumLimitMG),
        pro:  numOrNull(d?.ProteinLimitG    ?? d?.proteinLimitG),
        fat:  numOrNull(d?.FatLimitG        ?? d?.fatLimitG),
        carb: (() => {
          const day  = numOrNull(d?.CarbsPerDayMax  ?? d?.carbsPerDayMax);
          if (day) return day;
          const meal = numOrNull(d?.CarbsPerMealMax ?? d?.carbsPerMealMax);
          return meal ? meal * 3 : null;
        })()
      };
      setBadge('badge_cal',  badgeVals.cal,  'kcal / day');
      setBadge('badge_na',   badgeVals.na,   'mg / day');
      setBadge('badge_pro',  badgeVals.pro,  'g / day');
      setBadge('badge_carb', badgeVals.carb, 'g / day');
      setBadge('badge_fat',  badgeVals.fat,  'g / day');

      limits.cal     = badgeVals.cal  ?? DEFAULTS.cal;
      limits.na      = badgeVals.na   ?? DEFAULTS.na;
      limits.pro     = badgeVals.pro  ?? DEFAULTS.pro;
      limits.fat     = badgeVals.fat  ?? DEFAULTS.fat;
      limits.carbDay = badgeVals.carb ?? DEFAULTS.carbDay;
    } catch {
      const dietBox = $('#diet_chips');
      if (dietBox) dietBox.innerHTML = `<span class="chip">Normal</span>`;
      setBadge('badge_cal',  DEFAULTS.cal,  'kcal / day');
      setBadge('badge_na',   DEFAULTS.na,   'mg / day');
      setBadge('badge_pro',  DEFAULTS.pro,  'g / day');
      setBadge('badge_carb', DEFAULTS.carbDay, 'g / day');
      setBadge('badge_fat',  DEFAULTS.fat,  'g / day');
    }
  })();

  // ────────────────────────────────────────────────────────────────────────────
  // Totals from orders
  // ────────────────────────────────────────────────────────────────────────────
  (async function loadTotals() {
    async function aggregateAllOrders() {
      try {
        const r = await fetch(api(`/api/orders?mrn=${encodeURIComponent(MRN)}`));
        const orders = await r.json();
        const active = (orders || []).filter(o => (o.Status || o.status || '').toLowerCase() !== 'cancelled');
        if (!active.length) return { calories: 0, sodiumMg: 0, proteinG: 0, carbsG: 0, fatG: 0, count: 0 };

        const details = await Promise.allSettled(
          active.map(o => fetch(api(`/api/orders/${o.OrderID ?? o.orderID}`)).then(x => x.json()))
        );

        const qtyByItem = new Map();
        details.forEach(r => {
          if (r.status !== 'fulfilled') return;
          (r.value.items || r.value.Items || []).forEach(it => {
            const id  = it.MenuItemID ?? it.menuItemID;
            const qty = it.Qty ?? it.qty ?? 1;
            if (!id) return;
            qtyByItem.set(id, (qtyByItem.get(id) || 0) + qty);
          });
        });

        if (!qtyByItem.size) return { calories: 0, sodiumMg: 0, proteinG: 0, carbsG: 0, fatG: 0, count: active.length };

        const ids   = [...qtyByItem.keys()];
        const infos = await Promise.allSettled(ids.map(id => fetch(api(`/api/menu/${id}`)).then(x => x.json())));

        const t = { calories: 0, sodiumMg: 0, proteinG: 0, carbsG: 0, fatG: 0, count: active.length };
        infos.forEach((r, i) => {
          if (r.status !== 'fulfilled' || !r.value) return;
          const m = r.value, q = qtyByItem.get(ids[i]) || 0, g = v => (v == null || isNaN(v)) ? 0 : Number(v);
          t.calories += g(m.calories) * q;
          t.sodiumMg += g(m.sodiumMg ?? m.sodium ?? m.saltMg) * q;
          t.proteinG += g(m.proteinG ?? m.protein ?? m.proteinsG) * q;
          t.carbsG   += g(m.carbsG   ?? m.carbG   ?? m.carbohydratesG ?? m.carbohydrates ?? m.carb ?? m.carbs) * q;
          t.fatG     += g(m.fatG     ?? m.fat     ?? m.fatsG) * q;
        });
        return t;
      } catch {
        return { calories: 0, sodiumMg: 0, proteinG: 0, carbsG: 0, fatG: 0, count: 0 };
      }
    }

    const totals = await aggregateAllOrders();
    const fmt = (x, u) => (x == null || isNaN(x)) ? '-' : `${nf(x)} ${u}`;

    setText('#today_cal',  `${fmt(totals.calories, 'kcal')} total`);
    setText('#today_na',   `${fmt(totals.sodiumMg, 'mg')} total`);
    setText('#today_pro',  `${fmt(totals.proteinG, 'g')} total`);
    setText('#today_carb', `${fmt(totals.carbsG,   'g')} total`);
    setText('#today_fat',  `${fmt(totals.fatG,     'g')} total`);

    setBar('#bar_cal',  pct(totals.calories, limits.cal));
    setBar('#bar_na',   pct(totals.sodiumMg, limits.na));
    setBar('#bar_pro',  pct(totals.proteinG, limits.pro));
    setBar('#bar_carb', pct(totals.carbsG,   limits.carbDay));
    setBar('#bar_fat',  pct(totals.fatG,     limits.fat));
  })();

  // ────────────────────────────────────────────────────────────────────────────
  // Toggleable order details (single-open state)
  // ────────────────────────────────────────────────────────────────────────────
  let openOrderID = null;
  let detailsLoadToken = 0; // race guard

  function setOrderBtnExpanded(oid, expanded) {
    const btn = document.querySelector(`button[data-oid="${oid}"]`);
    if (btn) btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
  }

  function markSelectedRow(orderID) {
    document.querySelectorAll('#ordersTable tbody tr').forEach(tr => tr.classList.remove('is-selected'));
    const btn = document.querySelector(`button[data-oid="${orderID}"]`);
    btn?.closest('tr')?.classList.add('is-selected');
  }

  async function showOrderDetails(orderID) {
    const detailsBox = $('#orderDetails');
    const kv         = $('#od_kv');
    const itemsUL    = $('#od_items');

    setText('#od_title', `Order #${orderID}`);
    if (kv) kv.innerHTML = '';
    if (itemsUL) itemsUL.innerHTML = '<li class="muted">Loading…</li>';
    if (detailsBox) detailsBox.hidden = false;

    if (openOrderID && openOrderID !== orderID) setOrderBtnExpanded(openOrderID, false);
    openOrderID = orderID;
    setOrderBtnExpanded(orderID, true);
    markSelectedRow(orderID);

    const myToken = ++detailsLoadToken;

    try {
      const r = await fetch(api(`/api/orders/${orderID}`));
      const data = await r.json();

      if (myToken !== detailsLoadToken) return; // stale load, ignore

      const items = data.items || data.Items || [];
      if (!itemsUL) return;

      if (!items.length) {
        itemsUL.innerHTML = `<li class="muted">No items</li>`;
      } else {
        itemsUL.innerHTML = '';
        items.forEach(i => {
          const li = document.createElement('li');
          li.textContent = `${i.itemName || i.ItemName || 'Item'} x ${i.qty ?? i.Qty ?? 1}`;
          itemsUL.appendChild(li);
        });
      }
    } catch {
      if (itemsUL) itemsUL.innerHTML = `<li class="muted">Could not load items</li>`;
    }
  }

  function hideOrderDetails() {
    const detailsBox = $('#orderDetails');
    if (detailsBox) detailsBox.hidden = true;
    if (openOrderID) setOrderBtnExpanded(openOrderID, false);
    document.querySelectorAll('#ordersTable tbody tr').forEach(tr => tr.classList.remove('is-selected'));
    openOrderID = null;
  }

  function toggleOrderDetails(orderID) {
    if (openOrderID === orderID) {
      hideOrderDetails();
    } else {
      showOrderDetails(orderID);
    }
  }

  // close clears state
  const ordersDlgEl = $('#ordersDlg');
  if (ordersDlgEl) {
    ordersDlgEl.addEventListener('close', hideOrderDetails);
    ordersDlgEl.addEventListener('cancel', hideOrderDetails);
  }

  // ────────────────────────────────────────────────────────────────────────────
  // Orders table & details loader (in-dialog)
  // ────────────────────────────────────────────────────────────────────────────
  async function populateOrdersTable() {
    const tbody = $('#ordersTbody');
    if (!tbody) return;
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Loading…</td></tr>`;
    let list = [];
    try {
      const r = await fetch(api(`/api/orders?mrn=${encodeURIComponent(MRN)}`));
      const orders = await r.json();
      list = (orders || []).filter(o => (o.Status || o.status || '').toLowerCase() !== 'cancelled');
      list.sort((a, b) => new Date(b.placedOn || b.PlacedOn || 0) - new Date(a.placedOn || a.PlacedOn || 0));
    } catch {
      tbody.innerHTML = `<tr><td colspan="4" class="muted">Failed to load orders.</td></tr>`;
      return;
    }
    const countEl = $('#ordersCount');
    if (countEl) countEl.textContent = `${list.length} orders`;
    const empty = $('#ordersEmpty');

    if (!list.length) {
      tbody.innerHTML = '';
      if (empty) empty.style.display = 'block';
      hideOrderDetails();
      return;
    }
    if (empty) empty.style.display = 'none';
    tbody.innerHTML = '';

    list.forEach(o => {
      const id     = o.orderID ?? o.OrderID;
      const placed = o.placedOn ?? o.PlacedOn ?? o.dtmPlaced;
      const reqFor = o.requestedFor ?? o.RequestedFor;
      const when   = placed ? new Date(placed).toLocaleString() : '-';
      const when2  = reqFor ? new Date(reqFor).toLocaleString() : '';
      const statusTxt = (o.status ?? o.Status ?? '');
      const meal   = o.mealPeriod ?? o.MealPeriod ?? '-';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono"><button type="button" class="btn btn-mini" data-oid="${id}" aria-expanded="false">#${id}</button></td>
        <td><div>${when}</div><div class="twoliner">${when2 ? `Requested: ${when2}` : ''}</div></td>
        <td>${meal}</td>
        <td>${statusTxt}</td>
      `;

      const btn = tr.querySelector('button[data-oid]');
      const openOrToggle = () => toggleOrderDetails(id);
      btn.addEventListener('click', openOrToggle);
      tr.addEventListener('dblclick', openOrToggle);

      tbody.appendChild(tr);
    });

    // if we repainted the table while something was open, re-mark it
    if (openOrderID) {
      setOrderBtnExpanded(openOrderID, true);
      markSelectedRow(openOrderID);
    }
  }

  // ────────────────────────────────────────────────────────────────────────────
  // Submit order link/form (carry MRN automatically)
  // ────────────────────────────────────────────────────────────────────────────
  carryTo('#submitOrderLink');                 // if you have a <a id="submitOrderLink">
  carryTo('a[data-submit-order]');             // or any <a data-submit-order>

  const orderForm = document.querySelector('#orderForm, form[data-order-form]');
  if (orderForm && MRN) {
    let mrnInput = orderForm.querySelector('input[name="mrn"]');
    if (!mrnInput) {
      mrnInput = document.createElement('input');
      mrnInput.type = 'hidden';
      mrnInput.name = 'mrn';
      orderForm.appendChild(mrnInput);
    }
    mrnInput.value = MRN;
  }

  const submitBtn = document.querySelector('#submitOrderBtn, button[data-submit-order]');
  if (submitBtn && orderForm && MRN) {
    submitBtn.addEventListener('click', () => {
      let mrnInput = orderForm.querySelector('input[name="mrn"]');
      if (!mrnInput) {
        mrnInput = document.createElement('input');
        mrnInput.type = 'hidden';
        mrnInput.name = 'mrn';
        orderForm.appendChild(mrnInput);
      }
      mrnInput.value = MRN;
    });
  }
});
</script>
</body>
</html>