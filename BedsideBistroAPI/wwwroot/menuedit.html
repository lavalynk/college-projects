<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BedsideBistro – Menu Editor (recode)</title>

  <link rel="stylesheet" href="global.css" />
</head>
<body class="menuedit">

<!-- Header -->
  <header class="site-header">
  <div class="container site-header__bar" role="navigation" aria-label="Top">
    <a class="site-brand" href="patientview.html">
      <img src="BedsideBistro_Small.svg" alt="BedsideBistro" class="site-brand__img" />
      <span class="site-brand__text">BedsideBistro</span>
    </a>
    <!-- Right side group -->
    <div class="site-header__right">      
      <button class="ghost" id="editMenuBtn">Edit Menu</button>
      <button class="ghost" id="editIngrBtn">Edit Ingredients</button>
      <a class="site-profile" id="profileLink" href="userprofile.html" aria-label="Open profile menu">
        <div class="site-avatar" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5.006 5.006 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"/>
          </svg>
        </div>
        <span class="sr-only">Profile</span>
      </a>
    </div>
  </div>
</header>

      
    

<main id="content" class="container">
  <div class="layout">
    <!-- LEFT -->
    <section class="panel" id="menuPanel">
      <div class="pad">
        <div class="section-head">
          <h2>Menus</h2>
          <div class="hint">Breakfast · Lunch · Dinner</div>
        </div>
<!-- Global-styled tabs -->
<div class="site-tabs" role="tablist" aria-label="Menu types">
  <button class="site-tab" role="tab" aria-selected="true"
          aria-controls="tab-breakfast" id="btn-breakfast" type="button">
    Breakfast
  </button>
  <button class="site-tab" role="tab" aria-selected="false"
          aria-controls="tab-lunch" id="btn-lunch" type="button">
    Lunch
  </button>
  <button class="site-tab" role="tab" aria-selected="false"
          aria-controls="tab-dinner" id="btn-dinner" type="button">
    Dinner
  </button>
  <button class="site-tab" role="tab" aria-selected="false"
          aria-controls="tab-drink" id="btn-drink" type="button">
    Drinks
  </button>
  <button class="site-tab" role="tab" aria-selected="false"
          aria-controls="tab-dessert" id="btn-dessert" type="button">
    Desserts
  </button>
  <button class="site-tab" role="tab" aria-selected="false"
          aria-controls="tab-sides" id="btn-sides" type="button">
    Sides
  </button>

  <span style="flex:1"></span>
  <button class="site-tab" id="addItemBtn" type="button">+ Add item</button>
</div>



        <div id="tab-breakfast" class="list" role="tabpanel" aria-labelledby="btn-breakfast""></div>
        <div id="tab-lunch" class="list" role="tabpanel" aria-labelledby="btn-lunch" hidden></div>
        <div id="tab-dinner" class="list" role="tabpanel" aria-labelledby="btn-dinner" hidden ></div>
        <div id="tab-drink" class="list" role="tabpanel" aria-labelledby="btn-drink" hidden ></div>
        <div id="tab-dessert" class="list" role="tabpanel" aria-labelledby="btn-dessert" hidden ></div>
        <div id="tab-sides" class="list" role="tabpanel" aria-labelledby="btn-sides" hidden ></div>
      </div>
    </section>

    <!-- RIGHT: Add/Edit Panel -->
    <aside class="panel" id="itemEditor" style="display:none;">
      <form class="pad form" id="itemForm" novalidate>
        <div class="pad">
          <div class="section-head">
            <h2 id="panelTitle">Add Item</h2>
            <div class="hint">Add, remove, and edit ingredients and nutrition</div>
          </div>

          <div class="grid2">
            <label>
              <strong>Item name</strong>
              <input id="itemName" class="input" placeholder="e.g. Grilled Chicken Salad" />
            </label>
            <label>
              <strong>Menu type</strong>
              <select id="menuType" class="select"></select>
            </label>
            <label>
              <strong>Image</strong>
              <input class="input" id="m_imgFile" type="file" accept="image/*" />
              <input id="m_imgPath" type="hidden" />
              <div class="hint" id="m_imgHint">No file chosen.</div>
            </label>
          </div>

          <!-- INGREDIENTS -->
          <div style="margin-top:8px; border:1px solid var(--outline); border-radius:12px; padding:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <input id="m_ingrSearch" class="input" placeholder="Search ingredients…" />
              <button type="button" id="m_ingrClearBtn" class="ghost">Clear</button>
            </div>
            <div id="m_ingrBox" style="display:grid; gap:4px; max-height:180px; overflow:auto;"></div>
            <div style="margin-top:4px; text-align:right; font-size:.85rem;">
              Selected: <span id="m_ingrCount">0</span> / 6
            </div>

          </div>

          <!-- NUTRITION -->
          <div class="section-head" style="margin-top:14px">
            <h2>Nutrition facts</h2>
            <div class="hint">Per serving</div>
          </div>
          <div class="grid3">
            <label><strong>Calories (kcal)</strong><input id="nf-calories" class="input" type="number" step="1" placeholder="350" /></label>
            <label><strong>Protein (g)</strong><input id="nf-protein" class="input" type="number" step="0.1" placeholder="28" /></label>
            <label><strong>Total carbs (g)</strong><input id="nf-carbs" class="input" type="number" step="0.1" placeholder="24" /></label>
          </div>
          <div class="grid3" style="margin-top:8px">
            <label><strong>Total fat (g)</strong><input id="nf-fat" class="input" type="number" step="0.1" placeholder="10" /></label>
            <label><strong>Sodium (mg)</strong><input id="nf-sodium" class="input" type="number" step="1" placeholder="380" /></label>
            <label style="display:flex; align-items:center; gap:6px;">
              <strong>Is Active</strong>
              <input id="nf-active" type="checkbox" value="true" />
            </label>
            <div></div>
          </div>

          <div class="right" style="margin-top:14px">
            <button class="btn primary" id="saveBtn">Save changes</button>
          </div>
        </div>
      </form>
    </aside>



    <section class="panel" id='ingrPanel' style="display:none;">
      <div class="pad">
        <div class="section-head">
          <h2>Ingredients</h2>
          SUPERCALIFRAGILISTICEXPIALIDOCIOUS
        </div> 
      </div>
    </section>
  </div>
</main>

<script>
  // ---------- API endpoints ----------
  const apiEndpoints = {
    ingredients: {
      list:   '/api/ingredients',
      create: '/api/ingredients',
      update: id => `/api/ingredients/${id}`,
      del:    id => `/api/ingredients/${id}`
    },
    items: {
      list: '/api/menu',
      create: '/api/menu',
      get:    id => `/api/menu/${id}`,
      update: id => `/api/menu/${id}`,
      del:    id => `/api/menu/${id}`,
      attachIngredients: id => `/api/menu/${id}/ingredients`
    },
    mealPeriods: { list: '/api/mealperiods' }
  };

  // ---------- DOM refs ----------
  const m_mealSel = document.getElementById('menuType');
  const m_ingrEditBtn = document.getElementById('editIngrBtn');
  const m_menuEditBtn = document.getElementById('editMenuBtn');

  const editorPanel = document.getElementById('itemEditor');
  const panelTitle = document.getElementById('panelTitle');
  const itemForm = document.getElementById('itemForm');
  const menuPanel = document.getElementById('menuPanel');
  const ingrPanel = document.getElementById('ingrPanel');

  const m_ingrBox = document.getElementById('m_ingrBox');
  const m_ingrSearch = document.getElementById('m_ingrSearch');
  const m_ingrCount = document.getElementById('m_ingrCount');
  const m_ingrClearBtn = document.getElementById('m_ingrClearBtn');
  const m_imgFile  = document.getElementById('m_imgFile');
  const m_imgPath  = document.getElementById('m_imgPath');
  const m_imgHint  = document.getElementById('m_imgHint');

  m_imgFile.addEventListener('change', () => {
    const f = m_imgFile.files?.[0];
    m_imgHint.textContent = f ? `Selected: ${f.name}` : 'No file chosen.';
  });
  // ---------- state ----------
  let allMenuItems = [];
  let menu_mealPeriods = [];
  let menu_allIngredients = [];
  let menu_selectedIngredientIds = new Set();
  let editingItem = null;
  let currentCategory = 'breakfast';

  // ---------- helpers ----------
  function normalizeCategory(cat) {
    if (!cat) return '';
    const c = String(cat).toLowerCase();
    if (c.startsWith('breakfast')) return 'breakfast';
    if (c.startsWith('lunch')) return 'lunch';
    if (c.startsWith('dinner')) return 'dinner';
    if (c.startsWith('drink')) return 'drink';
    if (c.startsWith('dessert')) return 'dessert';
    if (c.startsWith('side')) return 'side';
    return c;
  }

  async function fetchMealPeriodsAny() {
    const urls = ['/api/mealperiods','/api/mealPeriods','/api/MealPeriods'];
    for (const url of urls){
      try{
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) continue;
        const arr = await res.json();
        if (Array.isArray(arr)) {
          apiEndpoints.mealPeriods.list = url;
          return arr;
        }
      }catch{}
    }
    return [];
  }

  async function ensureMealPeriodsLoaded() {
    if (!menu_mealPeriods.length) menu_mealPeriods = await fetchMealPeriodsAny();
  }

  function renderMealPeriods(selectedId = '') {
    m_mealSel.innerHTML = '';
    if (!menu_mealPeriods.length){
      m_mealSel.innerHTML = '<option value="">(no meal periods found)</option>';
      return;
    }
    m_mealSel.appendChild(new Option('Select…', ''));
    menu_mealPeriods.forEach(mp => {
      const id = mp.Id ?? mp.id ?? mp.intMealPeriodID;
      const nm = mp.Name ?? mp.name ?? mp.strMealPeriod ?? 'Meal Period';
      const opt = new Option(nm, id);
      if (String(id) === String(selectedId)) opt.selected = true;
      m_mealSel.appendChild(opt);
    });
  }

  async function ensureIngredientsLoaded() {
    if (!menu_allIngredients.length){
      try{
        const res = await fetch(apiEndpoints.ingredients.list, { cache: 'no-store' });
        if (res.ok) menu_allIngredients = await res.json();
        else menu_allIngredients = [];
      }catch{
        menu_allIngredients = [];
      }
    }
    renderIngredientPicker();
  }

  function renderIngredientPicker() {
    const term = (m_ingrSearch.value || '').toLowerCase();
    const filtered = term
      ? menu_allIngredients.filter(g => (g.name ?? '').toLowerCase().includes(term))
      : menu_allIngredients;

    m_ingrBox.innerHTML = '';
    filtered.forEach(g => {
      const id = g.id;
      const name = g.name ?? 'Ingredient';

      const wrap = document.createElement('label');
      wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='.5rem';
      wrap.style.padding='.25rem .35rem'; wrap.style.borderRadius='8px';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = String(id);
      cb.checked = menu_selectedIngredientIds.has(Number(id));
      cb.addEventListener('change', () => {
        const n = Number(id);
        if(cb.checked){
          if(menu_selectedIngredientIds.size >= 6){ cb.checked=false; alert('Max 6 ingredients'); return; }
          menu_selectedIngredientIds.add(n);
        } else {
          menu_selectedIngredientIds.delete(n);
        }
        updateIngredientCount();
      });

      const span = document.createElement('span');
      span.textContent = name;

      wrap.append(cb, span);
      m_ingrBox.appendChild(wrap);
    });

    updateIngredientCount();
  }

  function updateIngredientCount() {
    m_ingrCount.textContent = menu_selectedIngredientIds.size;
    const maxed = menu_selectedIngredientIds.size >= 6;
    m_ingrBox.querySelectorAll('input[type=checkbox]').forEach(cb => { if(!cb.checked) cb.disabled = maxed; });
  }



  // ---------- menu change ----------//

  m_menuEditBtn.addEventListener('click', () => {
    menuPanel.style.display = 'block';
    ingrPanel.style.display = 'none';
    editorPanel.style.display = 'none';
  });

  m_ingrEditBtn.addEventListener('click', () => {
    ingrPanel.style.display = 'block';
    menuPanel.style.display = 'none';
    editorPanel.style.display = 'none';
  });

  // ---------- ingredient stuff ----------//
  m_ingrSearch.addEventListener('input', renderIngredientPicker);
  m_ingrClearBtn.addEventListener('click', () => { menu_selectedIngredientIds.clear(); renderIngredientPicker(); });

  function extractIngredientIds(item) {
    if (!item) return [];
    let raw = [];
    if (Array.isArray(item.ingredients)) raw = item.ingredients;
    else if (Array.isArray(item.Ingredients)) raw = item.Ingredients;
    else if (Array.isArray(item.ingredientIds)) raw = item.ingredientIds;
    else if (Array.isArray(item.IngredientIds)) raw = item.IngredientIds;
    else if (Array.isArray(item.ItemIngredients))
      raw = item.ItemIngredients.map(x => x.ingredientId ?? x.IngredientId ?? x.id ?? x.Id);

    let ids = raw.map(v => {
      if (v && typeof v === 'object')
        return Number(v.id ?? v.Id ?? v.ingredientId ?? v.IngredientId);
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }).filter(Number.isFinite);

    if (!ids.length && raw.some(v => typeof v === 'string')) {
      const names = new Set(raw.map(s => String(s).toLowerCase()));
      ids = menu_allIngredients
        .filter(g => names.has(String(g.name).toLowerCase()))
        .map(g => Number(g.id))
        .filter(Number.isFinite);
    }
    return ids;
  }

  function renderIngredientPickerForItem(item){
    menu_selectedIngredientIds.clear();
    extractIngredientIds(item).forEach(n => menu_selectedIngredientIds.add(Number(n)));
    renderIngredientPicker();
  }

  async function loadMenu(category = null) {
    try {
      const response = await fetch(apiEndpoints.items.list, { cache: 'no-store' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const menuItems = await response.json();
      allMenuItems = Array.isArray(menuItems) ? menuItems : [];

      document.querySelectorAll('.list').forEach(list => list.innerHTML = '');

      const filtered = category
        ? allMenuItems.filter(item => normalizeCategory(item.category) === category)
        : allMenuItems;

      filtered.forEach(item => {
        const cat = normalizeCategory(item.category);
        const panelId =
          cat === 'breakfast' ? 'tab-breakfast' :
          cat === 'lunch'     ? 'tab-lunch'     :
          cat === 'dinner'    ? 'tab-dinner'    :
          cat === 'drink'     ? 'tab-drink'     :
          cat === 'dessert'   ? 'tab-dessert'   :
          cat === 'side'      ? 'tab-sides'     : null;
        if (!panelId) return;
        const panel = document.getElementById(panelId);
        if (!panel) return;

        const el = document.createElement('article');
        el.className = 'cell';
        el.dataset.id = item.id;

        const img = item.strImagePath || item.imagePath || '';
        const calories = item.calories ?? item.Calories ?? '';

        el.innerHTML = `
          <div class="meta">
            ${img ? `<img src="${img}" alt="${item.name ?? 'Item'}" />` : ''}
            <span class="name">${item.name ?? ''}</span>
            <button class="ghost edit-btn" style="margin-left:auto;">Edit</button>
          </div>
        `;
        panel.appendChild(el);
      });
    } catch (err) {
      console.error('Failed to fetch menu:', err);
    }
  }

  // ---------- tab logic ----------
  const tabs = [
    { btn: '#btn-breakfast', panel: '#tab-breakfast', category: 'breakfast' },
    { btn: '#btn-lunch',     panel: '#tab-lunch',     category: 'lunch' },
    { btn: '#btn-dinner',    panel: '#tab-dinner',    category: 'dinner' },
    { btn: '#btn-dessert',   panel: '#tab-dessert',   category: 'dessert' },
    { btn: '#btn-sides',     panel: '#tab-sides',     category: 'side' },
    { btn: '#btn-drink',     panel: '#tab-drink',     category: 'drink' }
  ];

  function activateTab(targetBtn) {
    tabs.forEach(({ btn, panel, category }) => {
      const button = document.querySelector(btn);
      const tabPanel = document.querySelector(panel);
      const active = btn === targetBtn;
      button.setAttribute('aria-selected', active ? 'true' : 'false');
      tabPanel.hidden = !active;
      if (active) currentCategory = category;
    });
  }

  tabs.forEach(({ btn, category }) => {
    document.querySelector(btn).addEventListener('click', async () => {
      activateTab(btn);
      await loadMenu(category);
    });
  });

  // ---------- editor ----------
  function clearEditor() {
  panelTitle.textContent = 'Add Item';

  // was: editorPanel.style.visibility = 'visible';
  editorPanel.style.display = 'block';   // <-- make it render

  editingItem = null;
  document.getElementById('itemName').value = '';
  renderMealPeriods();
  document.getElementById('nf-calories').value = '';
  document.getElementById('nf-protein').value  = '';
  document.getElementById('nf-carbs').value    = '';
  document.getElementById('nf-fat').value      = '';
  document.getElementById('nf-sodium').value   = '';
  document.getElementById('nf-active').checked  = false;
  menu_selectedIngredientIds.clear();
  renderIngredientPicker();
}

  

  async function populateEditor(item){
    if (!item) return;

    // Hydrate with full item to ensure ingredients exist
    try {
      const res = await fetch(apiEndpoints.items.get(item.id), { cache: 'no-store' });
      if (res.ok) item = await res.json();
    } catch {}

    editingItem = item;
    panelTitle.textContent = 'Edit Item';
    editorPanel.style.display = 'block';
    m_imgFile.value = ''; m_imgPath.value = ''; m_imgHint.textContent = 'No File Chosen.';

    document.getElementById('itemName').value = item.name ?? item.ItemName ?? '';
    await ensureMealPeriodsLoaded();
    await ensureIngredientsLoaded();

    let selectedId = item.mealPeriodId ?? item.MealPeriodID;
    if (!selectedId) {
      const catName = (item.category ?? item.Category ?? '').toString().trim().toLowerCase();
      const hit = menu_mealPeriods.find(mp =>
        (mp.Name ?? mp.name ?? mp.strMealPeriod ?? '').toString().trim().toLowerCase() === catName
      );
      selectedId = hit ? (hit.Id ?? hit.id ?? hit.intMealPeriodID) : '';
    }
    renderMealPeriods(selectedId);

    try{
      const data = await fetch(apiEndpoints.items.get(item.id));
      document.getElementById('nf-calories').value = item.calories ?? item.Calories ?? '';
      document.getElementById('nf-protein').value  = item.proteinG ?? item.ProteinG ?? '';
      document.getElementById('nf-carbs').value    = item.carbsG ?? item.CarbsG ?? '';
      document.getElementById('nf-fat').value      = item.fatG ?? item.FatG ?? '';
      document.getElementById('nf-sodium').value   = item.sodiumMg ?? item.SodiumMG ?? '';
      document.getElementById('nf-active').checked = item.isActive ?? item.IsActive ?? false;
      if (item.imagePath) { m_imgPath.value = item.imagePath; m_imgHint.textContent = `Current: ${item.imagePath}`; }
    }catch{}
    renderIngredientPickerForItem(item);
  }


  async function menu_maybeUploadImage(){
    const file = m_imgFile.files?.[0];
    if (!file) return m_imgPath.value || null;
    const fd = new FormData(); fd.append('file', file);
    try{
      const res = await fetch(UPLOAD_URL, { method:'POST', body: fd });
      const text = await res.text();
      logLine({ t:Date.now(), url:UPLOAD_URL, method:'POST', status:res.status, ok:res.ok, reqBody:'[FormData:file]', resBody:text });
      if (!res.ok) { showAlert(`Image upload failed (${res.status}).`); throw new Error('upload failed'); }
      let json={}; try{ json = JSON.parse(text); }catch{}
      const serverPath = json.url || json.Url || json.path || json.Path || null;
      if (!serverPath) { showAlert('Upload succeeded but no path returned from server.'); return null; }
      m_imgPath.value = serverPath; m_imgHint.textContent = `Uploaded: ${serverPath}`;
      return serverPath;
    }catch(err){ throw err; }
  }

  document.getElementById('addItemBtn').addEventListener('click', clearEditor);
  document.body.addEventListener('click', async e => {
    if (e.target.matches('.edit-btn')) {
      const cell = e.target.closest('.cell');
      const id = cell?.dataset?.id;
      const item = allMenuItems.find(i => String(i.id) === String(id));
      await populateEditor(item);
    }
  });

  itemForm.addEventListener('submit', async e => {
    e.preventDefault();

    const mpRaw = m_mealSel.value;
    const mealPeriodIdVal = mpRaw !== '' && mpRaw !== null ? Number(mpRaw) : null;
    let imagePath = null;
    try{ imagePath = await menu_maybeUploadImage(); }catch{ return; }
    const payload = {
      id: editingItem?.id ?? undefined,
      ItemName: document.getElementById('itemName').value.trim(),
      Category: m_mealSel.options[m_mealSel.selectedIndex]?.text?.trim() || 'Other',
      MealPeriodID: mealPeriodIdVal,
      Calories: document.getElementById('nf-calories').value ? Number(document.getElementById('nf-calories').value) : null,
      ProteinG: document.getElementById('nf-protein').value ? Number(document.getElementById('nf-protein').value) : null,
      CarbsG: document.getElementById('nf-carbs').value ? Number(document.getElementById('nf-carbs').value) : null,
      FatG: document.getElementById('nf-fat').value ? Number(document.getElementById('nf-fat').value) : null,
      SodiumMG: document.getElementById('nf-sodium').value ? Number(document.getElementById('nf-sodium').value) : null,
      IsActive: document.getElementById('nf-active').checked,
      ImagePath:    imagePath || (m_imgPath.value || null),

      Ingredients: Array.from(menu_selectedIngredientIds) // numeric IDs
    };


    if (!payload.ItemName) { alert('Item name is required.'); return; }
    if (!payload.MealPeriodID) { alert('Please select a menu type.'); return; }

    try {
      let res;
      if (editingItem?.id) {
        res = await fetch(apiEndpoints.items.update(editingItem.id), {
          method: 'PUT',
          headers:{ 'Content-Type':'application/json','Accept':'application/json' },
          body: JSON.stringify(payload)
        });
      } else {
        res = await fetch(apiEndpoints.items.create, {
          method: 'POST',
          headers:{ 'Content-Type':'application/json','Accept':'application/json' },
          body: JSON.stringify(payload)
        });
      }

      // Keep item-ingredient links in sync on update
      if (editingItem?.id) {
        const ids = Array.from(menu_selectedIngredientIds);
        await fetch(apiEndpoints.items.attachIngredients(editingItem.id), {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Accept':'application/json' },
          body: JSON.stringify({ ingredientIds: ids })
        });
      }

      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        throw new Error(`Save failed (HTTP ${res.status}). ${txt || ''}`);
      }

      alert(editingItem?.id ? 'Item updated successfully!' : 'Item created successfully!');
      editorPanel.style.visibility = 'hidden';
      await loadMenu(currentCategory);
    } catch (err) {
      console.error(err);
      alert(err.message || 'Failed to save item.');
    }
  });

  // ---------- boot ----------
  (async () => {
    await ensureMealPeriodsLoaded();
    await ensureIngredientsLoaded();
    activateTab('#btn-breakfast');
    await loadMenu(currentCategory);
  })();
</script>
<!-- API Debugger -->
<style>
  #apiDebugToggle{position:fixed;right:14px;bottom:14px;z-index:9999;border:1px solid #cfe5db;background:#fff;padding:8px 10px;border-radius:999px;font:600 12px system-ui;box-shadow:0 6px 18px rgba(0,0,0,.08);cursor:pointer}
  #apiDebugPanel{position:fixed;right:14px;bottom:60px;z-index:9999;width:min(680px,92vw);max-height:60vh;display:none;background:#fff;border:1px solid #cfe5db;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12);overflow:hidden}
  #apiDebugPanel header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;background:#e9f5f0;border-bottom:1px solid #cfe5db}
  #apiDebugPanel header strong{font:700 13px/1.2 system-ui}
  #apiDebugPanel header .btns{display:flex;gap:6px}
  #apiDebugPanel header button{border:1px solid #cfe5db;background:#fff;border-radius:8px;padding:6px 8px;font:600 12px system-ui;cursor:pointer}
  #apiDebugPanel main{display:grid;grid-template-columns:1.2fr .8fr;gap:0;border-top:0;min-height:260px}
  #apiDebugList{border-right:1px solid #eef4f1;overflow:auto}
  #apiDebugList .row{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid #f1f5f3;font:12px system-ui}
  #apiDebugList .row .m{font-weight:700}
  #apiDebugList .row .u{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:44vw}
  #apiDebugList .row .s.ok{color:#2f7d5f} .s.bad{color:#b83b3b}
  #apiDebugList .row .t{color:#6b7671}
  #apiDebugDetail{padding:8px;overflow:auto}
  #apiDebugDetail pre{margin:0;font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap;word-break:break-word;background:#fbfefd;border:1px solid #eef4f1;border-radius:10px;padding:8px}
  #toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);z-index:99999;background:#1b1f1e;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s}
</style>

<div id="apiDebugPanel" role="region" aria-label="API Debugger">
  <header>
    <strong>API Debugger</strong>
    <div class="btns">
      <button id="apiCopyBtn" title="Copy latest entry">Copy</button>
      <button id="apiClearBtn" title="Clear log">Clear</button>
      <button id="apiCloseBtn" title="Close">Close</button>
    </div>
  </header>
  <main>
    <div id="apiDebugList" aria-label="Requests list"></div>
    <div id="apiDebugDetail" aria-label="Selected request detail"><pre>Select a row…</pre></div>
  </main>
</div>
<button id="apiDebugToggle" aria-expanded="false" aria-controls="apiDebugPanel">Debug</button>
<div id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  // Defaults used by the editor code
  window.UPLOAD_URL = window.UPLOAD_URL || '/api/uploads';
  const $ = sel => document.querySelector(sel);

  // Toast
  window.showAlert = (msg) => {
    const el = $('#toast'); el.textContent = msg || 'Notice';
    el.style.opacity = '1'; clearTimeout(el._t);
    el._t = setTimeout(() => { el.style.opacity = '0'; }, 1800);
  };

  // State
  const log = [];
  let selectedIndex = -1;

  // UI refs
  const panel = $('#apiDebugPanel');
  const list  = $('#apiDebugList');
  const detail= $('#apiDebugDetail');
  const toggle= $('#apiDebugToggle');

  // Renderers
  function renderList(){
    list.innerHTML = '';
    log.slice().reverse().forEach((e, iRev) => {
      const i = log.length - 1 - iRev;
      const row = document.createElement('div');
      row.className = 'row';
      const sCls = e.ok ? 'ok' : 'bad';
      row.innerHTML = `
        <span class="m">${e.method}</span>
        <span class="u" title="${e.url}">${e.url}</span>
        <span class="s ${sCls}">${e.status}</span>
        <span class="t">${e.ms} ms</span>
      `;
      row.addEventListener('click', () => { selectedIndex = i; renderDetail(); });
      list.appendChild(row);
    });
  }
  function renderDetail(){
    const e = log[selectedIndex];
    if(!e){ detail.innerHTML = '<pre>Select a row…</pre>'; return; }
    const reqPretty = prettify(e.reqBody);
    const resPretty = prettify(e.resBody);
    detail.innerHTML = `<pre>${[
      `# ${e.method} ${e.url}`,
      `Status: ${e.status}  -  Time: ${e.ms} ms`,
      e.error ? `Error: ${e.error}` : '',
      '',
      '--- Request Headers ---',
      formatHeaders(e.reqHeaders),
      '',
      '--- Request Body ---',
      reqPretty,
      '',
      '--- Response Headers ---',
      formatHeaders(e.resHeaders),
      '',
      '--- Response Body ---',
      resPretty
    ].filter(Boolean).join('\n')}</pre>`;
  }
  function formatHeaders(h){
    if(!h) return '(none)';
    const lines = [];
    for(const k in h) lines.push(k + ': ' + h[k]);
    return lines.length ? lines.join('\n') : '(none)';
  }
  function prettify(x){
    if(x == null || x === '') return '(empty)';
    if(typeof x === 'string'){
      try { return JSON.stringify(JSON.parse(x), null, 2); } catch { return x; }
    }
    try { return JSON.stringify(x, null, 2); } catch { return String(x); }
  }

  // Public helper used by existing code
  window.logLine = (entry) => {
    log.push({
      t: Date.now(), method: entry.method || 'GET', url: entry.url || '',
      status: entry.status ?? '', ok: !!entry.ok, ms: entry.ms ?? '',
      reqHeaders: entry.reqHeaders, reqBody: entry.reqBody,
      resHeaders: entry.resHeaders, resBody: entry.resBody, error: entry.error
    });
    renderList(); if(selectedIndex < 0) { selectedIndex = log.length - 1; renderDetail(); }
  };

  // Patch fetch
  const origFetch = window.fetch.bind(window);
  window.fetch = async function(url, options = {}){
    const started = performance.now();
    let reqBody = '';
    try {
      if(options.body instanceof FormData){ reqBody = '[FormData]'; }
      else if(options.body instanceof Blob){ reqBody = '[Blob]'; }
      else if(typeof options.body === 'string'){ reqBody = options.body; }
      else if(options.body){ reqBody = JSON.stringify(options.body); }
    } catch {}
    let reqHeaders = {};
    try {
      if(options.headers){
        if(options.headers.forEach){
          options.headers.forEach((v,k)=>{ reqHeaders[k]=v; });
        } else {
          reqHeaders = {...options.headers};
        }
      }
    } catch {}

    try {
      const res = await origFetch(url, options);
      const elapsed = Math.round(performance.now() - started);

      // Clone once and try to read text
      let text = '';
      try { text = await res.clone().text(); } catch {}
      const resHeaders = {};
      try { res.headers.forEach((v,k)=>{ resHeaders[k]=v; }); } catch {}

      window.logLine({
        t: Date.now(),
        url: typeof url === 'string' ? url : (url?.url || String(url)),
        method: (options.method || 'GET').toUpperCase(),
        status: res.status, ok: res.ok, ms: elapsed,
        reqHeaders, reqBody,
        resHeaders, resBody: text
      });
      return res;
    } catch (err){
      const elapsed = Math.round(performance.now() - started);
      window.logLine({
        t: Date.now(),
        url: typeof url === 'string' ? url : (url?.url || String(url)),
        method: (options.method || 'GET').toUpperCase(),
        status: 'ERR', ok: false, ms: elapsed,
        reqHeaders, reqBody,
        resHeaders: null, resBody: '', error: String(err && err.message || err)
      });
      throw err;
    }
  };

  // Wire controls
  toggle.addEventListener('click', () => {
    const open = panel.style.display !== 'none';
    if(open){ panel.style.display = 'none'; toggle.setAttribute('aria-expanded','false'); }
    else { panel.style.display = 'block'; toggle.setAttribute('aria-expanded','true'); }
  });
  $('#apiCloseBtn').addEventListener('click', () => { panel.style.display = 'none'; toggle.setAttribute('aria-expanded','false'); });
  $('#apiClearBtn').addEventListener('click', () => { log.length = 0; selectedIndex = -1; renderList(); renderDetail(); });
  $('#apiCopyBtn').addEventListener('click', async () => {
    const e = log[selectedIndex]; if(!e){ showAlert('Nothing selected'); return; }
    const payload = JSON.stringify(e, null, 2);
    try { await navigator.clipboard.writeText(payload); showAlert('Copied'); } catch { showAlert('Copy failed'); }
  });
})();
</script>

</body>
</html>
