<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BedsideBistro - Order Summary</title>
  <link rel="stylesheet" href="global.css" />
</head>
<body class="ordersummary">
  <!-- Header -->
  <header class="site-header">
  <div class="container site-header__bar" role="navigation" aria-label="Top">
    <a class="site-brand" href="patientview.html">
      <img src="BedsideBistro_Small.svg" alt="BedsideBistro" class="site-brand__img" />
      <span class="site-brand__text">BedsideBistro</span>
    </a>
    <!-- Right side group -->
    <div class="site-header__right">
      <a class="site-cart" id="cartLink" href="ordersummary.html" aria-label="Open cart" data-count="0">
        <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
          <path fill="currentColor" d="M7 18a2 2 0 1 0 2 2 2 2 0 0 0-2-2zm10 0a2 2 0 1 0 2 2 2 2 0 0 0-2-2zM7.16 6l.84 2h9.42a1 1 0 0 1 .96 1.28l-1.6 5.6A2 2 0 0 1 14.86 16H9.14a2 2 0 0 1-1.92-1.12L5.1 6.76A1 1 0 0 0 4.16 6H3V4h2.34a2 2 0 0 1 1.82 1.2z"/>
        </svg>
        <span class="sr-only">Cart</span>
        <span class="site-cart__badge" aria-hidden="true">0</span>
      </a>
      <a class="site-profile" id="profileLink" href="userprofile.html" aria-label="Open profile menu">
        <div class="site-avatar" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5.006 5.006 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"/>
          </svg>
        </div>
        <span class="sr-only">Profile</span>
      </a>
    </div>
  </div>
</header>


  <main id="content" class="container" style="margin-top:10px">
    <nav class="crumbs" aria-label="Breadcrumb">
      <a id="menuLink" href="patientview.html">Menu</a> <span class="sep">›</span>
      <span aria-current="page">Order Summary</span>
    </nav>

    <div class="layout">
      <section class="panel">
        <div class="pad">
          <div class="section-head">
            <h2>Your items</h2>
            <div class="hint">Review items and notes</div>
          </div>

          <div id="orderItems" class="items" role="list"></div>
          <div id="emptyMsg" class="hint" hidden>Your cart is empty. Go back to the menu to add items.</div>
        </div>
      </section>

      <aside class="panel totals" aria-label="Total order nutrition">
        <div class="pad">
          <div class="section-head">
            <h2>Order nutrition</h2>
            <div class="hint">Totals across all items in cart</div>
          </div>

          <div class="facts" id="totalsBox">
            <div class="fact"><span>Total Calories</span> <strong id="tCal">0 kcal</strong></div>
            <div class="fact"><span>Total Protein</span> <strong id="tPro">0 g</strong></div>
            <div class="fact"><span>Total Sodium</span> <strong id="tNa">0 mg</strong></div>
            <div class="fact"><span>Total Carbs</span> <strong id="tCarb">0 g</strong></div>
            <div class="fact"><span>Total Fat</span> <strong id="tFat">0 g</strong></div>
          </div>

          <div class="divider"></div>

          <label class="row" style="gap:10px;align-items:center">
            <span style="min-width:110px">Meal period</span>
            <select id="mealSelect" style="flex:1; padding:8px 10px; border:1px solid var(--outline); border-radius:10px"></select>
          </label>

          <button class="cta" type="button" id="btnPlace" aria-label="Place order" style="margin-top:12px">Place Order</button>
          <div class="fine" id="statusFine">Ready</div>
        </div>
      </aside>
    </div>
  </main>

<script>
(function(){
  // ENV
  const USING_FILE = location.protocol === 'file:';
  const BASE = USING_FILE ? 'https://bedsidebistroapi.winhost.com' : '';
  const MENU_URL = BASE + '/api/menu';
  const ORDERS_URL = BASE + '/api/orders';
  const MEALS_URL = BASE + '/api/mealperiods';

  const params = new URLSearchParams(location.search);
  const MRN = (params.get('mrn') || '').trim();

  // service user id
  const ORDERED_BY_USER_ID_DEFAULT = 4;
  const ORDERED_BY_USER_ID =
    Number(params.get('orderedByUserID')) ||
    Number(localStorage.getItem('bb.orderedByUserID') || 0) ||
    ORDERED_BY_USER_ID_DEFAULT;
  if (params.get('orderedByUserID')) localStorage.setItem('bb.orderedByUserID', String(ORDERED_BY_USER_ID));

  function withParams(baseUrl, extra = {}) {
    const url = new URL(baseUrl, location.origin);
    const p = new URLSearchParams(url.search);
    Object.entries(extra).forEach(([k, v]) => { if (v !== undefined && v !== null && v !== '') p.set(k, v); });
    url.search = p.toString();
    return baseUrl.startsWith('http') ? url.toString() : url.pathname + (p.toString() ? '?' + p.toString() : '');
  }
  const cartA = document.getElementById('cartLink');
  if (cartA) cartA.href = withParams(cartA.getAttribute('href') || 'ordersummary.html', { mrn: MRN });
  const profA = document.getElementById('profileLink');
  if (profA) profA.href = withParams(profA.getAttribute('href') || 'userprofile.html', { mrn: MRN });
  const menuLink = document.getElementById('menuLink');
  if (menuLink) menuLink.href = withParams('patientview.html', { mrn: MRN });

  // DOM
  const listEl = document.getElementById('orderItems');
  const emptyMsg = document.getElementById('emptyMsg');
  const btnPlace = document.getElementById('btnPlace');
  const fine = document.getElementById('statusFine');
  const mealSelect = document.getElementById('mealSelect');

  // totals
  const tCal = document.getElementById('tCal');
  const tPro = document.getElementById('tPro');
  const tNa  = document.getElementById('tNa');
  const tCarb= document.getElementById('tCarb');
  const tFat = document.getElementById('tFat');

  // helpers
  const num = (n, d=0) => { const v = Number(n); return Number.isFinite(v) ? v : d; };
  const esc = s => String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const pick = (o, keys) => { for (const k of keys) if (o && o[k] !== undefined && o[k] !== null) return o[k]; };
  const getId   = it => pick(it, ['id','ID','Id','itemId','ItemId','itemID','ItemID','intItemID','intItemId']);
  const getName = it => pick(it, ['name','Name','strItemName','itemName']) ?? '(unnamed)';
  const getCat  = it => pick(it, ['category','Category','strCategory','meal','Meal']) ?? '';
  const getImg  = it => pick(it, ['imagePath','ImagePath','strImagePath']) ?? '';
  const getCal  = it => pick(it, ['calories','Calories','decCalories']);
  const getNa   = it => pick(it, ['sodiumMg','SodiumMg','decSodiumMG']);
  const getPro  = it => pick(it, ['proteinG','ProteinG','decProteinG']);
  const getCarb = it => pick(it, ['carbsG','CarbsG','decCarbsG']);
  const getFat  = it => pick(it, ['fatG','FatG','decFatG']);
  const isLow   = it => !!pick(it, ['lowSodium','LowSodium','bitLowSodium']);
  function imgSrc(path){ if (!path) return '/food-images/default.jpg'; return path.startsWith('http') ? path : BASE + (path.startsWith('/') ? path : '/' + path); }

  function cartKey(mrn){ return `bb.cart.${mrn || 'nomrn'}`; }
  function readCart(mrn){ try { return JSON.parse(sessionStorage.getItem(cartKey(mrn)) || '[]'); } catch { return []; } }
  function writeCart(mrn, items){ sessionStorage.setItem(cartKey(mrn), JSON.stringify(items || [])); setCartBadge((items || []).length); }
  function setCartBadge(count){
    const badge = document.querySelector('.site-cart__badge');
    if (badge) badge.textContent = String(count);
    if (cartA) cartA.setAttribute('aria-label', `Open cart (${count} item${count === 1 ? '' : 's'})`);
  }

  // meal selection by clock
  function guessMealFromClock(now = new Date()){
    const h = now.getHours();
    if (h < 10) return 'Breakfast';
    if (h < 16) return 'Lunch';
    return 'Dinner';
  }
  let userTouchedMeal = false;

  // plain fetch helpers
  async function httpGetJSON(url){
    const r = await fetch(url, { headers:{ Accept:'application/json' }});
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }
  async function httpPostJSON(url, body){
    const r = await fetch(url, {
      method: 'POST',
      headers: { Accept:'application/json', 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      let msg = '';
      try { const t = await r.text(); msg = t; } catch {}
      throw new Error(`HTTP ${r.status}${msg ? ' - ' + msg : ''}`);
    }
    return r.json().catch(() => ({}));
  }

  // API calls
  const fetchItemById   = (id) => httpGetJSON(`${MENU_URL}/${encodeURIComponent(id)}`);
  const fetchAllMenu    = () => httpGetJSON(MENU_URL);
  const fetchMealPeriods= () => httpGetJSON(MEALS_URL + '?activeOnly=true');

  // hydrate cart with API data
  async function hydrateCart(cart){
    if (!cart.length) return [];
    const ids = Array.from(new Set(cart.map(getId).filter(Boolean)));
    const byId = {};
    await Promise.all(ids.map(async id => {
      try { byId[String(id)] = await fetchItemById(id); } catch {}
    }));
    let nameMap = null;
    if (cart.some(it => !getId(it))){
      try {
        const all = await fetchAllMenu();
        nameMap = new Map((Array.isArray(all) ? all : []).map(x => [getName(x).toLowerCase(), x]));
      } catch {}
    }
    const merged = cart.map(it => {
      const id = getId(it);
      const api = id ? byId[String(id)] : (nameMap ? nameMap.get(getName(it).toLowerCase()) : null);
      return {
        id: id ?? (api ? getId(api) : undefined),
        name: api ? getName(api) : getName(it),
        category: api ? getCat(api)  : (it.category || ''),
        imagePath: api ? getImg(api) : (it.imagePath || ''),
        calories: api && getCal(api) != null ? getCal(api) : it.calories,
        proteinG: api && getPro(api) != null ? getPro(api) : it.proteinG,
        sodiumMg: api && getNa(api)  != null ? getNa(api)  : it.sodiumMg,
        carbsG:   api && getCarb(api)!= null ? getCarb(api): it.carbsG,
        fatG:     api && getFat(api) != null ? getFat(api) : it.fatG,
        lowSodium: api ? isLow(api) : !!it.lowSodium,
        qty: Math.max(1, num(it.qty, 1)),
        notes: it.notes || '',
        ingredients: it.ingredients || [],
        extras: it.extras || [],
        dressings: it.dressings || []
      };
    });
    return merged;
  }

  // render list
  function render(list){
    setCartBadge(list.length);
    if (!list.length){
      listEl.innerHTML = '';
      emptyMsg.hidden = false;
      updateTotals([]);
      fine.textContent = MRN ? `Cart empty for MRN ${MRN}` : 'Cart empty';
      btnPlace.disabled = true;
      return;
    }
    emptyMsg.hidden = true;
    btnPlace.disabled = false;

    listEl.innerHTML = list.map((it, idx) => {
      const chips = [];
      const addChip = v => { if (v) chips.push(`<span class="chip">${esc(v)}</span>`); };
      (it.ingredients||[]).forEach(g => addChip(typeof g === 'string' ? g : (g.name ?? g.title ?? g.text)));
      (it.extras||[]).forEach(x => addChip(typeof x === 'string' ? x : (x.name ?? x.title ?? x.text)));
      (it.dressings||[]).forEach(d => addChip(typeof d === 'string' ? d : (d.name ?? d.title ?? d.text)));
      if (it.notes) addChip(it.notes);
      const hasAnyNut = [it.calories,it.proteinG,it.sodiumMg,it.carbsG,it.fatG].some(v => v != null);

      return `
        <article class="item" role="listitem" data-idx="${idx}">
          <div class="item-media" aria-hidden="true"><img src="${esc(imgSrc(it.imagePath))}" alt=""></div>
          <div>
            <h3 class="item-title">${esc(it.name || '(unnamed)')}${it.lowSodium ? `<span class="badge">Low Sodium</span>` : ``}</h3>
            <div class="muted">${esc(it.category || '')}</div>
            ${chips.length ? `<div class="chips">${chips.join('')}</div>` : ``}
            <div class="chips" aria-label="Per-item nutrition">
              ${it.calories  != null ? `<span class="chip">~${num(it.calories)} kcal</span>` : ``}
              ${it.proteinG  != null ? `<span class="chip">${num(it.proteinG)} g protein</span>` : ``}
              ${it.sodiumMg  != null ? `<span class="chip">${num(it.sodiumMg)} mg sodium</span>` : ``}
              ${it.carbsG    != null ? `<span class="chip">${num(it.carbsG)} g carbs</span>` : ``}
              ${it.fatG      != null ? `<span class="chip">${num(it.fatG)} g fat</span>` : ``}
              ${!hasAnyNut ? `<span class="chip">Nutrition not provided</span>` : ``}
            </div>
          </div>
          <div class="item-actions">
            <div class="qty" aria-label="Quantity">
              <button class="dec" aria-label="Decrease">-</button>
              <span class="q">${it.qty}</span>
              <button class="inc" aria-label="Increase">+</button>
            </div>
            <button class="ghost edit" type="button">Edit</button>
            <button class="ghost remove" type="button">Remove</button>
          </div>
        </article>
      `;
    }).join('');
    updateTotals(list);
  }

  function updateTotals(list){
    let cal=0, pro=0, na=0, carb=0, fat=0;
    list.forEach(it => {
      const q = Math.max(1, num(it.qty, 1));
      if (it.calories  != null) cal  += num(it.calories)  * q;
      if (it.proteinG  != null) pro  += num(it.proteinG)  * q;
      if (it.sodiumMg  != null) na   += num(it.sodiumMg)  * q;
      if (it.carbsG    != null) carb += num(it.carbsG)    * q;
      if (it.fatG      != null) fat  += num(it.fatG)      * q;
    });
    tCal.textContent  = `${Math.round(cal)} kcal`;
    tPro.textContent  = `${Math.round(pro)} g`;
    tNa.textContent   = `${Math.round(na)} mg`;
    tCarb.textContent = `${Math.round(carb)} g`;
    tFat.textContent  = `${Math.round(fat)} g`;
  }

  // list actions
  document.getElementById('orderItems').addEventListener('click', e => {
    const card = e.target.closest('.item'); if (!card) return;
    const idx = Number(card.getAttribute('data-idx'));
    const cart = readCart(MRN);

    if (e.target.classList.contains('remove')){
      cart.splice(idx, 1);
      writeCart(MRN, cart);
      loadAndRender();
      return;
    }
    if (e.target.classList.contains('edit')){
      const it = cart[idx] || {};
      const dest = getId(it) != null
        ? withParams('itemcustomization.html', { id: getId(it), mrn: MRN })
        : withParams('itemcustomization.html', { name: getName(it), mrn: MRN });
      location.href = dest;
      return;
    }
    if (e.target.classList.contains('inc') || e.target.classList.contains('dec')){
      const d = e.target.classList.contains('inc') ? 1 : -1;
      const it = cart[idx]; if (!it) return;
      it.qty = Math.max(1, num(it.qty, 1) + d);
      writeCart(MRN, cart);
      loadAndRender();
    }
  });

  // meal periods
  async function hydrateMeals(){
    try{
      const list = await fetchMealPeriods();
      mealSelect.innerHTML = (list || [])
        .map(m => {
          const n = (m.name || m.Name || '').toString();
          return `<option value="${esc(n)}">${esc(n)}</option>`;
        })
        .join('');

      const want = guessMealFromClock();
      const match =
        Array.from(mealSelect.options).find(o => o.value.toLowerCase() === want.toLowerCase()) ||
        Array.from(mealSelect.options).find(o => {
          const v = o.value.toLowerCase();
          return (want === 'Breakfast' && v.includes('break')) ||
                 (want === 'Lunch'     && v.includes('lunch')) ||
                 (want === 'Dinner'    && (v.includes('dinner') || v.includes('supper')));
        });

      if (match) mealSelect.value = match.value;
    } catch{
      mealSelect.innerHTML = `
        <option>Breakfast</option>
        <option>Lunch</option>
        <option>Dinner</option>`;
      mealSelect.value = guessMealFromClock();
    }
  }
  mealSelect.addEventListener('change', () => { userTouchedMeal = true; });
  setInterval(() => {
    if (userTouchedMeal) return;
    const want = guessMealFromClock();
    const opt = Array.from(mealSelect.options).find(o => o.value.toLowerCase() === want.toLowerCase());
    if (opt && mealSelect.value !== opt.value) {
      mealSelect.value = opt.value;
    }
  }, 5 * 60 * 1000);

  // place order
  btnPlace.addEventListener('click', async () => {
    const raw = readCart(MRN);
    if (!MRN){ alert('Missing MRN'); return; }
    if (!raw.length){ alert('Your cart is empty'); return; }

    const itemsPayload = raw.map(it => ({
      name: getName(it).trim(),
      qty: Math.max(1, num(it.qty, 1)),
      specialInstr: it.notes && it.notes.trim() ? it.notes.trim() : null
    }));

    const payload = {
      mrn: MRN,
      orderedByUserID: ORDERED_BY_USER_ID,
      orderedByUserName: null,
      mealPeriodName: mealSelect && mealSelect.value ? mealSelect.value : guessMealFromClock(),
      requestedFor: null,
      notes: "",
      items: itemsPayload
    };

    try{
      await httpPostJSON(ORDERS_URL, payload);
      writeCart(MRN, []);
      await loadAndRender();
      alert('Order placed');
      fine.textContent = 'Order placed';
    }catch(e){
      alert(`Order failed: ${e.message || e}`);
      fine.textContent = 'Order failed';
    }
  });

  // load and render
  async function loadAndRender(){
    const raw = readCart(MRN);
    setCartBadge(raw.length);
    try{
      const enriched = await hydrateCart(raw);
      render(enriched);
    }catch{
      render(raw.map(it => ({ ...it, qty: Math.max(1, num(it.qty, 1)), name: getName(it) })));
    }
  }

  // init
  window.addEventListener('focus', loadAndRender);
  document.addEventListener('visibilitychange', () => { if (!document.hidden) loadAndRender(); });
  window.addEventListener('pageshow', loadAndRender);

  hydrateMeals();
  loadAndRender();
})();

document.addEventListener('DOMContentLoaded', () => {
  // 1) read mrn from current URL
  const params = new URLSearchParams(location.search);
  const MRN = params.get('mrn') || '';

  // helper: add params to any href safely
  function withParams(href, extra = {}) {
    try {
      const base = href?.trim() || '/';
      const url = base.startsWith('http')
        ? new URL(base)
        : new URL(base, location.origin);
      for (const [k, v] of Object.entries(extra)) {
        if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
      }
      return url.toString();
    } catch {
      return href;
    }
  }

  // helper: set href on first match (if it exists)
  function carryTo(selector, fallbackHref) {
    const el = document.querySelector(selector);
    if (!el) return;
    const original = el.getAttribute('href') || fallbackHref || '';
    if (!original) return;
    el.setAttribute('href', withParams(original, { mrn: MRN }));
  }

  // 2) header links — profile, cart, menu icon
  carryTo('#profileLink', 'userprofile.html');
  carryTo('#cartLink', 'ordersummary.html');
  carryTo('.site-brand', 'patientview.html'); // menu/home icon

  // 3) order summary page — submit order as link OR form
  // (A) If it's a link (e.g., <a id="submitOrderLink">…)
  carryTo('#submitOrderLink');
  carryTo('a[data-submit-order]');
  
  // (B) If it's a form submit (e.g., <form id="orderForm"> with a button)
  const orderForm = document.querySelector('#orderForm, form[data-order-form]');
  if (orderForm && MRN) {
    // ensure mrn is included in form submission
    let mrnInput = orderForm.querySelector('input[name="mrn"]');
    if (!mrnInput) {
      mrnInput = document.createElement('input');
      mrnInput.type = 'hidden';
      mrnInput.name = 'mrn';
      orderForm.appendChild(mrnInput);
    }
    mrnInput.value = MRN;
  }

  // (C) If the submit is just a button not inside the form tag
  const submitBtn = document.querySelector('#submitOrderBtn, button[data-submit-order]');
  if (submitBtn && orderForm && MRN) {
    submitBtn.addEventListener('click', () => {
      // make sure hidden mrn is set before the form posts
      let mrnInput = orderForm.querySelector('input[name="mrn"]');
      if (!mrnInput) {
        mrnInput = document.createElement('input');
        mrnInput.type = 'hidden';
        mrnInput.name = 'mrn';
        orderForm.appendChild(mrnInput);
      }
      mrnInput.value = MRN;
    });
  }
});

</script>
</body>
</html>
