<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BedsideBistro - Nurse View</title>
  <link rel="stylesheet" href="global.css" />
  <style>
    /* Page */
    body.kitchenview{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 600px at 80% -10%,var(--brand-050),transparent 60%),var(--bg);
      color:var(--text);
      line-height:1.45;
      padding-top:8px;
    }
    .container{width:min(1200px,92vw);margin:0 auto;padding:0 16px}

    /* Tabs bar */
    .tabs-wrap{background:#fff;border:1px solid var(--outline);border-radius:18px;box-shadow:var(--shadow-soft);margin:22px auto 10px}
    .tabs{display:flex;justify-content:center;gap:.6rem;flex-wrap:wrap;padding:10px}
    .tab{appearance:none;background:var(--tab);color:var(--muted);border:1px solid var(--border);border-radius:999px;font-weight:700;font-size:.9rem;padding:10px 14px;cursor:pointer;transition:transform .08s ease,background .2s ease,color .2s ease}
    .tab:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{background:var(--brand);color:#fff;border-color:var(--brand);box-shadow:0 6px 14px rgba(47,125,95,.25)}

    /* Header size */
    .site-header__bar{padding-top:18px;padding-bottom:18px;align-items:center}

    /* Single column layout */
    .layout{display:grid;grid-template-columns:1fr;gap:18px;margin:10px 0 28px}
    .panel{background:#fff;border:1px solid var(--outline);border-radius:18px;box-shadow:var(--shadow-soft);overflow:hidden}
    .pad{padding:14px}

    /* Scroll area */
    .list{display:grid;gap:12px;max-height:520px;overflow:auto;padding-right:8px}
    .list::-webkit-scrollbar{width:8px}
    .list::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px}
    .list::-webkit-scrollbar-thumb{background:#888;border-radius:4px}
    .list::-webkit-scrollbar-thumb:hover{background:#555}

    /* Ticket cards */
    .cell{border:2px solid var(--outline);border-radius:16px;background:#fff;padding:10px;display:grid;gap:8px;cursor:pointer;transition:box-shadow .2s}
    .cell:hover{box-shadow:0 10px 22px rgba(0,0,0,.08)}
    .cell .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;min-height:28px}
    .cell .sub{min-height:20px}
    .pill{font-size:.85rem;padding:6px 9px;border-radius:999px;border:1px dashed var(--outline);background:#fbfefd}

    .steps{position:relative;padding:8px 4px 0}
    .steps::before{content:"";position:absolute;left:18px;right:18px;top:14px;height:4px;background:#e8efe9;border-radius:999px}
    .steps .track{position:absolute;left:18px;top:14px;height:4px;background:linear-gradient(90deg,var(--brand),var(--brand-600));border-radius:999px;width:0;transition:width .3s}
    .steps .row{position:relative;display:flex;justify-content:space-between}
    .step{display:grid;justify-items:center;gap:6px}
    .dot{width:20px;height:20px;border-radius:50%;display:grid;place-items:center;background:#fff;border:2px solid #cfe5db;color:#2f7d5f;font-size:.75rem;font-weight:800}
    .done .dot{background:linear-gradient(135deg,var(--brand),var(--brand-600));color:#fff;border-color:transparent}
    .active .dot{border-color:#2f7d5f}
    .label{font-size:.76rem;color:#5f6a66;white-space:nowrap}

    /* Order panel */
    #orderPane .muted{ color: var(--muted); }

    /* Modal base */
    .modal[hidden]{display:none}
    .modal{position:fixed;inset:0;z-index:100}
    .modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .modal__panel{position:relative;margin:6vh auto;width:min(780px,92vw);background:#fff;border:1px solid var(--outline);border-radius:16px;box-shadow:var(--shadow-soft);max-height:88vh;display:flex;flex-direction:column;overflow:hidden}
    .modal__hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--outline)}
    .modal__bd{padding:14px 16px;display:grid;gap:12px;overflow:auto}
    .modal__ft{padding:10px 16px;border-top:1px solid var(--outline);display:flex;justify-content:flex-end}
    .iconbtn{border:0;background:transparent;cursor:pointer}

    .items{display:grid;gap:12px}
    .item-card{border:1px solid var(--outline);border-radius:12px;padding:10px;background:#fff}

    .btn{appearance:none;border:1px solid var(--outline);background:#fff;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.danger{border-color:#e7b0b0;color:#8b2323}

    /* Settings dropdown */
    .settings{position:relative}
    .settings-menu{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--outline);border-radius:12px;box-shadow:var(--shadow-card);padding:10px;min-width:260px;display:none}
    .settings.open .settings-menu{display:block}

    /* Toggle switch */
    .switch{
      --w:46px; --h:26px; --r:999px;
      display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none;
    }
    .switch input{ position:absolute; opacity:0; width:0; height:0; }
    .switch .track{
      width:var(--w); height:var(--h); border-radius:var(--r);
      border:1px solid var(--outline); background:#eaeff0;
      position:relative; transition:background .2s, border-color .2s;
    }
    .switch .thumb{
      position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%;
      background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.2); transition:left .2s;
    }
    .switch input:checked + .track{ background:var(--brand); border-color:var(--brand); }
    .switch input:checked + .track .thumb{ left:calc(100% - 24px); }

    /* Iframe modal sizing */
    #orderFrameModal .modal__panel{
      width:min(1200px,96vw);
      height:min(86vh,900px);
      display:flex;
      flex-direction:column;
    }
    #orderFrameModal .modal__bd{
      padding:0;
      flex:1 1 auto;
      min-height:0;
      display:flex;
    }
    #orderFrame{
      display:block;
      width:100%;
      height:100%;
      flex:1 1 auto;
      min-height:0;
    }
    #orderFrameError{
      display:none;
      color:#8b2323;
      background:#ffe8e8;
      border:1px solid #f3c2c2;
      padding:8px 10px;
      margin:8px 16px;
      border-radius:8px;
    }
  </style>
</head>
<body class="kitchenview">

<header class="site-header">
  <div class="container site-header__bar" role="navigation" aria-label="Top">
    <a class="site-brand" href="index.html">
      <img src="BedsideBistro_Small.svg" alt="BedsideBistro" class="site-brand__img" />
      <span class="site-brand__text">BedsideBistro</span>
    </a>

    <label class="site-search" aria-label="Search orders">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
      <input id="q" type="search" placeholder="Search orders, patients, rooms..." />
    </label>

    <div class="settings" id="settingsBox">
      <!-- Keep your exact gear button -->
      <button class="site-profile" id="settingsBtn" aria-label="Settings">
        <div class="site-avatar" aria-hidden="true">
          <svg fill="#2f7d5f" height="200px" width="200px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 490 490" xml:space="preserve" stroke="#2f7d5f"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="XMLID_891_"> <g> <g> <path d="M490,305V185h-69.964c-2.498-7.291-5.453-14.42-8.844-21.34l49.475-49.475l-84.853-84.853L326.34,78.807 c-6.919-3.39-14.051-6.345-21.34-8.843V0H185v69.964c-7.29,2.498-14.42,5.453-21.34,8.843l-49.475-49.475l-84.853,84.853 l49.475,49.475c-3.391,6.92-6.345,14.05-8.843,21.34H0v120h69.964c2.498,7.291,5.453,14.42,8.843,21.34l-49.475,49.475 l84.853,84.853l49.475-49.475c6.92,3.391,14.05,6.345,21.34,8.843V490h120v-69.964c7.29-2.498,14.42-5.453,21.34-8.843 l49.475,49.475l84.853-84.853l-49.475-49.475c3.391-6.919,6.346-14.05,8.844-21.34H490z M418.241,375.815l-42.427,42.426 l-44.187-44.186l-9.944,5.673c-11.206,6.394-23.199,11.364-35.646,14.772L275,397.523V460h-60v-62.477l-11.039-3.022 c-12.445-3.408-24.438-8.378-35.646-14.772l-9.944-5.673l-44.186,44.186l-42.426-42.426l44.186-44.186l-5.673-9.944 c-6.394-11.206-11.364-23.199-14.772-35.646L92.478,275H30v-60h62.478l3.022-11.039c3.408-12.445,8.377-24.438,14.771-35.645 l5.674-9.944l-44.187-44.187l42.426-42.426l44.187,44.187l9.944-5.674c11.207-6.394,23.2-11.364,35.645-14.771L215,92.478V30h60 v62.478l11.039,3.022c12.446,3.408,24.438,8.378,35.645,14.771l9.944,5.674l44.187-44.187l42.427,42.426l-44.187,44.187 l5.674,9.944c6.393,11.205,11.363,23.198,14.772,35.646L397.523,215H460v60h-62.477l-3.022,11.038 c-3.409,12.447-8.38,24.44-14.772,35.646l-5.674,9.944L418.241,375.815z"></path> <path d="M245,150c-52.383,0-95,42.617-95,95s42.617,95,95,95s95-42.617,95-95S297.383,150,245,150z M245,310 c-35.841,0-65-29.159-65-65s29.159-65,65-65s65,29.159,65,65S280.841,310,245,310z"></path> </g> </g> </g> </g></svg>
        </div>
      </button>

      <div class="settings-menu" id="settingsMenu">
        <label class="switch">
          <input id="autoToggle" type="checkbox" />
          <span class="track"><span class="thumb"></span></span>
          <span>Auto refresh every 15s</span>
        </label>
      </div>
    </div>

    <a class="site-profile" id="fProfile" href="staffprofile.html" aria-label="Open profile menu">
      <div class="site-avatar" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="22" height="22">
            <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5.006 5.006 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"/>
          </svg>
        </div>
        <span class="sr-only">Profile</span>
    </a>
  </div>
</header>

<div class="container tabs-wrap">
  <nav class="tabs" aria-label="Ticket filters">
    <button class="tab" id="tab-open"      aria-current="page">Open Tickets (0)</button>
    <button class="tab" id="tab-closed"    aria-current="false">Closed Tickets (0)</button>
    <button class="tab" id="tab-cancelled" aria-current="false">Cancelled Tickets (0)</button>
    <button class="tab" id="tab-order"     aria-current="false">Order</button>
  </nav>
</div>

<main class="container">
  <!-- Tickets view -->
  <div class="layout" id="ticketsView">
    <section class="panel">
      <div class="pad">
        <h2 style="margin:0 0 6px">Open tickets</h2>
        <div id="ticketList" class="list" role="list"></div>
      </div>
    </section>
  </div>

  <!-- Order panel -->
  <section class="panel" id="orderPane" hidden>
    <div class="pad" style="display:grid;gap:12px;max-width:640px">
      <h2 style="margin:0">Start a new order</h2>

      <label style="display:grid;gap:6px">
        <span class="muted">Select patient (MRN - Name)</span>
        <select id="mrnSelect" style="padding:10px;border:1px solid var(--outline);border-radius:12px"></select>
      </label>

      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="startOrderBtn" class="btn" style="background:linear-gradient(135deg,var(--brand),var(--brand-600));border-color:transparent;color:#fff">
          Start Order
        </button>
      </div>
    </div>
  </section>
</main>

<!-- Embedded patient ordering modal -->
<section id="orderFrameModal" class="modal" role="dialog" aria-modal="true" hidden>
  <div class="modal__backdrop" id="orderFrameBackdrop"></div>
  <div class="modal__panel">
    <header class="modal__hd">
      <strong>New order</strong>
      <div style="display:flex; gap:8px; align-items:center">
        <a id="orderOpenNew" class="btn" target="_blank" rel="noopener">Open in new tab</a>
        <button class="iconbtn" id="orderFrameClose" aria-label="Close">✕</button>
      </div>
    </header>

    <div id="orderFrameError">Unable to load in an embedded window. Use Open in new tab instead.</div>

    <div class="modal__bd">
      <iframe id="orderFrame" src="about:blank"></iframe>
    </div>
  </div>
</section>

<!-- Order summary for existing tickets -->
<section id="orderModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle" hidden>
  <div class="modal__backdrop" id="modalBackdrop"></div>
  <div class="modal__panel" role="document">
    <header class="modal__hd">
      <strong id="mTitle">Order summary</strong>
      <button class="iconbtn" id="modalClose" aria-label="Close">✕</button>
    </header>
    <div class="modal__bd">
      <div class="kv"><strong id="mPatient">-</strong> <span class="pill" id="mRoom">Room -</span></div>
      <div class="steps" style="margin-top:6px">
        <div class="track" id="mTrack"></div>
        <div class="row" id="mStepsRow"></div>
      </div>
      <div class="items" id="mItems"></div>
      <div><strong>Notes:</strong> <span id="mNotes" class="mono">-</span></div>
    </div>
    <footer class="modal__ft">
      <button class="btn danger" id="cancelBtn">Cancel Order</button>
    </footer>
  </div>
</section>

<script>
  /* Settings dropdown */
  const settingsBtn=document.getElementById('settingsBtn');
  const settingsBox=document.getElementById('settingsBox');
  settingsBtn.addEventListener('click',()=>settingsBox.classList.toggle('open'));
  document.addEventListener('click',e=>{ if(!settingsBox.contains(e.target)) settingsBox.classList.remove('open'); });
  settingsBox.addEventListener('click', e => e.stopPropagation());

  /* API base */
  const params=new URLSearchParams(location.search);
  const API_BASE=params.get('api')||'';
  const api=(p)=>API_BASE+p;
  const API={
    list:api('/api/orders'),
    show:id=>api(`/api/orders/${id}`),
    cancel:id=>api(`/api/orders/${id}/cancel`),
    patients: api('/api/admissions/active')
  };

  const USERNAME = params.get('user') || ''
  const profA = document.getElementById('fProfile');
  if (profA) profA.href = withParams('staffProfile.html', { user: USERNAME });

  function withParams(baseUrl, extra = {}) {
    const url = new URL(baseUrl, location.origin);
    const p   = new URLSearchParams(url.search);
    Object.entries(extra).forEach(([k,v]) => { if (v!==undefined && v!==null && v!=='') p.set(v===true? k : k, v); });
    url.search = p.toString();
    return url.pathname + (p.toString() ? '?' + p.toString() : '');
  }

  /* Auto refresh */
  let refreshTimer=null;
  const AUTO_KEY='bb_kitchen_autorefresh';
  function startAuto(){ stopAuto(); refreshTimer=setInterval(()=>refreshAll(),15000); }
  function stopAuto(){ if(refreshTimer){ clearInterval(refreshTimer); refreshTimer=null; } }
  function setAuto(on){ document.getElementById('autoToggle').checked=!!on; localStorage.setItem(AUTO_KEY,on?'1':'0'); on?startAuto():stopAuto(); }
  document.getElementById('autoToggle').addEventListener('change',e=>setAuto(e.target.checked));

  /* State */
  let orders=[]; let selectedId=null; let mrnLoaded=false;

  /* Helpers */
  const $=(s)=>document.querySelector(s);
  const pick=(o,...keys)=>{for(const k of keys){if(o&&o[k]!==undefined&&o[k]!==null)return o[k];}};
  function normRow(r){ return {
    OrderID: pick(r,'OrderID','orderID','orderId','id'),
    PatientName: pick(r,'PatientName','patientName','patient'),
    RoomNumber: pick(r,'RoomNumber','roomNumber','room'),
    MealPeriod: pick(r,'MealPeriod','mealPeriod','meal'),
    Status: pick(r,'Status','status'),
    PlacedOn: pick(r,'PlacedOn','placedOn','placed'),
    MRN: pick(r,'MRN','mrn')
  }; }
  function normHeader(h){ return {
    OrderID: pick(h,'OrderID','orderID','orderId','id'),
    MRN: pick(h,'MRN','mrn'),
    PatientName: pick(h,'PatientName','patientName'),
    RoomNumber: pick(h,'RoomNumber','roomNumber'),
    MealPeriod: pick(h,'MealPeriod','mealPeriod'),
    Status: pick(h,'Status','status'),
    PlacedOn: pick(h,'PlacedOn','placedOn'),
    Notes: pick(h,'Notes','notes')
  }; }
  function normItem(it){ return { ItemName: pick(it,'ItemName','itemName','strItemName'), Qty: pick(it,'Qty','qty','intQty'), SpecialInstr: pick(it,'SpecialInstr','specialInstr','strSpecialInstr') }; }
  function safeText(v){ return (v===null||v===undefined)?'-':String(v); }
  function safeTime(v){ const d=new Date(v); return isNaN(d.getTime())?'-':d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
  function stepIndex(status){ switch((status||'').toLowerCase()){ case 'placed':return 0; case 'in kitchen':return 1; case 'ready':return 2; case 'delivered':return 3; default:return 0; } }

  /* Network */
  async function getJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
  async function patchJSON(url,body){ const r=await fetch(url,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok&&r.status!==204) throw new Error(await r.text()); return r.status===204?null:r.json(); }

  /* Tabs */
  const tabs={
    open:document.getElementById('tab-open'),
    closed:document.getElementById('tab-closed'),
    cancelled:document.getElementById('tab-cancelled'),
    order:document.getElementById('tab-order')
  };
  let currentTab='open';
  Object.entries(tabs).forEach(([k,el])=>el.addEventListener('click',()=>{currentTab=k;updateTabs();renderView();}));
  function updateTabs(){
    tabs.open.setAttribute('aria-current',currentTab==='open'?'page':'false');
    tabs.closed.setAttribute('aria-current',currentTab==='closed'?'page':'false');
    tabs.cancelled.setAttribute('aria-current',currentTab==='cancelled'?'page':'false');
    tabs.order.setAttribute('aria-current',currentTab==='order'?'page':'false');
  }

  /* Filter and counts */
  function filtered(){
    const q=($('#q').value||'').trim().toLowerCase();
    const base=currentTab==='open' ? orders.filter(o=>o.Status!=='Delivered'&&o.Status!=='Cancelled')
              : currentTab==='closed' ? orders.filter(o=>o.Status==='Delivered')
              : orders.filter(o=>o.Status==='Cancelled');
    return q ? base.filter(o=>String(o.RoomNumber||'').toLowerCase().includes(q)
                       || String(o.MRN||'').toLowerCase().includes(q)
                       || String(o.PatientName||'').toLowerCase().includes(q))
             : base;
  }
  function updateCounts(){
    tabs.open.textContent=`Open Tickets (${orders.filter(o=>o.Status!=='Delivered'&&o.Status!=='Cancelled').length})`;
    tabs.closed.textContent=`Closed Tickets (${orders.filter(o=>o.Status==='Delivered').length})`;
    tabs.cancelled.textContent=`Cancelled Tickets (${orders.filter(o=>o.Status==='Cancelled').length})`;
  }

  /* Render tickets - single column */
  function renderLists(){
    const data=filtered(); updateCounts();
    const root=document.getElementById('ticketList'); root.innerHTML='';
    data.forEach(o=>{
      const cell=document.createElement('article');
      cell.className='cell'; cell.dataset.id=o.OrderID;
      cell.innerHTML=`
        <div class="meta">
          <span class="name">${safeText(o.PatientName)}</span>
          <span class="pill">Room ${safeText(o.RoomNumber)}</span>
        </div>
        <div class="muted mono sub">${safeText(o.MealPeriod)||'-'} • Placed ${safeTime(o.PlacedOn)}</div>
        <div class="steps" aria-label="Order status">
          <div class="track"></div>
          <div class="row">
            ${['Placed','In Kitchen','Ready','Delivered'].map((label,i)=>{
              const idx=stepIndex(o.Status); const cls=i<idx?'step done':(i===idx?'step active':'step');
              return `<div class="${cls}"><div class="dot">${i+1}</div><div class="label">${label}</div></div>`;
            }).join('')}
          </div>
        </div>`;
      const pct=(stepIndex(o.Status)/(4-1))*100;
      cell.querySelector('.track').style.width=`calc(${pct}% - 18px)`;
      cell.addEventListener('click',()=>openOrder(o.OrderID));
      root.appendChild(cell);
    });
  }

  /* Order MRN list */
  async function loadMrns(){
    const data = await getJSON(API.patients);
    const rows = Array.isArray(data) ? data : (data.items || data.results || []);
    return rows.map(p => ({
      mrn: p.mrn || p.MRN,
      name: p.name || p.PatientName,
      room: p.room || p.RoomNumber
    })).filter(x => x.mrn);
  }
  async function ensureMrnOptions(){
    if(mrnLoaded) return;
    const sel = document.getElementById('mrnSelect');
    sel.innerHTML = '<option value="">Loading...</option>';
    try{
      const options = await loadMrns();
      sel.innerHTML = options.length
        ? options.map(o => `<option value="${o.mrn}">${o.mrn} - ${o.name} (Room ${o.room})</option>`).join('')
        : '<option value="">No active patients found</option>';
      mrnLoaded = true;
    }catch{
      sel.innerHTML = '<option value="">Failed to load patients</option>';
    }
  }

  /* Start Order - iframe with same-origin URL, hide error on load */
  document.getElementById('startOrderBtn').addEventListener('click', () => {
    const mrn = document.getElementById('mrnSelect').value;
    if(!mrn){ alert('Select a patient first'); return; }

    const base = location.origin;
    const url  = `${base}/patientview.html?mrn=${encodeURIComponent(mrn)}&by=nurse&return=nurseview.html&embed=1`;

    const frame = document.getElementById('orderFrame');
    const openNew = document.getElementById('orderOpenNew');
    const errBar = document.getElementById('orderFrameError');

    errBar.style.display = 'none';
    openNew.href = url;

    frame.src = 'about:blank';
    document.getElementById('orderFrameModal').hidden = false;

    frame.onload = () => {
      if (frame._embedTimer) { clearTimeout(frame._embedTimer); frame._embedTimer = null; }
      errBar.style.display = 'none';
      try { frame.contentWindow.postMessage({ type:'bb-embed-ping' }, base); } catch {}
    };

    // fallback only if load never fires
    frame._embedTimer = setTimeout(() => { errBar.style.display = 'block'; }, 3000);

    frame.src = url;
  });

  function closeOrderFrame(){
    document.getElementById('orderFrameModal').hidden = true;
    document.getElementById('orderFrame').src = 'about:blank';
  }
  document.getElementById('orderFrameBackdrop').addEventListener('click', closeOrderFrame);
  document.getElementById('orderFrameClose').addEventListener('click', closeOrderFrame);

  /* Optional messages from patientview */
  window.addEventListener('message', (e) => {
    try{
      if(e.origin !== location.origin) return;
      if(e.data && e.data.type === 'bb-order-complete'){
        closeOrderFrame();
        refreshAll();
        if(currentTab==='order'){ currentTab='open'; updateTabs(); renderView(); }
      }
    }catch{}
  });

  /* Router */
  function renderView(){
    const ticketsView = document.getElementById('ticketsView');
    const orderPane   = document.getElementById('orderPane');
    const showTickets = currentTab!=='order';
    ticketsView.style.display = showTickets ? '' : 'none';
    orderPane.hidden = showTickets;
    if(showTickets){ renderLists(); } else { ensureMrnOptions(); }
  }

  /* Order summary modal */
  function renderStepperModal(status){
    const row=document.getElementById('mStepsRow');
    row.innerHTML=['Placed','In Kitchen','Ready','Delivered'].map((label,i)=>{
      const idx=stepIndex(status); const cls=i<idx?'step done':(i===idx?'step active':'step');
      return `<div class="${cls}"><div class="dot">${i+1}</div><div class="label">${label}</div></div>`;
    }).join('');
    const pct=(stepIndex(status)/(4-1))*100;
    document.getElementById('mTrack').style.width=`calc(${pct}% - 18px)`;
  }
  function openModal(){ document.getElementById('orderModal').hidden=false; }
  function closeModal(){ document.getElementById('orderModal').hidden=true; }
  document.getElementById('modalBackdrop').addEventListener('click', closeModal);
  document.getElementById('modalClose').addEventListener('click', closeModal);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

  async function openOrder(id){
    selectedId=Number(id);
    const raw=await getJSON(API.show(selectedId));
    const header=normHeader(raw.header||raw.Header||raw);
    const items=Array.isArray(raw.items||raw.Items)?(raw.items||raw.Items).map(normItem):[];

    document.getElementById('mTitle').textContent='Order summary';
    document.getElementById('mPatient').textContent=`${safeText(header.PatientName)} - ${safeText(header.MRN)}`;
    document.getElementById('mRoom').textContent=`Room ${safeText(header.RoomNumber)}`;
    document.getElementById('mNotes').textContent=header.Notes||'-';

    const itemsEl=document.getElementById('mItems'); itemsEl.innerHTML='';
    items.forEach(it=>{
      const div=document.createElement('div');
      div.className='item-card';
      div.innerHTML=`<div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
          <strong>${safeText(it.ItemName)}</strong><span class="mono">x${it.Qty??1}</span>
        </div>
        <div class="muted">${it.SpecialInstr?it.SpecialInstr:'No modifications'}</div>`;
      itemsEl.appendChild(div);
    });

    renderStepperModal(header.Status);

    const cancelBtn=document.getElementById('cancelBtn');
    cancelBtn.onclick=async()=>{ 
      try{
        cancelBtn.disabled=true;
        await patchJSON(API.cancel(header.OrderID), { UserID: 4, Comment: 'Cancelled from nurse view' });
        await refreshAll();
        closeModal();
      } finally { cancelBtn.disabled=false; }
    };

    openModal();
  }

  /* Load */
  async function loadOrders(){ const raw=await getJSON(API.list); orders=Array.isArray(raw)?raw.map(normRow):[]; }
  async function refreshAll(){ await loadOrders(); if(currentTab!=='order') renderLists(); }

  /* Boot */
  document.addEventListener('DOMContentLoaded', async ()=>{
    setAuto(localStorage.getItem(AUTO_KEY)==='1');
    await refreshAll();
    updateTabs();
    renderView();
  });
  document.getElementById('q').addEventListener('input', ()=>{ if(currentTab!=='order') renderLists(); });
</script>
</body>
</html>
