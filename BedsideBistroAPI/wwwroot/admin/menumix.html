<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BedsideBistro - Menu Mix</title>
  <link rel="stylesheet" href="global.css" />
  <style>
    :root {
      --mm-bg: #f4f7f6;
      --mm-surface: #ffffff;
      --mm-border-subtle: #d5e1dc;
      --mm-border-strong: #c1d1ca;
      --mm-text-main: #123127;
      --mm-text-muted: #6b7e77;
      --mm-accent: #2f7d5f;
      --mm-accent-soft: #e6f4ed;
    }

    body.menumix {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--mm-bg);
      color: var(--mm-text-main);
      margin: 0;
      min-height: 100vh;
    }

    main {
      max-width: 1080px;
      margin: 1.75rem auto 2.5rem;
      padding: 1.5rem 1.5rem 2rem;
      background: var(--mm-surface);
      border-radius: 16px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.06);
      box-sizing: border-box;
    }

    /* Header area */

    .page-head {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid var(--mm-border-subtle);
      padding-bottom: 0.75rem;
    }

    .page-head h1 {
      margin: 0 0 0.25rem;
      font-size: 1.6rem;
      letter-spacing: 0.01em;
    }

    .page-head__meta-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .page-head__meta-label {
      font-size: 0.85rem;
      color: var(--mm-text-muted);
    }

    .page-head__chip {
      font-size: 0.78rem;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      border: 1px solid var(--mm-border-subtle);
      background: var(--mm-accent-soft);
      color: var(--mm-text-main);
    }

    /* Buttons */

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 120ms ease, border-color 120ms ease, box-shadow 120ms ease, transform 80ms ease;
    }

    .btn.primary {
      background: var(--mm-accent);
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(47, 125, 95, 0.28);
    }

    .btn.primary:hover {
      background: #25624b;
      box-shadow: 0 6px 16px rgba(47, 125, 95, 0.4);
      transform: translateY(-1px);
    }

    .btn.primary:active {
      box-shadow: none;
      transform: translateY(0);
    }

    .btn.ghost {
      background: #ffffff;
      border-color: var(--mm-border-subtle);
      color: var(--mm-text-main);
    }

    .btn.ghost:hover {
      background: #f3f7f5;
      border-color: var(--mm-border-strong);
    }

    .btn-sm {
      padding: 0.25rem 0.7rem;
      font-size: 0.8rem;
    }

    /* Filters */

    .filters {
      background: #f9fbfa;
      border-radius: 12px;
      padding: 0.8rem 0.9rem;
      border: 1px solid var(--mm-border-subtle);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 0.8rem;
      align-items: end;
      margin-bottom: 1.1rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.85rem;
    }

    .field label {
      font-weight: 600;
      color: #23463b;
    }

    .field input[type="date"],
    .field input[type="text"] {
      padding: 0.35rem 0.55rem;
      border-radius: 10px;
      border: 1px solid var(--mm-border-subtle);
      font-size: 0.88rem;
      background: #ffffff;
      min-height: 2.1rem;
      box-sizing: border-box;
    }

    .field input:focus {
      outline: 2px solid var(--mm-accent);
      outline-offset: 1px;
      border-color: var(--mm-accent);
    }

    /* Summary cards */

    .summary-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.9rem;
      margin-bottom: 1.2rem;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 0.8rem 0.95rem;
      border: 1px solid var(--mm-border-subtle);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 90px;
    }

    .card h2 {
      margin: 0 0 0.25rem;
      font-size: 0.95rem;
    }

    .card small {
      color: var(--mm-text-muted);
      font-size: 0.78rem;
    }

    .metric {
      font-size: 1.4rem;
      font-weight: 700;
      margin-top: 0.4rem;
    }

    /* Table section */

    .table-wrap {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--mm-border-subtle);
      overflow: hidden;
    }

    .table-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.9rem;
      border-bottom: 1px solid #e3eee9;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }

    .muted {
      color: var(--mm-text-muted);
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .search-box input {
      width: 190px;
      padding: 0.3rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--mm-border-subtle);
      font-size: 0.85rem;
      min-height: 2rem;
    }

    .search-box input:focus {
      outline: 2px solid var(--mm-accent);
      border-color: var(--mm-accent);
    }

    .table-scroll {
      max-height: 480px;
      overflow: auto;
    }

    table.menumix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.86rem;
    }

    table.menumix-table thead {
      position: sticky;
      top: 0;
      background: #f5faf7;
      z-index: 1;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.04);
    }

    table.menumix-table th,
    table.menumix-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid #edf3f0;
    }

    table.menumix-table th {
      font-weight: 600;
      font-size: 0.8rem;
      color: #345348;
      white-space: nowrap;
    }

    table.menumix-table tbody tr:nth-child(even) {
      background: #fafdfc;
    }

    table.menumix-table tbody tr:hover {
      background: #edf6f1;
    }

    .col-name {
      width: 60%;
    }

    .col-qty,
    .col-share {
      text-align: right;
      white-space: nowrap;
    }

    .empty-state {
      padding: 1.5rem;
      text-align: center;
      font-size: 0.9rem;
      color: var(--mm-text-muted);
    }

    .sortable {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      background: none;
      border: none;
      font: inherit;
      padding: 0;
      color: inherit;
    }

    .sortable .sort-indicator {
      font-size: 0.7rem;
      opacity: 0.55;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    @media (max-width: 640px) {
      main {
        margin: 0.75rem;
        padding: 1rem 0.9rem 1.5rem;
      }

      .filters {
        grid-template-columns: 1fr;
      }

      .search-box input {
        width: 140px;
      }
    }
  </style>
</head>
<body class="menumix">
  <a href="#content" class="sr-only">Skip to content</a>

  <main id="content" tabindex="-1">
    <div class="page-head">
      <div>
        <h1>Menu Mix</h1>
        <div class="page-head__meta-wrap">
          <span class="page-head__meta-label">Current view</span>
          <span class="page-head__chip" id="summaryRangeLabel">
            Showing last 7 days
          </span>
        </div>
      </div>
      <button type="button" class="btn ghost btn-sm" id="btnExportCsv">Export CSV</button>
    </div>

    <!-- Filters -->
    <section class="filters" aria-label="Menu mix filters">
      <div class="field">
        <label for="dtFrom">From date</label>
        <input type="date" id="dtFrom" />
      </div>
      <div class="field">
        <label for="dtTo">To date</label>
        <input type="date" id="dtTo" />
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button type="button" class="btn primary" id="btnRun">Run menu mix</button>
      </div>
    </section>

    <!-- Summary cards -->
    <section class="summary-row" aria-label="Menu mix summary">
      <article class="card">
        <h2>Total items sold</h2>
        <small>Filtered range, delivered items only</small>
        <div class="metric" id="metricTotalQty">0</div>
      </article>

      <article class="card">
        <h2>Unique items</h2>
        <small>Only items with quantity greater than zero</small>
        <div class="metric" id="metricUniqueItems">0</div>
      </article>

      <article class="card">
        <h2>Top seller</h2>
        <small id="metricTopLabel">No data</small>
        <div class="metric" id="metricTopQty">0</div>
      </article>
    </section>

    <!-- Table -->
    <section class="table-wrap" aria-label="Menu mix details">
      <div class="table-toolbar">
        <div class="muted">
          <span id="rowCountLabel">0 items</span>
        </div>
        <div class="search-box">
          <label for="txtSearch" class="sr-only">Search menu items</label>
          <input type="text" id="txtSearch" placeholder="Search item name" />
          <button type="button" class="btn ghost btn-sm" id="btnClearSearch">Clear</button>
        </div>
      </div>

      <div class="table-scroll">
        <table class="menumix-table" aria-describedby="summaryRangeLabel">
          <thead>
            <tr>
              <th class="col-name">Item</th>
              <th class="col-qty">
                <button type="button" class="sortable" data-sort="qty">
                  Qty sold
                  <span class="sort-indicator" id="sortQtyIndicator">▼</span>
                </button>
              </th>
              <th class="col-share">
                <button type="button" class="sortable" data-sort="share">
                  % of mix
                  <span class="sort-indicator" id="sortShareIndicator"></span>
                </button>
              </th>
            </tr>
          </thead>
          <tbody id="mixBody">
            <tr>
              <td colspan="3" class="empty-state">
                Run the report to see your menu mix.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- JS is identical to your working version -->

  <script>
    // Simple mapping for the API rows
    function mapMenuMixItem(raw) {
      var id =
        raw.menuItemID || raw.menuItemId || raw.MenuItemID || raw.id || null;
      var name =
        raw.itemName || raw.ItemName || raw.strItemName || raw.name || "";
      var qty =
        Number(raw.totalSold || raw.TotalSold || raw.qtySold || 0);

      return { id: id, name: name, qtySold: qty };
    }

    var currentData = [];
    var currentSort = { key: "qtySold", dir: "desc" };

    document.addEventListener("DOMContentLoaded", function () {
      var dtFrom = document.getElementById("dtFrom");
      var dtTo = document.getElementById("dtTo");
      var btnRun = document.getElementById("btnRun");
      var txtSearch = document.getElementById("txtSearch");
      var btnClearSearch = document.getElementById("btnClearSearch");
      var btnExportCsv = document.getElementById("btnExportCsv");

      // default range - last 7 days
      var today = new Date();
      var sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 6);

      dtTo.value = toIsoDate(today);
      dtFrom.value = toIsoDate(sevenDaysAgo);

      updateRangeLabel();

      btnRun.addEventListener("click", function () {
        runReport();
      });

      txtSearch.addEventListener("input", function () {
        renderTable();
      });

      btnClearSearch.addEventListener("click", function () {
        txtSearch.value = "";
        renderTable();
      });

      var sortButtons = document.querySelectorAll(".sortable");
      for (var i = 0; i < sortButtons.length; i++) {
        sortButtons[i].addEventListener("click", function (evt) {
          var key = evt.currentTarget.getAttribute("data-sort");
          handleSortClick(key);
        });
      }

      btnExportCsv.addEventListener("click", exportCsv);

      // initial load
      runReport();
    });

    function toIsoDate(date) {
      var y = date.getFullYear();
      var m = String(date.getMonth() + 1).padStart(2, "0");
      var d = String(date.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }

    function formatDisplayDateFromIso(iso) {
      // "2025-11-18" -> "11-18-2025"
      var parts = iso.split("-");
      return parts[1] + "-" + parts[2] + "-" + parts[0];
    }

    function formatDisplayDate(date) {
      var m = String(date.getMonth() + 1).padStart(2, "0");
      var d = String(date.getDate(), 10).padStart(2, "0");
      var y = date.getFullYear();
      return m + "-" + d + "-" + y;
    }

    function updateRangeLabel() {
      var fromVal = document.getElementById("dtFrom").value;
      var toVal = document.getElementById("dtTo").value;
      var label = document.getElementById("summaryRangeLabel");

      if (!fromVal || !toVal) {
        label.textContent = "Showing selected range";
        return;
      }

      var fromDisplay = formatDisplayDateFromIso(fromVal);
      var toDisplay = formatDisplayDateFromIso(toVal);
      label.textContent = "Showing " + fromDisplay + " to " + toDisplay;
    }

    function runReport() {
      var dtFrom = document.getElementById("dtFrom").value;
      var dtTo = document.getElementById("dtTo").value;
      var tbody = document.getElementById("mixBody");

      updateRangeLabel();

      tbody.innerHTML =
        '<tr><td colspan="3" class="empty-state">Loading menu mix...</td></tr>';

      var url = new URL("/api/reports/menumix", window.location.origin);
      if (dtFrom) url.searchParams.set("from", dtFrom);
      if (dtTo) {
        // send next day so API "< @to" is inclusive on UI
        var toDate = new Date(dtTo);
        toDate.setDate(toDate.getDate() + 1);
        url.searchParams.set("to", toIsoDate(toDate));
      }

      fetch(url.toString(), { headers: { Accept: "application/json" } })
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (data) {
          var list = Array.isArray(data) ? data : [];
          currentData = [];

          for (var i = 0; i < list.length; i++) {
            var item = mapMenuMixItem(list[i]);
            if (item.qtySold > 0) currentData.push(item);
          }

          currentSort = { key: "qtySold", dir: "desc" };
          updateSortIndicators();
          renderTable();
        })
        .catch(function (err) {
          console.error("Menu mix fetch failed", err);
          tbody.innerHTML =
            '<tr><td colspan="3" class="empty-state">Could not load menu mix. Please check the API and try again.</td></tr>';
          setSummaryMetrics([]);
        });
    }

    function renderTable() {
      var tbody = document.getElementById("mixBody");
      var searchText = document
        .getElementById("txtSearch")
        .value.trim()
        .toLowerCase();
      var rowCountLabel = document.getElementById("rowCountLabel");

      var rows = currentData.slice();

      if (searchText) {
        rows = rows.filter(function (x) {
          var name = x.name || "";
          return name.toLowerCase().indexOf(searchText) >= 0;
        });
      }

      rows.sort(function (a, b) {
        var key = currentSort.key;
        var va, vb;

        if (key === "qtySold") {
          va = a.qtySold;
          vb = b.qtySold;
        } else if (key === "share") {
          var totals = getTotals();
          var totalQty = totals.totalQty || 1;
          va = a.qtySold / totalQty;
          vb = b.qtySold / totalQty;
        } else {
          va = 0;
          vb = 0;
        }

        if (va === vb) {
          var an = a.name || "";
          var bn = b.name || "";
          return an.localeCompare(bn);
        }

        return currentSort.dir === "desc" ? vb - va : va - vb;
      });

      if (!rows.length) {
        tbody.innerHTML =
          '<tr><td colspan="3" class="empty-state">No items found for this range.</td></tr>';
        rowCountLabel.textContent = "0 items";
        setSummaryMetrics(rows);
        return;
      }

      var totals = getTotals(rows);
      var totalQty = totals.totalQty || 1;

      var html = "";
      for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var share = (row.qtySold / totalQty) * 100;

        html +=
          "<tr>" +
          '<td class="col-name">' + escapeHtml(row.name || "") + "</td>" +
          '<td class="col-qty">' + row.qtySold.toLocaleString() + "</td>" +
          '<td class="col-share">' + share.toFixed(1) + "%</td>" +
          "</tr>";
      }

      tbody.innerHTML = html;
      rowCountLabel.textContent = rows.length + " items";
      setSummaryMetrics(rows);
    }

    function getTotals(rows) {
      if (!rows) rows = currentData;
      var totalQty = 0;
      for (var i = 0; i < rows.length; i++) {
        totalQty += rows[i].qtySold || 0;
      }
      return { totalQty: totalQty };
    }

    function setSummaryMetrics(rows) {
      var metricTotalQty = document.getElementById("metricTotalQty");
      var metricUniqueItems = document.getElementById("metricUniqueItems");
      var metricTopLabel = document.getElementById("metricTopLabel");
      var metricTopQty = document.getElementById("metricTopQty");

      var list = rows && rows.length ? rows.slice() : [];
      var totals = getTotals(list);

      metricTotalQty.textContent = totals.totalQty.toLocaleString();
      metricUniqueItems.textContent = String(list.length);

      if (!list.length) {
        metricTopLabel.textContent = "No data";
        metricTopQty.textContent = "0";
        return;
      }

      list.sort(function (a, b) {
        return b.qtySold - a.qtySold;
      });
      var top = list[0];

      metricTopLabel.textContent = "Top selling item";
      var qtyText = top.qtySold.toLocaleString();
      var nameText = top.name || "";
      metricTopQty.textContent = qtyText + " - " + nameText;
    }

    function handleSortClick(key) {
      if (key === "qty") key = "qtySold";

      if (currentSort.key === key) {
        currentSort.dir = currentSort.dir === "desc" ? "asc" : "desc";
      } else {
        currentSort = { key: key, dir: "desc" };
      }
      updateSortIndicators();
      renderTable();
    }

    function updateSortIndicators() {
      var qty = document.getElementById("sortQtyIndicator");
      var share = document.getElementById("sortShareIndicator");

      qty.textContent = "";
      share.textContent = "";

      var target = null;
      if (currentSort.key === "qtySold") target = qty;
      else if (currentSort.key === "share") target = share;

      if (target) {
        target.textContent = currentSort.dir === "desc" ? "▼" : "▲";
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function exportCsv() {
      if (!currentData.length) {
        alert("No data to export.");
        return;
      }

      var header = ["Name", "QtySold", "PercentOfMix"];
      var rows = [];
      var totals = getTotals();
      var totalQty = totals.totalQty || 1;

      var list = currentData.slice().sort(function (a, b) {
        return b.qtySold - a.qtySold;
      });

      for (var i = 0; i < list.length; i++) {
        var row = list[i];
        var share = (row.qtySold / totalQty) * 100;
        rows.push([
          cleanCsv(row.name),
          row.qtySold,
          share.toFixed(2)
        ]);
      }

      var today = new Date();
      var fileDate = formatDisplayDate(today); // MM-DD-YYYY
      var csvLines = [header.join(",")];
      for (var r = 0; r < rows.length; r++) {
        csvLines.push(rows[r].join(","));
      }

      var blob = new Blob([csvLines.join("\n")], {
        type: "text/csv;charset=utf-8;"
      });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "MenuMix_" + fileDate + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function cleanCsv(value) {
      var str = String(value || "");
      if (
        str.indexOf(",") >= 0 ||
        str.indexOf('"') >= 0 ||
        str.indexOf("\n") >= 0
      ) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }
  </script>
</body>
</html>
