<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BedsideBistro â€” Kitchen</title>
  <link rel="stylesheet" href="global.css" />
  <style>
    body.kitchenview{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 600px at 80% -10%,var(--brand-050),transparent 60%),var(--bg);
      color:var(--text);margin:0;line-height:1.45}
    .layout{display:grid;grid-template-columns:0.95fr 1.05fr;gap:18px;margin:18px 0 28px}
    @media(max-width:900px){.layout{grid-template-columns:1fr}}
    .panel,.detail{background:var(--surface);border:1px solid var(--outline);border-radius:18px;box-shadow:var(--shadow-soft);overflow:hidden}
    .pad{padding:14px 14px 18px}
    .list{display:grid;gap:12px}
    .cell{border:2px solid var(--outline);border-radius:16px;background:#fff;padding:10px;display:grid;gap:8px;cursor:pointer;transition:box-shadow .2s}
    .cell:hover{box-shadow:0 10px 22px rgba(0,0,0,.08)}
    .cell.selected{outline:3px solid #8fd6b9}
    .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .pill{font-size:.85rem;padding:6px 9px;border-radius:999px;border:1px dashed var(--outline);background:#fbfefd}
    .steps{position:relative;padding:8px 4px 0}
    .steps::before{content:"";position:absolute;left:18px;right:18px;top:14px;height:4px;background:#e8efe9;border-radius:999px}
    .steps .track{position:absolute;left:18px;top:14px;height:4px;background:linear-gradient(90deg,var(--brand),var(--brand-600));border-radius:999px;width:0;transition:width .3s}
    .steps .row{position:relative;display:flex;justify-content:space-between}
    .step{display:grid;justify-items:center;gap:6px}
    .dot{width:20px;height:20px;border-radius:50%;display:grid;place-items:center;background:#fff;border:2px solid #cfe5db;color:#2f7d5f;font-size:.75rem;font-weight:800}
    .done .dot{background:linear-gradient(135deg,var(--brand),var(--brand-600));color:#fff;border-color:transparent}
    .active .dot{border-color:#2f7d5f}
    .label{font-size:.76rem;color:#5f6a66;white-space:nowrap}
    .cardish{border:1px solid var(--outline);border-radius:16px;padding:12px;background:#fff}
    .kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .items{display:grid;gap:8px}
    .cta{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{appearance:none;border:1px solid var(--outline);background:#fff;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-600));border-color:transparent;color:#fff}
    .btn.danger{border-color:#e7b0b0;color:#8b2323}
	/* Keep Kitchen View width consistent with the rest of the app */
	.kitchenview .container {
	  width: min(1200px, 92vw);
	  margin: 0 auto;
	  padding-left: 16px;
	  padding-right: 16px;
	}
	
    /* Tabs */
    .tabs{display:flex;gap:.6rem;flex-wrap:wrap;padding:10px;border-radius:var(--radius-lg);background:rgba(255,255,255,.6);border:1px solid var(--outline);box-shadow:var(--shadow-soft);margin-bottom:10px}
    .tab{appearance:none;background:var(--tab);color:var(--muted);border:1px solid var(--border);border-radius:999px;font-weight:700;font-size:.9rem;line-height:1.2;padding:10px 14px;cursor:pointer;transition:transform .08s ease, background .2s ease, color .2s ease}
    .tab:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{background:var(--brand);color:#fff;border-color:var(--brand);box-shadow:0 6px 14px rgba(47,125,95,.25)}
    /* Settings dropdown */
    .settings{position:relative}
    .settings-menu{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--outline);border-radius:12px;box-shadow:var(--shadow-card);padding:10px;min-width:200px;display:none}
    .settings.open .settings-menu{display:block}
    /* Debug */
    #fabDebug{position:fixed;right:16px;bottom:16px;z-index:98;border-radius:999px;padding:10px 14px;background:var(--brand);color:#fff;border:0;cursor:pointer;box-shadow:var(--shadow-card)}
    .debug{position:fixed;left:16px;right:16px;bottom:64px;background:#0e1512;color:#e7fff6;border:1px solid #224b3a;border-radius:12px;padding:10px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:97}
    .debug[hidden]{display:none}
    .debug h4{margin:0 0 6px}
    .debug pre{max-height:220px;overflow:auto;background:#09110e;padding:10px;border-radius:8px}
    .debug small{color:#bde7d7}

  .cardish.scrollable {
    display: flex;
    flex-direction: column;
    max-height: 400px; /* adjust to your preference */
  }

  .cardish.scrollable .items {
    flex: 1 1 auto;
    overflow-y: auto;
    gap: 8px;
    margin-top: 10px;
  }

  .panel {
    max-height: 800px; /* adjust as needed */
  }

  .panel .pad {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* Make ticket list scrollable */
  #ticketList {
    max-height: 500px; /* adjust to your preferred visible height */
    overflow-y: auto; /* vertical scroll */
    overflow-x: hidden; /* prevent horizontal scroll */
    padding-right: 8px; /* optional: avoid content being hidden behind scrollbar */
  }

  /* Optional: style the scrollbar for modern browsers */
  #ticketList::-webkit-scrollbar {
    width: 8px;
  }

  #ticketList::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  #ticketList::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }

  #ticketList::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  </style>
</head>
<body class="kitchenview">

<!-- Header matches global style -->
<header class="site-header">
  <div class="container site-header__bar" role="navigation" aria-label="Top">
      <a class="site-brand" href="index.html">
        <img src="BedsideBistro_Small.svg" alt="BedsideBistro" class="site-brand__img" />
        <span class="site-brand__text">BedsideBistro</span>
      </a>

    <label class="site-search" aria-label="Search orders">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
      <input id="q" type="search" placeholder="Search orders, patients, roomsâ€¦" />
    </label>
  

    <!-- Settings dropdown trigger (right side of header) -->
    <div class="settings" id="settingsBox">
      <button class="site-profile" aria-label="Settings" id="settingsBtn">
        <div class="site-avatar" aria-hidden="true">
          <!-- crisp gear (stroke-based) -->
        <svg fill="#2f7d5f" height="200px" width="200px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 490 490" xml:space="preserve" stroke="#2f7d5f"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="XMLID_891_"> <g> <g> <path d="M490,305V185h-69.964c-2.498-7.291-5.453-14.42-8.844-21.34l49.475-49.475l-84.853-84.853L326.34,78.807 c-6.919-3.39-14.051-6.345-21.34-8.843V0H185v69.964c-7.29,2.498-14.42,5.453-21.34,8.843l-49.475-49.475l-84.853,84.853 l49.475,49.475c-3.391,6.92-6.345,14.05-8.843,21.34H0v120h69.964c2.498,7.291,5.453,14.42,8.843,21.34l-49.475,49.475 l84.853,84.853l49.475-49.475c6.92,3.391,14.05,6.345,21.34,8.843V490h120v-69.964c7.29-2.498,14.42-5.453,21.34-8.843 l49.475,49.475l84.853-84.853l-49.475-49.475c3.391-6.919,6.346-14.05,8.844-21.34H490z M418.241,375.815l-42.427,42.426 l-44.187-44.186l-9.944,5.673c-11.206,6.394-23.199,11.364-35.646,14.772L275,397.523V460h-60v-62.477l-11.039-3.022 c-12.445-3.408-24.438-8.378-35.646-14.772l-9.944-5.673l-44.186,44.186l-42.426-42.426l44.186-44.186l-5.673-9.944 c-6.394-11.206-11.364-23.199-14.772-35.646L92.478,275H30v-60h62.478l3.022-11.039c3.408-12.445,8.377-24.438,14.771-35.645 l5.674-9.944l-44.187-44.187l42.426-42.426l44.187,44.187l9.944-5.674c11.207-6.394,23.2-11.364,35.645-14.771L215,92.478V30h60 v62.478l11.039,3.022c12.446,3.408,24.438,8.378,35.645,14.771l9.944,5.674l44.187-44.187l42.427,42.426l-44.187,44.187 l5.674,9.944c6.393,11.205,11.363,23.198,14.772,35.646L397.523,215H460v60h-62.477l-3.022,11.038 c-3.409,12.447-8.38,24.44-14.772,35.646l-5.674,9.944L418.241,375.815z"></path> <path d="M245,150c-52.383,0-95,42.617-95,95s42.617,95,95,95s95-42.617,95-95S297.383,150,245,150z M245,310 c-35.841,0-65-29.159-65-65s29.159-65,65-65s65,29.159,65,65S280.841,310,245,310z"></path> </g> </g> </g> </g></svg>        </div>
      </button>
      

      <div class="settings-menu" id="settingsMenu">
        <label style="display:flex;align-items:center;gap:.5rem">
          <input id="autoToggle" type="checkbox" /> Auto-refresh every 15s
        </label>
      </div>
    </div>


    <!-- User/profile button (kept for symmetry) -->
    <button class="site-profile" aria-label="Kitchen profile">
      <div class="site-avatar" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="20" height="20">
          <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5.006 5.006 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"/>
        </svg>
      </div>
    </button>
    </div>
  </div>
</header>

<main class="container">
  <div class="layout">
    <!-- LEFT: Tickets + tabs -->
    <section class="panel">
      <div class="pad">
        <nav class="tabs" aria-label="Ticket filters">
          <button class="tab" id="tab-open"      aria-current="page">Open Tickets (0)</button>
          <button class="tab" id="tab-closed"    aria-current="false">Closed Tickets (0)</button>
          <button class="tab" id="tab-cancelled" aria-current="false">Cancelled Tickets (0)</button>
        </nav>

        <div class="section-head">
          <h2 id="listTitle">Open tickets</h2>
          <div class="muted" id="countHint"></div>
        </div>

        <div id="ticketList" class="list" role="list"></div>
      </div>
    </section>

    <!-- RIGHT: Selected order -->
    <aside class="detail">
      <div class="pad">
        <div class="section-head">
          <h2>Order summary</h2>
        </div>

        <div class="cardish scrollable" id="summaryCard">
          <div class="kv">
            <strong id="pTitle">â€”</strong>
            <span class="pill" id="pRoom">Room â€”</span>
          </div>

          <div class="steps" style="margin-top:10px">
            <div class="track" id="track"></div>
            <div class="row" id="stepsRow"></div>
          </div>

          <!-- Scrollable items section -->
          <div class="items" id="items" style="margin-top:10px; flex:1 1 auto; overflow-y:auto; gap:8px;"></div>

          <div class="kv" style="margin-top:10px">
            <span class="muted">Notes</span>
            <span id="noteLine" class="mono">â€”</span>
          </div>
        </div>

        <div class="cta" id="actions" style="margin-top:10px"></div>
      </div>
    </aside>
  </div>
</main>

<!-- Toast + Debug -->
<div id="toast" class="toast">Saved</div>
<button id="fabDebug">Debug</button>
<section id="debug" class="debug" hidden>
  <h4>Debug console</h4>
  <div><small id="dbgMeta">â€”</small></div>
  <details open><summary>Last network entry</summary><pre id="dbgNet">{}</pre></details>
  <details><summary>Last payload / error</summary><pre id="dbgData">{}</pre></details>

  <div style="margin-bottom:12px; display:flex; gap:8px;">
    <button id="addFakeBtn" class="btn primary">Add Fake Order</button>
    <button id="addFakeCanceledBtn" class="btn danger">Add Fake Canceled Order</button>
    <button id="addFakeCompletedBtn" class="btn">Add Fake Completed Order</button>
  </div>
</section>

<script>
  // ---------- Settings dropdown ----------
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsBox = document.getElementById("settingsBox");
  settingsBtn.addEventListener("click",()=>settingsBox.classList.toggle("open"));
  document.addEventListener("click",e=>{ if(!settingsBox.contains(e.target)) settingsBox.classList.remove("open"); });

  // ---------- Toast + Debug ----------
  const toast = t => { const el=document.getElementById("toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1200); };
  document.getElementById("fabDebug").addEventListener("click",()=>{ const box=document.getElementById("debug"); box.hidden=!box.hidden; });

  function dbgNet(o){ document.getElementById("dbgNet").textContent=JSON.stringify(o,null,2); document.getElementById("dbgMeta").textContent=`last: ${new Date().toLocaleTimeString()} â€¢ ${o.method||''} ${o.url||''} â€¢ status ${o.status??'â€”'}`; console.log('[NET]',o); }
  function dbgData(o){ document.getElementById("dbgData").textContent = (typeof o==='string') ? o : JSON.stringify(o,null,2); console.log('[DATA]',o); }

  // ---------- API base ----------
  const urlParams=new URLSearchParams(location.search);
  const API_BASE=urlParams.get('api')||'';
  const api=(p)=>API_BASE+p;

  const API={
    list:api('/api/orders'),
    show:id=>api(`/api/orders/${id}`),
    statuses:api('/api/orderstatus'),
    setStatus:id=>api(`/api/orders/${id}/status`),
    cancel:id=>api(`/api/orders/${id}/cancel`)
  };

  // ---------- Autorefresh ----------
  let refreshTimer=null;
  const AUTO_KEY='bb_kitchen_autorefresh';
  function startAuto(){ stopAuto(); refreshTimer=setInterval(()=>refreshAll(selectedId),15000); }
  function stopAuto(){ if(refreshTimer){ clearInterval(refreshTimer); refreshTimer=null; } }
  function setAuto(enabled){
    document.getElementById('autoToggle').checked=!!enabled;
    localStorage.setItem(AUTO_KEY, enabled?'1':'0');
    enabled?startAuto():stopAuto();
  }
  document.getElementById('autoToggle').addEventListener('change',e=>setAuto(e.target.checked));

  // ---------- Tabs ----------
 // ---------- Tabs ----------
const tabs = {
  open: document.getElementById('tab-open'),
  closed: document.getElementById('tab-closed'),
  cancelled: document.getElementById('tab-cancelled')
};
let currentTab = 'open'; // 'open' | 'closed' | 'cancelled'

Object.entries(tabs).forEach(([k, el]) => {
  el.addEventListener('click', () => {
    // Change tab
    currentTab = k;
    updateTabStates();
    renderList();

    // ðŸ”¹ Clear selection and close summary when switching tabs
    selectedId = null;
    orderDetail = null;
    renderDetail();
  });
});

  function updateTabStates(){
    tabs.open.setAttribute('aria-current', currentTab==='open'?'page':'false');
    tabs.closed.setAttribute('aria-current', currentTab==='closed'?'page':'false');
    tabs.cancelled.setAttribute('aria-current', currentTab==='cancelled'?'page':'false');
    document.getElementById('listTitle').textContent =
      currentTab==='open'?'Open tickets':
      currentTab==='closed'?'Closed tickets':'Cancelled tickets';
  }

  // ---------- Data & helpers ----------
  let orders=[];          // normalized rows (list)
  let selectedId=null;    // int
  let orderDetail=null;   // {header, items}
  let STATUS_MAP=[];      // [{Id,Name}]

  const $ = (s)=>document.querySelector(s);
  const pick=(o,...keys)=>{for(const k of keys){if(o&&o[k]!==undefined&&o[k]!==null)return o[k];}};
  function normalizeOrderRow(r){ return {
    OrderID: pick(r,'OrderID','orderID','orderId','id'),
    PatientName: pick(r,'PatientName','patientName','patient'),
    RoomNumber: pick(r,'RoomNumber','roomNumber','room'),
    MealPeriod: pick(r,'MealPeriod','mealPeriod','meal'),
    Status: pick(r,'Status','status'),
    PlacedOn: pick(r,'PlacedOn','placedOn','placed'),
    MRN: pick(r,'MRN','mrn'), Notes: pick(r,'Notes','notes')
  }; }
  function normalizeHeader(h){ return {
    OrderID: pick(h,'OrderID','orderID','orderId','id'),
    MRN: pick(h,'MRN','mrn'),
    PatientName: pick(h,'PatientName','patientName'),
    RoomNumber: pick(h,'RoomNumber','roomNumber'),
    MealPeriod: pick(h,'MealPeriod','mealPeriod'),
    Status: pick(h,'Status','status'),
    PlacedOn: pick(h,'PlacedOn','placedOn'),
    RequestedFor: pick(h,'RequestedFor','requestedFor'),
    DeliveredOn: pick(h,'DeliveredOn','deliveredOn'),
    Notes: pick(h,'Notes','notes')
  }; }
  function normalizeItem(it){ return {
    OrderItemID: pick(it,'OrderItemID','orderItemID','orderItemId','intOrderItemID'),
    MenuItemID: pick(it,'MenuItemID','menuItemID','menuItemId','intMenuItemID'),
    ItemName: pick(it,'ItemName','itemName','strItemName'),
    Qty: pick(it,'Qty','qty','intQty'),
    SpecialInstr: pick(it,'SpecialInstr','specialInstr','strSpecialInstr')
  }; }
  function normalizeStatus(s){ return { Id: pick(s,'Id','id'), Name: pick(s,'Name','name') }; }

  function safeText(v){ return (v===null||v===undefined)?'â€”':String(v); }
  function safeTime(v){ const d=new Date(v); return isNaN(d.getTime())?'â€”':d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
  function stepIndex(status){
    switch((status||'').toLowerCase()){
      case 'placed': return 0; case 'in kitchen': return 1; case 'ready': return 2; case 'delivered': return 3; default: return 0;
    }
  }

  // ---------- Network ----------
  async function apiGet(url){
    const t=Date.now(); const r=await fetch(url); dbgNet({url,method:'GET',status:r.status,ms:Date.now()-t});
    if(!r.ok) throw new Error(await r.text());
    const data=await r.json(); dbgData(data); return data;
  }
  async function apiPut(url, body){
    const t=Date.now(); const r=await fetch(url,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    dbgNet({url,method:'PUT',status:r.status,ms:Date.now()-t,body}); if(!r.ok&&r.status!==204) throw new Error(await r.text());
    return r.status===204?null:await r.json();
  }
  async function apiPatch(url, body){
    const t=Date.now(); const r=await fetch(url,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    dbgNet({url,method:'PATCH',status:r.status,ms:Date.now()-t,body}); if(!r.ok&&r.status!==204) throw new Error(await r.text());
    return r.status===204?null:await r.json();
  }

  // ---------- Rendering LEFT ----------
  function filteredOrders(){
    const q=($('#q').value||'').trim().toLowerCase();
    const byTab = currentTab==='open'
      ? orders.filter(o=>o.Status!=='Delivered' && o.Status!=='Cancelled')
      : currentTab==='closed'
        ? orders.filter(o=>o.Status==='Delivered')
        : orders.filter(o=>o.Status==='Cancelled');

    const out = q
      ? byTab.filter(o=>String(o.RoomNumber||'').toLowerCase().includes(q)
                     || String(o.MRN||'').toLowerCase().includes(q)
                     || String(o.PatientName||'').toLowerCase().includes(q))
      : byTab;

    return out;
  }

  function updateTabCounts(){
    const openCount      = orders.filter(o=>o.Status!=='Delivered' && o.Status!=='Cancelled').length;
    const closedCount    = orders.filter(o=>o.Status==='Delivered').length;
    const cancelledCount = orders.filter(o=>o.Status==='Cancelled').length;
    tabs.open.textContent      = `Open Tickets (${openCount})`;
    tabs.closed.textContent    = `Closed Tickets (${closedCount})`;
    tabs.cancelled.textContent = `Cancelled Tickets (${cancelledCount})`;
  }

  function renderList(){
    updateTabStates();
    const data = filteredOrders();
    updateTabCounts();

    const list = document.getElementById('ticketList'); list.innerHTML='';

    data.forEach(o=>{
      const placedStr=safeTime(o.PlacedOn);
      const cell=document.createElement('article');
      cell.className='cell'; cell.dataset.id=o.OrderID; cell.setAttribute('role','listitem');

      cell.innerHTML = `
        <div class="meta">
          <span class="name">${safeText(o.PatientName)}</span>
          <span class="pill">Room ${safeText(o.RoomNumber)}</span>
        </div>
        <div class="muted mono">${safeText(o.MealPeriod)||'â€”'} â€¢ Placed ${placedStr}</div>
        <div class="steps" aria-label="Order status">
          <div class="track"></div>
          <div class="row">
            ${['Placed','In Kitchen','Ready','Delivered'].map((label,i)=>{
              const idx=stepIndex(o.Status);
              const cls=i<idx?'step done':(i===idx?'step active':'step');
              return `<div class="${cls}"><div class="dot">${i+1}</div><div class="label">${label}</div></div>`;
            }).join('')}
          </div>
        </div>`;

      const pct=(stepIndex(o.Status)/(4-1))*100;
      cell.querySelector('.track').style.width=`calc(${pct}% - 18px)`;
      cell.addEventListener('click',()=>selectOrder(o.OrderID));
      list.appendChild(cell);
    });

    // Keep selected highlight if still visible
    [...document.querySelectorAll('.cell')].forEach(c=>c.classList.toggle('selected', Number(c.dataset.id)===selectedId));
  }

  // ---------- Rendering RIGHT ----------
  function renderStepper(status){
    const row=document.getElementById('stepsRow');
    row.innerHTML=['Placed','In Kitchen','Ready','Delivered'].map((label,i)=>{
      const idx=stepIndex(status);
      const cls=i<idx?'step done':(i===idx?'step active':'step');
      return `<div class="${cls}"><div class="dot">${i+1}</div><div class="label">${label}</div></div>`;
    }).join('');
    const pct=(stepIndex(status)/(4-1))*100;
    document.getElementById('track').style.width=`calc(${pct}% - 18px)`;
  }

  function renderDetail(){
    const h = orderDetail;
    const itemsEl = $('#items');
    const actionsEl = $('#actions');
    const trackEl = $('#track');
    const stepsRow = $('#stepsRow');

    if (!h) {
      $('#pTitle').textContent = 'â€”';
      $('#pRoom').textContent = 'Room â€”';
      $('#noteLine').textContent = 'â€”';
      itemsEl.innerHTML = '';
      actionsEl.innerHTML = '';

      // Clear stepper completely
      trackEl.style.width = '0';
      stepsRow.innerHTML = '';
      return;
    }

    $('#pTitle').textContent = `${safeText(h.header.PatientName)} â€¢ ${safeText(h.header.MRN)}`;
    $('#pRoom').textContent = `Room ${safeText(h.header.RoomNumber)}`;
    $('#noteLine').textContent = h.header.Notes || 'â€”';

    itemsEl.innerHTML = '';
    (h.items || []).forEach(it => {
      const div = document.createElement('div');
      div.className = 'cardish';
      div.innerHTML = `<div class="kv"><strong>${safeText(it.ItemName)}</strong><span class="mono">x${it.Qty ?? 1}</span></div>
                      <div class="muted">${it.SpecialInstr ? it.SpecialInstr : 'No modifications'}</div>`;
      itemsEl.appendChild(div);
    });

    renderStepper(h.header.Status);
    renderActions(h.header.Status);
  }


  function renderActions(status){
    const box=$('#actions'); box.innerHTML='';
    const add=(txt,cls,fn)=>{ const b=document.createElement('button'); b.className=`btn ${cls||''}`; b.textContent=txt; b.onclick=fn; box.appendChild(b); return b; };
    const withBusy=(btn,fn)=>async()=>{ try{btn.disabled=true; await fn();} catch(e){toast('Action failed'); dbgData({actionError:String(e)});} finally{btn.disabled=false;} };

    if(status==='Placed'){
      const a=add('Accept (In Kitchen)','primary',()=>{}); a.onclick=withBusy(a,()=>setStatus('In Kitchen','Accepted by kitchen'));
      const r=add('Rejectâ€¦','danger',()=>{}); r.onclick=withBusy(r,()=>cancelOrder('Rejected by kitchen'));
    }else if(status==='In Kitchen'){
      const r=add('Mark Ready','primary',()=>{}); r.onclick=withBusy(r,()=>setStatus('Ready','Ready for pickup'));
      const c=add('Rejectâ€¦','danger',()=>{}); c.onclick=withBusy(c,()=>cancelOrder('Cancelled during prep'));
    }else if(status==='Ready'){
      const d=add('Mark Delivered','primary',()=>{}); d.onclick=withBusy(d,()=>setStatus('Delivered','Delivered to room', {switchToClosed:true}));
      const c=add('Cancel','danger',()=>{}); c.onclick=withBusy(c,()=>cancelOrder('Cancelled at pass'));
    }else{
      const info=document.createElement('div'); info.className='muted'; info.textContent=status; box.appendChild(info);
    }
  }

  // ---------- Actions ----------
  async function setStatus(targetName, comment, opts={}){
    if(!orderDetail){ toast('No order selected'); return; }
    const status = STATUS_MAP.find(s => (s && (s.Name||s.name)) && String(s.Name??s.name).toLowerCase()===targetName.toLowerCase());
    if(!status){ toast(`Status "${targetName}" not configured`); dbgData({STATUS_MAP}); return; }

    try{
      await apiPut(API.setStatus(orderDetail.header.OrderID), { NewStatusID: status.Id??status.id, UserID: 4, Comment: comment||null });
      if (targetName==='Delivered' && opts.switchToClosed){ currentTab='closed'; updateTabStates(); }
      await refreshAll(orderDetail.header.OrderID);
      toast(`Status â†’ ${targetName}`);
    }catch(e){ dbgData({setStatusError:String(e)}); throw e; }
  }

  async function cancelOrder(comment){
    if(!orderDetail){ toast('No order selected'); return; }
    try{
      await apiPatch(API.cancel(orderDetail.header.OrderID), { UserID: 4, Comment: comment||null });
      await refreshAll();
      toast('Order cancelled');
    }catch(e){ dbgData({cancelError:String(e)}); throw e; }
  }

  // ---------- Load / Select ----------
  async function loadStatuses(){ const raw=await apiGet(API.statuses); STATUS_MAP=Array.isArray(raw)?raw.map(s=>({Id:pick(s,'Id','id'),Name:pick(s,'Name','name')})):[]; dbgData({statusMap:STATUS_MAP}); }
  async function loadOrders(){ const raw=await apiGet(API.list); orders=Array.isArray(raw)?raw.map(normalizeOrderRow):[]; dbgData({sampleListRow:orders[0]??null}); }

  async function selectOrder(id){
    selectedId=Number(id);
    const raw=await apiGet(API.show(selectedId));
    const header=normalizeHeader(raw.header||raw.Header||raw);
    const items =Array.isArray(raw.items||raw.Items)?(raw.items||raw.Items).map(normalizeItem):[];
    orderDetail={header,items}; renderDetail();
    [...document.querySelectorAll('.cell')].forEach(c=>c.classList.toggle('selected', Number(c.dataset.id)===selectedId));
  }

  async function refreshAll(preferId){
    try{
      await loadOrders();
      updateTabCounts();
      renderList();
      const firstId = filteredOrders().find(o=>o&&o.OrderID)?.OrderID;
      if(preferId && orders.some(o=>o.OrderID===preferId)){ await selectOrder(preferId); }
      else if(firstId){ await selectOrder(firstId); }
      else { orderDetail=null; renderDetail(); }
    }catch(e){ toast('Failed to load orders'); }
  }

  // ---------- Wire-up ----------
  document.addEventListener('DOMContentLoaded', async ()=>{
    const saved = localStorage.getItem(AUTO_KEY)==='1'; setAuto(saved);
    await loadStatuses(); await refreshAll();
  });
  document.getElementById('q').addEventListener('input', renderList);

</script>
<script>
  // ---------- Generate Fake Orders ----------
  function addFakeOrders(count = 5) {
    const statuses = ['Placed', 'In Kitchen', 'Ready', 'Delivered', 'Cancelled'];
    const meals = ['Breakfast', 'Lunch', 'Dinner', 'Snack'];
    
    for (let i = 1; i <= count; i++) {
      const order = {
        OrderID: 1000 + i,
        PatientName: `Patient ${i}`,
        RoomNumber: 200 + i,
        MealPeriod: meals[Math.floor(Math.random() * meals.length)],
        Status: statuses[Math.floor(Math.random() * statuses.length)],
        PlacedOn: new Date(Date.now() - Math.random() * 3600 * 1000 * 24).toISOString(),
        MRN: `MRN${1000 + i}`,
        Notes: `Notes for order ${i}`
      };
      orders.push(order);
    }
    
    updateTabCounts();
    renderList();
  }

  // ---------- Example usage ----------
  document.addEventListener('DOMContentLoaded', () => {
    addFakeOrders(10); // add 10 fake orders on load
  });

  // ---------- Example usage ----------
  // Hook the button
  const addFakeOrderBtn = document.getElementById('addFakeBtn');
  addFakeOrderBtn.addEventListener('click', () => {
    addFakeOrders(1); // adds a single new order
  });
</script>
</body>
</html>
