<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<<<<<<< HEAD
  <title>BedsideBistro - Staff Profile</title>
  <link rel="stylesheet" href="global.css" />
  <style>
    /* Center the main profile card content */
    .profile-shell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .profile-shell .patient {
      justify-content: center;
      text-align: center;
      width: 100%;
    }
    .profile-fields {
      margin-top: 14px;
      text-align: center;
    }
    .profile-fields .field-row {
      margin: 4px 0;
      font-size: 0.95rem;
    }
    .profile-fields .label {
      font-weight: 600;
      margin-right: 4px;
    }
  </style>
=======
  <title>BedsideBistro - Nurse Profile</title>
  <link rel="stylesheet" href="global.css" />
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
</head>

<body class="patientdashboard">
<header class="site-header">
  <div class="container site-header__bar" role="navigation" aria-label="Top">
    <a class="site-brand" href="patientview.html">
      <img src="BedsideBistro_Small.svg" alt="BedsideBistro" class="site-brand__img" />
      <span class="site-brand__text">BedsideBistro</span>
    </a>

<<<<<<< HEAD
=======
    <!-- Right side group -->
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
    <div class="site-header__right">
      <a class="site-profile" id="profileLink" href="staffprofile.html" aria-label="Open profile menu">
        <div class="site-avatar" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5.006 5.006 0 0 0 5 5zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5z"/>
          </svg>
        </div>
        <span class="sr-only">Profile</span>
      </a>
    </div>
  </div>
</header>

<main id="content" class="container" style="margin-top:10px">
  <nav class="crumbs" aria-label="Breadcrumb">
    <a href="#">Profile</a> <span class="sep">›</span>
<<<<<<< HEAD
    <span aria-current="page">Staff Profile</span>
  </nav>

  <section class="panel">
    <div class="pad profile-shell">
      <div class="section-head">
        <h2>Your profile</h2>
        <div class="hint">Staff account details</div>
        <button class="ghost edit-btn" id="editInfo" type="button">Edit Information</button>
      </div>

      <!-- Avatar and name -->
      <div class="patient">
        <div class="pfp" id="pfpInitials">-</div>
        <div>
          <strong id="pf_name">-</strong>
          <div class="muted" id="pf_meta">-</div>
        </div>
      </div>

      <!-- Centered fields -->
      <div class="profile-fields">
        <div class="field-row">
          <span class="label">Username:</span>
          <span id="pf_usernameVal">-</span>
        </div>
		<div class="field-row">
		  <span class="label">Password:</span>
		  <span id="pf_passwordVal">-</span>
		</div>

        <div class="field-row">
          <span class="label">First Name:</span>
          <span id="pf_firstVal">-</span>
        </div>
        <div class="field-row">
          <span class="label">Last Name:</span>
          <span id="pf_lastVal">-</span>
        </div>
        <div class="field-row">
          <span class="label">Role:</span>
          <span id="pf_roleVal">-</span>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Edit profile dialog -->
<dialog id="editProfileDialog" class="modal">
  <form id="editProfileForm" class="modal-inner" novalidate>
    <div class="modal-head">
      <h3 id="editProfileFormTitle">Edit Staff Profile</h3>
    </div>

    <div class="field">
      <strong>Username</strong>
      <input class="input" id="f_username" autocomplete="off" required />
    </div>

    <div class="field">
      <strong>Password</strong>
      <input class="input" id="f_password" type="password" autocomplete="off" />
    </div>

=======
    <span aria-current="page">Dietary Limits</span>
  </nav>

  <div class="grid-2">
    <!-- LEFT -->
    <section class="panel">
      <div class="pad">
        <div class="section-head">
          <h2>Your profile</h2>
          <div class="hint">Visit linked diet and allergies</div>
          <button class="ghost edit-btn" id="editInfo">Edit Information</button>
        </div>

        <div class="patient">
          <div class="pfp" id="pfpInitials">-</div>
          <div>
            <strong id="pf_name">-</strong>
            <div class="muted" id="pf_meta">nurse</div>
          </div>
        </div>

        <div class="list" style="margin-top:14px">
          <div class="cardish">
            <h3>Diet orders</h3>
            <div class="chips" id="diet_chips"><span class="chip">-</span></div>
          </div>
          <div class="cardish">
            <h3>Allergies</h3>
            <div class="chips" id="allergy_chips"><span class="chip">-</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="panel" aria-label="Dietary limits">
      <div class="pad">
        <div class="section-head" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div>
            <h2>Dietary totals and limits</h2>
            <div class="hint">Limits come from the assigned diet. Totals sum all non cancelled orders.</div>
          </div>
          <button type="button" class="pill orders mono" id="btnOrders" title="View orders">Orders</button>
        </div>

        <div class="list" id="limits_list">
          <div class="cardish meter" data-key="cal">
            <div class="row">
              <div class="inline">
                <strong>Calories</strong><span class="muted mono" id="today_cal">-</span>
              </div>
              <span class="badge mono" id="badge_cal">-</span>
            </div>
            <div class="bar" id="bar_cal"><span></span></div>
          </div>

          <div class="cardish meter" data-key="na">
            <div class="row">
              <div class="inline">
                <strong>Sodium</strong><span class="muted mono" id="today_na">-</span>
              </div>
              <span class="badge mono" id="badge_na">-</span>
            </div>
            <div class="bar" id="bar_na"><span></span></div>
          </div>

          <div class="cardish meter" data-key="pro">
            <div class="row">
              <div class="inline">
                <strong>Protein</strong><span class="muted mono" id="today_pro">-</span>
              </div>
              <span class="badge mono" id="badge_pro">-</span>
            </div>
            <div class="bar" id="bar_pro"><span></span></div>
          </div>

          <div class="cardish meter" data-key="carb">
            <div class="row">
              <div class="inline">
                <strong>Carbohydrates</strong><span class="muted mono" id="today_carb">-</span>
              </div>
              <span class="badge mono" id="badge_carb">-</span>
            </div>
            <div class="bar" id="bar_carb"><span></span></div>
          </div>

          <div class="cardish meter" data-key="fat">
            <div class="row">
              <div class="inline">
                <strong>Fat</strong><span class="muted mono" id="today_fat">-</span>
              </div>
              <span class="badge mono" id="badge_fat">-</span>
            </div>
            <div class="bar" id="bar_fat"><span></span></div>
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- Orders dialog -->
<dialog id="ordersDlg">
  <div class="dlg-head">
    <strong>Orders</strong>
    <button class="btn" id="btnCloseDlg" aria-label="Close orders">Close</button>
  </div>

  <div class="dlg-body">
    <table class="orders" id="ordersTable">
      <thead>
        <tr><th style="width:120px">Order #</th><th>When</th><th>Meal</th><th>Status</th></tr>
      </thead>
      <tbody id="ordersTbody"><tr><td colspan="4">Loading…</td></tr></tbody>
    </table>

    <!-- In-dialog details - populated on click -->
    <section id="orderDetails" class="order-details" hidden>
      <h4 id="od_title">Order details</h4>
      <div class="kv" id="od_kv"></div>
      <div class="items">
        <strong>Items</strong>
        <ul id="od_items"></ul>
      </div>
    </section>

    <div id="ordersEmpty" class="muted" style="display:none;margin-top:8px">No orders to show.</div>
  </div>

  <div class="dlg-foot">
    <span class="muted mono" id="ordersCount">-</span>
  </div>
</dialog>

<!---------Edit profile Dialog ---------->
<dialog id="editProfileDialog" class="modal">
  <form id="editProfileForm" class="modal-inner" novalidate>
    <div class="modal-head">
      <h3 id="editProfileFormTitle">Edit Profile</h3>
    </div>
    <div class="field">
      <strong>MRN</strong>
      <strong id="f_mrn" class="mono">MRN001 <!--temp replace later--></strong>
    </div>
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
    <div class="field">
      <strong>First Name</strong>
      <input class="input" id="f_firstname" autocomplete="off" required />
    </div>
<<<<<<< HEAD

=======
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
    <div class="field">
      <strong>Last Name</strong>
      <input class="input" id="f_lastname" autocomplete="off" required />
    </div>
<<<<<<< HEAD

    <div class="field">
      <strong>Role</strong>
      <input class="input" id="f_role" autocomplete="off" readonly />
    </div>

=======
    <div class="field" id="password">
      <strong>Password</strong>
      <input class="input" id="f_password" type="password" required />
    </div>
    <div class="field" id="sex">
      <strong>Sex</strong>
      <input class="input" id="f_sex" required />
    </div>
    <div class="field" id="phonenumber">
      <strong>Phone Number</strong>
      <input class="input" id="f_phoneNumber" value="(xxx)-xxx-xxxx" required />
    </div>
    <div class="field" id="email">
      <strong>Email</strong>
      <input class="input" id="f_email" type="email" required/>
    </div>
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
    <div class="modal-footer">
      <button class="ghost" id="ingrCancelBtn" type="button">Cancel</button>
      <button class="btn primary" id="ingrSaveBtn" type="submit">Save</button>
    </div>
  </form>
</dialog>

<script>
  const API = {
    list:   '/api/users',
    create: '/api/users',
    update: id => `/api/users/${id}`,
    delete: id => `/api/users/${id}?softDelete=false`,
    edit:   id => `/api/users/${id}/edit`
  };

  document.addEventListener('DOMContentLoaded', () => {
<<<<<<< HEAD
    const params   = new URLSearchParams(location.search);
    const USERNAME = params.get('userName') || params.get('user'); // accept both
    const API_BASE = params.get('api') || '';
    const api = (p) => (API_BASE ? API_BASE + p : p);

    const $ = (s) => document.querySelector(s);
    const dlg = $('#editProfileDialog');

    let currentUser = null; // holds summary from /api/users
=======
    // Params / API
    const params   = new URLSearchParams(location.search);
    // Accept both ?userName= and ?user=
    const USERNAME = params.get('userName') || params.get('user');
    const API_BASE = params.get('api') || '';
    const api = (p) => (API_BASE ? API_BASE + p : p);

    // DOM utils
    const $  = (s) => document.querySelector(s);
    const nf = (n) => new Intl.NumberFormat().format(+n);
    const pct = (v, lim) => (!lim || lim <= 0) ? 0 : (v / lim * 100);
    const dlg = document.querySelector('#editProfileDialog');
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02

    function setText(sel, txt) {
      const el = $(sel);
      if (el) el.textContent = txt;
    }

<<<<<<< HEAD
=======
    function setBar(sel, p) {
      const el = $(sel);
      if (!el) return;
      const v = Math.max(0, Math.min(120, p || 0));
      el.style.setProperty('--val', `${v}%`);
      el.classList.remove('ok', 'warn', 'alert');
      if (v > 100) el.classList.add('alert');
      else if (v >= 90) el.classList.add('warn');
      else el.classList.add('ok');
    }

>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
    function setInitials(name) {
      const ini = (name || '')
        .split(' ')
        .map(x => x[0] || '')
        .join('')
        .slice(0, 2)
        .toUpperCase();
      const p = $('#pfpInitials');
      if (p) p.textContent = ini || 'RN';
    }

<<<<<<< HEAD
=======
    // Nav helpers (carry user/api onto links)
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
    function withParams(href, extra = {}) {
      try {
        const base = (href || '').trim() || '/';
        const url = base.startsWith('http')
          ? new URL(base)
          : new URL(base, location.origin);
        for (const [k, v] of Object.entries(extra)) {
          if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
        }
        return url.toString();
      } catch {
        return href;
      }
    }

    function carryTo(selector, fallbackHref, extras = {}) {
      const el = document.querySelector(selector);
      if (!el) return;
      const original = el.getAttribute('href') || fallbackHref || '';
      if (!original) return;
<<<<<<< HEAD
      el.setAttribute('href', withParams(original, { user: USERNAME, api: API_BASE, ...extras }));
    }

=======
      // fixed spread here
      el.setAttribute('href', withParams(original, { user: USERNAME, api: API_BASE, ...extras }));
    }

    // wire profile link to carry user/api
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
    carryTo('#profileLink', 'staffprofile.html');

    const profileLink = $('#profileLink');
    if (profileLink) {
      profileLink.href = withParams('staffprofile.html', { user: USERNAME, api: API_BASE });
    }

<<<<<<< HEAD
    if (!USERNAME) {
      const c = $('#content');
      if (c) {
        c.innerHTML = `<div class="cardish">Missing username. Try <code>?user=nurse</code> or <code>?userName=nurse</code>.</div>`;
=======
    // Orders dialog wiring
    const ordersBtn = $('#btnOrders');
    const ordersDlg = $('#ordersDlg');
    const closeDlg  = $('#btnCloseDlg');

    async function populateOrdersTable() {
      // keep whatever logic you add later; left blank on purpose
    }

    if (ordersBtn && ordersDlg) {
      ordersBtn.addEventListener('click', (ev) => {
        const r = ev.currentTarget.getBoundingClientRect();
        ordersDlg.style.top = `${Math.max(12, r.bottom + 12)}px`;
        if (typeof ordersDlg.showModal === 'function') ordersDlg.showModal();
        else ordersDlg.setAttribute('open', '');
        populateOrdersTable().catch(() => {});
      });
    }
    if (closeDlg && ordersDlg) {
      closeDlg.addEventListener('click', () => {
        if (typeof ordersDlg.close === 'function') ordersDlg.close();
        else ordersDlg.removeAttribute('open');
      });
    }

    // Guard for username
    if (!USERNAME) {
      const c = $('#content');
      if (c) {
        c.innerHTML =
          `<div class="cardish">Missing username. Try <code>?user=nurse</code> or <code>?userName=nurse</code>.</div>`;
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
      }
      return;
    }

<<<<<<< HEAD
    // Load basic staff info
    (async function loadBasics() {
      const setBasics = (fullName, username, role) => {
        setText('#pf_name', fullName || '-');
        setText('#pf_meta', username || '-');
        setInitials(fullName);
        setText('#pf_usernameVal', username || '-');
        const parts = (fullName || '').trim().split(' ');
        const first = parts[0] || '';
        const last  = parts.slice(1).join(' ');
        setText('#pf_firstVal', first || '-');
        setText('#pf_lastVal', last || '-');
        setText('#pf_roleVal', role || '-');
=======
    // Basic profile - load staff user and show full name
    (async function loadBasics() {
      const setBasics = (name, username) => {
        setText('#pf_name', name || '-');
        setText('#pf_meta', username || '-');
        setInitials(name);
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
      };

      try {
        const r = await fetch(api('/api/users'));
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const users = await r.json();

        const u = Array.isArray(users)
          ? users.find(x => (x.userName || x.UserName) === USERNAME)
          : null;

        if (!u) {
<<<<<<< HEAD
          setBasics('-', USERNAME, '-');
          return;
        }

currentUser = u;

// Fetch full user record to get the real password
try {
    const r2 = await fetch(api(`/api/users/${u.id || u.Id}/edit`));
    const full = await r2.json();

    u.Password = full.password || full.Password || '';
} catch {
    u.Password = '';
}

const displayName = (u.displayName || u.DisplayName || '').trim();
const fullName = displayName || USERNAME || '';
const usernameLabel = u.userName || u.UserName || USERNAME || '';
const roleLabel = u.role || u.Role || '';

setBasics(fullName, usernameLabel, roleLabel);

// Also show password on profile
setText('#pf_passwordVal', u.Password ? u.Password : '(none)');

      } catch (err) {
        console.error(err);
        setBasics('-', USERNAME || '-', '-');
      }
    })();

    // Edit dialog
    const editBtn = $('#editInfo');
    if (editBtn && dlg) {
      editBtn.addEventListener('click', () => {
        if (currentUser) {
          const displayName = (currentUser.displayName || currentUser.DisplayName || '').trim();
          const parts = displayName.split(' ');
          const first = parts[0] || '';
          const last  = parts.slice(1).join(' ');

$('#f_username').value  = currentUser.userName || currentUser.UserName || '';
$('#f_firstname').value = first;
$('#f_lastname').value  = last;
$('#f_role').value      = currentUser.role || currentUser.Role || '';
$('#f_password').value  = currentUser.Password || '';

        }
        dlg.showModal();
      });
    }

    const cancelBtn = $('#ingrCancelBtn');
    if (cancelBtn && dlg) {
      cancelBtn.onclick = () => dlg.close();
    }

    // For now the save just closes; you can wire /api/users/{id} later
    const saveBtn = $('#ingrSaveBtn');
    if (saveBtn && dlg) {
      saveBtn.onclick = (ev) => {
        ev.preventDefault();
=======
          setBasics('-', USERNAME || '-');
          return;
        }

        const displayName = (u.displayName || u.DisplayName || '').trim();
        const fullName = displayName || USERNAME || '';
        const usernameLabel = u.userName || u.UserName || USERNAME || '';

        setBasics(fullName, usernameLabel);
      } catch (err) {
        console.error(err);
        setBasics('-', USERNAME || '-');
      }
    })();

    // Toggleable order details (single-open state)
    let openOrderID = null;
    let detailsLoadToken = 0;

    function setOrderBtnExpanded(oid, expanded) {
      const btn = document.querySelector(`button[data-oid="${oid}"]`);
      if (btn) btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    }

    function markSelectedRow(orderID) {
      document
        .querySelectorAll('#ordersTable tbody tr')
        .forEach(tr => tr.classList.remove('is-selected'));
      const btn = document.querySelector(`button[data-oid="${orderID}"]`);
      btn?.closest('tr')?.classList.add('is-selected');
    }

    async function showOrderDetails(orderID) {
      const detailsBox = $('#orderDetails');
      const kv         = $('#od_kv');
      const itemsUL    = $('#od_items');

      setText('#od_title', `Order #${orderID}`);
      if (kv) kv.innerHTML = '';
      if (itemsUL) itemsUL.innerHTML = '<li class="muted">Loading…</li>';
      if (detailsBox) detailsBox.hidden = false;

      if (openOrderID && openOrderID !== orderID) setOrderBtnExpanded(openOrderID, false);
      openOrderID = orderID;
      setOrderBtnExpanded(orderID, true);
      markSelectedRow(orderID);

      const myToken = ++detailsLoadToken;

      try {
        const r = await fetch(api(`/api/orders/${orderID}`));
        const data = await r.json();

        if (myToken !== detailsLoadToken) return;

        const items = data.items || data.Items || [];
        if (!itemsUL) return;

        if (!items.length) {
          itemsUL.innerHTML = `<li class="muted">No items</li>`;
        } else {
          itemsUL.innerHTML = '';
          items.forEach(i => {
            const li = document.createElement('li');
            li.textContent =
              `${i.itemName || i.ItemName || 'Item'} x ${i.qty ?? i.Qty ?? 1}`;
            itemsUL.appendChild(li);
          });
        }
      } catch {
        if (itemsUL) itemsUL.innerHTML = `<li class="muted">Could not load items</li>`;
      }
    }

    function hideOrderDetails() {
      const detailsBox = $('#orderDetails');
      if (detailsBox) detailsBox.hidden = true;
      if (openOrderID) setOrderBtnExpanded(openOrderID, false);
      document
        .querySelectorAll('#ordersTable tbody tr')
        .forEach(tr => tr.classList.remove('is-selected'));
      openOrderID = null;
    }

    function toggleOrderDetails(orderID) {
      if (openOrderID === orderID) {
        hideOrderDetails();
      } else {
        showOrderDetails(orderID);
      }
    }

    const ordersDlgEl = $('#ordersDlg');
    if (ordersDlgEl) {
      ordersDlgEl.addEventListener('close', hideOrderDetails);
      ordersDlgEl.addEventListener('cancel', hideOrderDetails);
    }

    // Edit Profile Dialog inputs
    const firstNameInput = document.querySelector('#f_firstname');
    const lastNameInput = document.querySelector('#f_lastname');
    const passwordInput = document.querySelector('#f_password');
    const sexInput = document.querySelector('#f_sex');
    const phoneNumberInput = document.querySelector('#f_phoneNumber');
    const emailInput = document.querySelector('#f_email');

    // Open edit dialog
    const editBtn = document.querySelector('#editInfo');
    if (editBtn && dlg) {
      editBtn.addEventListener('click', () => dlg.showModal());
    }

    // Cancel should close dialog (fixed)
    const cancelBtn = document.querySelector('#ingrCancelBtn');
    if (cancelBtn && dlg) {
      cancelBtn.onclick = () => {
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
        dlg.close();
      };
    }
  });
</script>

<<<<<<< HEAD
<!-- API Debugger (unchanged) -->
=======
<!-- API Debugger -->
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
<style>
  #apiDebugToggle{position:fixed;right:14px;bottom:14px;z-index:9999;border:1px solid #cfe5db;background:#fff;padding:8px 10px;border-radius:999px;font:600 12px system-ui;box-shadow:0 6px 18px rgba(0,0,0,.08);cursor:pointer}
  #apiDebugPanel{position:fixed;right:14px;bottom:60px;z-index:9999;width:min(680px,92vw);max-height:60vh;display:none;background:#fff;border:1px solid #cfe5db;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12);overflow:hidden}
  #apiDebugPanel header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;background:#e9f5f0;border-bottom:1px solid #cfe5db}
  #apiDebugPanel header strong{font:700 13px/1.2 system-ui}
  #apiDebugPanel header .btns{display:flex;gap:6px}
  #apiDebugPanel header button{border:1px solid #cfe5db;background:#fff;border-radius:8px;padding:6px 8px;font:600 12px system-ui;cursor:pointer}
  #apiDebugPanel main{display:grid;grid-template-columns:1.2fr .8fr;gap:0;border-top:0;min-height:260px}
  #apiDebugList{border-right:1px solid #eef4f1;overflow:auto}
  #apiDebugList .row{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid #f1f5f3;font:12px system-ui}
  #apiDebugList .row .m{font-weight:700}
  #apiDebugList .row .u{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:44vw}
  #apiDebugList .row .s.ok{color:#2f7d5f}
  #apiDebugList .row .s.bad{color:#b83b3b}
  #apiDebugList .row .t{color:#6b7671}
  #apiDebugDetail{padding:8px;overflow:auto}
  #apiDebugDetail pre{margin:0;font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap;word-break:break-word;background:#fbfefd;border:1px solid #eef4f1;border-radius:10px;padding:8px}
  #toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);z-index:99999;background:#1b1f1e;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s}
</style>

<div id="apiDebugPanel" role="region" aria-label="API Debugger">
  <header>
    <strong>API Debugger</strong>
    <div class="btns">
<<<<<<< HEAD
      <button id="apiCopyBtn" type="button" title="Copy latest entry">Copy</button>
      <button id="apiClearBtn" type="button" title="Clear log">Clear</button>
      <button id="apiCloseBtn" type="button" title="Close">Close</button>
=======
      <button id="apiCopyBtn" title="Copy latest entry">Copy</button>
      <button id="apiClearBtn" title="Clear log">Clear</button>
      <button id="apiCloseBtn" title="Close">Close</button>
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
    </div>
  </header>
  <main>
    <div id="apiDebugList" aria-label="Requests list"></div>
    <div id="apiDebugDetail" aria-label="Selected request detail"><pre>Select a row…</pre></div>
  </main>
</div>
<<<<<<< HEAD
<button id="apiDebugToggle" type="button" aria-expanded="false" aria-controls="apiDebugPanel">Debug</button>
=======
<button id="apiDebugToggle" aria-expanded="false" aria-controls="apiDebugPanel">Debug</button>
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
<div id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  window.UPLOAD_URL = window.UPLOAD_URL || '/api/uploads';
  const $ = sel => document.querySelector(sel);

<<<<<<< HEAD
=======
  // Toast
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
  window.showAlert = (msg) => {
    const el = $('#toast');
    el.textContent = msg || 'Notice';
    el.style.opacity = '1';
    clearTimeout(el._t);
    el._t = setTimeout(() => { el.style.opacity = '0'; }, 1800);
  };

<<<<<<< HEAD
  const log = [];
  let selectedIndex = -1;

=======
  // State
  const log = [];
  let selectedIndex = -1;

  // UI refs
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
  const panel = $('#apiDebugPanel');
  const list  = $('#apiDebugList');
  const detail= $('#apiDebugDetail');
  const toggle= $('#apiDebugToggle');

  function renderList() {
    list.innerHTML = '';
    log.slice().reverse().forEach((e, iRev) => {
      const i = log.length - 1 - iRev;
      const row = document.createElement('div');
      row.className = 'row';
      const sCls = e.ok ? 'ok' : 'bad';
      row.innerHTML = `
        <span class="m">${e.method}</span>
        <span class="u" title="${e.url}">${e.url}</span>
        <span class="s ${sCls}">${e.status}</span>
        <span class="t">${e.ms} ms</span>
      `;
      row.addEventListener('click', () => {
        selectedIndex = i;
        renderDetail();
      });
      list.appendChild(row);
    });
  }

  function formatHeaders(h) {
    if (!h) return '(none)';
    const lines = [];
    for (const k in h) lines.push(k + ': ' + h[k]);
    return lines.length ? lines.join('\n') : '(none)';
  }

  function prettify(x) {
    if (x == null || x === '') return '(empty)';
    if (typeof x === 'string') {
      try { return JSON.stringify(JSON.parse(x), null, 2); }
      catch { return x; }
    }
    try { return JSON.stringify(x, null, 2); }
    catch { return String(x); }
  }

  function renderDetail() {
    const e = log[selectedIndex];
    if (!e) {
      detail.innerHTML = '<pre>Select a row…</pre>';
      return;
    }
    const reqPretty = prettify(e.reqBody);
    const resPretty = prettify(e.resBody);
    detail.innerHTML = `<pre>${[
      `# ${e.method} ${e.url}`,
      `Status: ${e.status}  -  Time: ${e.ms} ms`,
      e.error ? `Error: ${e.error}` : '',
      '',
      '--- Request Headers ---',
      formatHeaders(e.reqHeaders),
      '',
      '--- Request Body ---',
      reqPretty,
      '',
      '--- Response Headers ---',
      formatHeaders(e.resHeaders),
      '',
      '--- Response Body ---',
      resPretty
    ].filter(Boolean).join('\n')}</pre>`;
  }

<<<<<<< HEAD
=======
  // Public helper used by existing code
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
  window.logLine = (entry) => {
    log.push({
      t: Date.now(),
      method: entry.method || 'GET',
      url: entry.url || '',
      status: entry.status ?? '',
      ok: !!entry.ok,
      ms: entry.ms ?? '',
      reqHeaders: entry.reqHeaders,
      reqBody: entry.reqBody,
      resHeaders: entry.resHeaders,
      resBody: entry.resBody,
      error: entry.error
    });
    renderList();
    if (selectedIndex < 0) {
      selectedIndex = log.length - 1;
      renderDetail();
    }
  };

<<<<<<< HEAD
=======
  // Patch fetch so it logs
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
  const origFetch = window.fetch.bind(window);
  window.fetch = async function (url, options = {}) {
    const started = performance.now();
    let reqBody = '';
    try {
      if (options.body instanceof FormData) reqBody = '[FormData]';
      else if (options.body instanceof Blob) reqBody = '[Blob]';
      else if (typeof options.body === 'string') reqBody = options.body;
      else if (options.body) reqBody = JSON.stringify(options.body);
    } catch {}

    let reqHeaders = {};
    try {
      if (options.headers) {
        if (options.headers.forEach) {
          options.headers.forEach((v, k) => { reqHeaders[k] = v; });
        } else {
<<<<<<< HEAD
=======
          // fixed spread here
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
          reqHeaders = { ...options.headers };
        }
      }
    } catch {}

    try {
      const res = await origFetch(url, options);
      const elapsed = Math.round(performance.now() - started);

      let text = '';
      try { text = await res.clone().text(); } catch {}
      const resHeaders = {};
      try { res.headers.forEach((v, k) => { resHeaders[k] = v; }); } catch {}

      window.logLine({
        t: Date.now(),
        url: typeof url === 'string' ? url : (url && url.url) || String(url),
        method: (options.method || 'GET').toUpperCase(),
        status: res.status,
        ok: res.ok,
        ms: elapsed,
        reqHeaders,
        reqBody,
        resHeaders,
        resBody: text
      });
      return res;
    } catch (err) {
      const elapsed = Math.round(performance.now() - started);
      window.logLine({
        t: Date.now(),
        url: typeof url === 'string' ? url : (url && url.url) || String(url),
        method: (options.method || 'GET').toUpperCase(),
        status: 'ERR',
        ok: false,
        ms: elapsed,
        reqHeaders,
        reqBody,
        resHeaders: null,
        resBody: '',
        error: String((err && err.message) || err)
      });
      throw err;
    }
  };

<<<<<<< HEAD
=======
  // Wire controls
>>>>>>> fe4abaa2970b635d094e069407b34bc6e7eaeb02
  toggle.addEventListener('click', () => {
    const open = panel.style.display !== 'none';
    if (open) {
      panel.style.display = 'none';
      toggle.setAttribute('aria-expanded', 'false');
    } else {
      panel.style.display = 'block';
      toggle.setAttribute('aria-expanded', 'true');
    }
  });

  $('#apiCloseBtn').addEventListener('click', () => {
    panel.style.display = 'none';
    toggle.setAttribute('aria-expanded', 'false');
  });

  $('#apiClearBtn').addEventListener('click', () => {
    log.length = 0;
    selectedIndex = -1;
    renderList();
    renderDetail();
  });

  $('#apiCopyBtn').addEventListener('click', async () => {
    const e = log[selectedIndex];
    if (!e) {
      showAlert('Nothing selected');
      return;
    }
    const payload = JSON.stringify(e, null, 2);
    try {
      await navigator.clipboard.writeText(payload);
      showAlert('Copied');
    } catch {
      showAlert('Copy failed');
    }
  });
})();
</script>

</body>
</html>
