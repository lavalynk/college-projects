package Week15FinalProject;

import org.w3c.dom.*;
import org.xml.sax.SAXParseException;

import javax.xml.parsers.*;
import javax.xml.transform.*;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import java.io.*;
import java.util.logging.*;

/**
 * ModifyCustomers.java
 * Reads customers.xml, appends new fields to each customer, and saves to customer_modified.xml.
 * New fields added: phone, contactName, and email.
 * 
 * Step5 Enhancement: Includes logging using java.util.logging.
 * 
 * Author: Keith Brock
 * Version: 1.0
 */
public class ModifyCustomers {

    // Step5 Enhancement - Logger setup
    private static final Logger logger = Logger.getLogger(ModifyCustomers.class.getName());

    /**
     * Entry point for modifying the XML and displaying the new file.
     */
    public static void main(String[] args) {
        setupLogger();

        try {
            File inputFile = new File("customers.xml");

            // Create the file if it doesn't exist
            if (!inputFile.exists()) {
                logger.warning("customers.xml not found. Creating default file...");
                ViewCustomers.main(null);
            }

            // Parse existing XML
            DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
            DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
            Document doc = dBuilder.parse(inputFile);
            doc.getDocumentElement().normalize();

            NodeList customerList = doc.getElementsByTagName("Customer");

            for (int i = 0; i < customerList.getLength(); i++) {
                Node customerNode = customerList.item(i);

                if (customerNode.getNodeType() == Node.ELEMENT_NODE) {
                    Element customer = (Element) customerNode;
                    customer.appendChild(createElement(doc, "phone", "555-000-" + (1000 + i)));
                    customer.appendChild(createElement(doc, "contactName", "Contact Person " + (i + 1)));
                    customer.appendChild(createElement(doc, "email", "customer" + i + "@example.com"));
                }
            }

            // Write updated document to a new file
            TransformerFactory transformerFactory = TransformerFactory.newInstance();
            Transformer transformer = transformerFactory.newTransformer();
            transformer.setOutputProperty(OutputKeys.INDENT, "yes");

            DOMSource source = new DOMSource(doc);
            StreamResult result = new StreamResult(new File("customer_modified.xml"));
            transformer.transform(source, result);

            logger.info("customer_modified.xml created successfully.");
            System.out.println("Modified XML has been saved as customer_modified.xml\n");

            printModifiedXML("customer_modified.xml");

        } catch (SAXParseException parseError) {
            logger.severe("Malformed XML - " + parseError.getMessage());
            System.out.println("ERROR: customers.xml is malformed or incomplete.");
        } catch (Exception ex) {
            logger.severe("Unexpected error: " + ex.getMessage());
            System.out.println("An error occurred: " + ex.getMessage());
        }
    }

    /**
     * Step5 Enhancement - Logger configuration.
     */
    private static void setupLogger() {
        try {
            LogManager.getLogManager().reset();
            FileHandler handler = new FileHandler("log_customers.xml");
            handler.setFormatter(new XMLFormatter());
            logger.addHandler(handler);
            logger.setLevel(Level.ALL);
        } catch (IOException ex) {
            System.err.println("Logging setup failed: " + ex.getMessage());
        }
    }

    /**
     * Creates a new XML element with a given tag name and value.
     * 
     * @param doc  the XML document
     * @param tag  the tag name
     * @param value the text content
     * @return the new element
     */
    private static Element createElement(Document doc, String tag, String value) {
        Element element = doc.createElement(tag);
        element.appendChild(doc.createTextNode(value));
        return element;
    }

    /**
     * Prints out the contents of the given XML file.
     * 
     * @param filePath the path to the XML file
     */
    private static void printModifiedXML(String filePath) {
        try (BufferedReader reader = new BufferedReader(new FileReader(filePath))) {
            String line;
            System.out.println("--- Modified XML Content ---");
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
        } catch (IOException ex) {
            logger.warning("Could not print modified XML: " + ex.getMessage());
        }
    }
}
